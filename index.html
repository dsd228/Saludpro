<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaludPro - Asistente Clínico Inteligente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1a73e8;
            --primary-blue-darker: #0d47a1;
            --primary-blue-lighter: #e8f0fe;
            --success-green: #34a853;
            --warning-yellow: #f9ab00;
            --alert-red: #ea4335;
            --accent-teal: #00897b;
            --accent-purple: #7b1fa2;
            --background-light: #f8f9fa;
            --background-dark: #1e1e1e;
            --text-dark: #202124;
            --text-light: #ffffff;
            --text-muted: #5f6368;
            --border-radius: 8px;
            --shadow-small: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-medium: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-large: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            --transition-fast: all 0.2s ease-in-out;
            --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --z-modal: 1000;
            --z-header: 900;
            --status-success: #34a853;
            --status-warning: #f9ab00;
            --status-error: #ea4335;
            --status-info: #1a73e8;
        }
        
        .theme-dark {
            --background-light: #1e1e1e;
            --background-dark: #121212;
            --text-dark: #e0e0e0;
            --text-muted: #b0b0b0;
            --primary-blue-lighter: #1a237e;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            transition: var(--transition-slow);
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--primary-blue);
            margin-top: 0;
            font-weight: 500;
        }
        
        a {
            color: var(--primary-blue);
            text-decoration: none;
            transition: var(--transition-fast);
        }
        
        a:hover {
            color: var(--primary-blue-darker);
        }
        
        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
            background-color: white;
            box-shadow: var(--shadow-medium);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            z-index: var(--z-header);
            position: relative;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .app-icon {
            font-size: 2.5em;
            color: var(--primary-blue);
            margin-right: 10px;
        }
        
        header h1 {
            margin: 0;
            font-size: 2em;
            color: var(--primary-blue);
        }
        
        .subtitle {
            font-size: 1.1em;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition-fast);
        }
        
        .theme-toggle:hover {
            background-color: var(--background-light);
            color: var(--primary-blue);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-blue);
            transition: var(--transition-fast);
        }
        
        .avatar:hover {
            transform: scale(1.05);
        }
        
        .user-profile span {
            font-weight: 500;
            color: var(--text-dark);
        }
        
        /* Navigation */
        nav {
            background-color: white;
            padding: 10px 30px;
            box-shadow: var(--shadow-medium);
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: var(--z-header);
        }
        
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
        }
        
        nav ul li {
            margin: 0 15px;
        }
        
        nav ul li a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            color: var(--text-muted);
            font-weight: 500;
            transition: var(--transition-fast);
            background-color: transparent;
            position: relative;
            overflow: hidden;
        }
        
        nav ul li a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-blue);
            transition: var(--transition-fast);
        }
        
        nav ul li a:hover,
        nav ul li a.active {
            color: var(--primary-blue);
            background-color: var(--primary-blue-lighter);
        }
        
        nav ul li a:hover::after,
        nav ul li a.active::after {
            width: 100%;
        }
        
        nav ul li a .material-symbols-outlined {
            margin-right: 8px;
            font-size: 1.3em;
        }
        
        /* Main Content Area */
        #app-content {
            flex-grow: 1;
            padding: 0 30px 30px;
            position: relative;
        }
        
        .page {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-top: 20px;
            animation: fadeIn 0.5s ease-out;
            min-height: 500px;
        }
        
        .page.active {
            display: block;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        /* Consultorio Virtual */
        .consultorio-container {
            background-color: var(--background-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-box input {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1em;
            transition: var(--transition-fast);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .search-box button {
            padding: 12px 20px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-fast);
        }
        
        .search-box button:hover {
            background-color: var(--primary-blue-darker);
        }
        
        .suggestions-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            margin-top: 5px;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: var(--transition-fast);
        }
        
        .suggestion-item:hover {
            background-color: var(--primary-blue-lighter);
            color: var(--primary-blue);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-highlight {
            font-weight: 500;
            color: var(--primary-blue);
        }
        
        /* Resultados de búsqueda */
        .search-results {
            margin-top: 20px;
        }
        
        .result-item {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
            border: 1px solid #eee;
            transition: var(--transition-slow);
        }
        
        .result-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-title {
            margin: 0;
            color: var(--primary-blue);
            font-size: 1.3em;
        }
        
        .result-type {
            background-color: var(--primary-blue-lighter);
            color: var(--primary-blue);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .result-content {
            margin-bottom: 15px;
        }
        
        .result-content h4 {
            color: var(--primary-blue);
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .result-content p {
            margin: 5px 0;
            line-height: 1.6;
        }
        
        .result-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .result-content li {
            margin-bottom: 5px;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .result-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-fast);
            font-size: 0.9em;
        }
        
        .result-actions button .material-symbols-outlined {
            margin-right: 5px;
            font-size: 1.1em;
        }
        
        .btn-detail {
            background-color: var(--primary-blue);
            color: white;
        }
        
        .btn-detail:hover {
            background-color: var(--primary-blue-darker);
        }
        
        .btn-protocol {
            background-color: var(--accent-teal);
            color: white;
        }
        
        .btn-protocol:hover {
            background-color: #00695c;
        }
        
        .btn-images {
            background-color: var(--accent-purple);
            color: white;
        }
        
        .btn-images:hover {
            background-color: #6a1b9a;
        }
        
        .btn-expert {
            background-color: var(--warning-yellow);
            color: var(--text-dark);
        }
        
        .btn-expert:hover {
            background-color: #e59e00;
        }
        
        /* Imágenes educativas */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            height: 120px;
        }
        
        .image-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }
        
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.8em;
            text-align: center;
        }
        
        /* Lightbox para imágenes */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: var(--z-modal);
            opacity: 0;
            animation: fadeInOverlay 0.3s ease-out forwards;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        
        .lightbox-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: var(--border-radius);
        }
        
        .lightbox-caption {
            position: absolute;
            bottom: -30px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            font-size: 0.9em;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2em;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .lightbox-close:hover {
            background: rgba(0,0,0,0.8);
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
        }
        
        .lightbox-nav button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .lightbox-nav button:hover {
            background: rgba(0,0,0,0.8);
        }
        
        /* Dashboard Specific Styles */
        .patient-selector {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--background-light);
            border-radius: var(--border-radius);
            border: 1px solid #e0e0e0;
            box-shadow: var(--shadow-small);
        }
        
        .patient-selector label {
            margin-right: 15px;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        #active-patient {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            min-width: 200px;
            font-size: 1em;
            transition: var(--transition-fast);
        }
        
        #active-patient:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .alert-card {
            display: flex;
            align-items: center;
            background-color: var(--warning-yellow);
            color: var(--text-dark);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
            border-left: 5px solid var(--alert-red);
            position: relative;
            overflow: hidden;
        }
        
        .alert-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .alert-icon {
            color: var(--alert-red);
            margin-right: 15px;
            font-size: 1.5em;
        }
        
        .indicator-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .indicator-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            text-align: center;
            transition: var(--transition-slow);
            position: relative;
            overflow: hidden;
            border: 1px solid #eee;
        }
        
        .indicator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-teal));
        }
        
        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }
        
        .indicator-card .material-symbols-outlined {
            font-size: 2.5em;
            margin-bottom: 10px;
            transition: var(--transition-fast);
        }
        
        .indicator-card .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .indicator-card h3 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
            color: var(--text-muted);
        }
        
        .indicator-card p {
            font-size: 1.5em;
            font-weight: 500;
            margin: 0;
            color: var(--text-dark);
        }
        
        .chart-container {
            position: relative;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-container canvas {
            max-width: 100%;
            height: 300px !important;
        }
        
        .chart-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .chart-controls select,
        .chart-controls button {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1em;
        }
        
        .chart-controls button {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .chart-controls button:hover {
            background-color: var(--primary-blue-darker);
        }
        
        /* Pacientes Page Styles */
        .search-filter-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--background-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-small);
        }
        
        #patient-search, #specialty-filter {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            flex-grow: 1;
            font-size: 1em;
            transition: var(--transition-fast);
        }
        
        #patient-search:focus, #specialty-filter:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        #specialty-filter {
            flex-grow: 0;
        }
        
        .patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .patient-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            transition: var(--transition-slow);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
        }
        
        .patient-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-teal));
        }
        
        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }
        
        .patient-card h3 {
            margin-top: 0;
            color: var(--primary-blue);
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .patient-card p {
            margin-bottom: 5px;
            font-size: 0.95em;
            color: var(--text-dark);
        }
        
        .patient-card strong {
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .patient-risk {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-top: 5px;
        }
        
        .risk-high {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--alert-red);
            border: 1px solid rgba(234, 67, 53, 0.3);
        }
        
        .risk-moderate {
            background-color: rgba(249, 171, 0, 0.1);
            color: var(--warning-yellow);
            border: 1px solid rgba(249, 171, 0, 0.3);
        }
        
        .risk-low {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--success-green);
            border: 1px solid rgba(52, 168, 83, 0.3);
        }
        
        .btn-view-history {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            margin-top: 15px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--primary-blue);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .btn-view-history::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        .btn-view-history:hover::before {
            left: 100%;
        }
        
        .btn-view-history .material-symbols-outlined {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .btn-view-history:hover {
            background-color: var(--primary-blue-darker);
            transform: translateY(-2px);
        }
        
        /* Botones generales */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-blue-darker);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--primary-blue-lighter);
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }
        
        .btn-secondary:hover {
            background-color: rgba(26, 115, 232, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-green);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2e8b4d;
        }
        
        .btn-warning {
            background-color: var(--warning-yellow);
            color: var(--text-dark);
        }
        
        .btn-warning:hover {
            background-color: #e59e00;
        }
        
        .btn-danger {
            background-color: var(--alert-red);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        /* Formularios */
        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex-grow: 1;
            min-width: 200px;
        }
        
        .form-group.flex-grow {
            flex-grow: 2;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1em;
            transition: var(--transition-fast);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-group input[type="radio"] {
            margin-right: 5px;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: var(--z-modal);
            opacity: 0;
            animation: fadeInOverlay 0.3s ease-out forwards;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.4s ease-out forwards;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-dark);
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }
        
        .modal-header h2 .material-symbols-outlined {
            margin-right: 10px;
            color: var(--primary-blue);
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: #888;
            cursor: pointer;
            padding: 0 10px;
            line-height: 1;
            transition: var(--transition-fast);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close-btn:hover {
            color: var(--alert-red);
            background-color: rgba(234, 67, 53, 0.1);
        }
        
        /* Tabs dentro del modal */
        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
        }
        
        .modal-tab {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-muted);
            transition: var(--transition-fast);
            position: relative;
        }
        
        .modal-tab.active {
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-blue);
        }
        
        .modal-tab:hover {
            color: var(--primary-blue);
            background-color: rgba(26, 115, 232, 0.05);
        }
        
        .modal-tab-content {
            display: none;
        }
        
        .modal-tab-content.active {
            display: block;
        }
        
        /* Estilos para tablas en modales */
        .modal-tab-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: var(--shadow-small);
        }
        
        .modal-tab-content th,
        .modal-tab-content td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            transition: var(--transition-fast);
        }
        
        .modal-tab-content th {
            background-color: var(--background-light);
            color: var(--text-dark);
            font-weight: 500;
            position: sticky;
            top: 0;
            background: inherit;
            z-index: 1;
        }
        
        .modal-tab-content tr:hover {
            background-color: #f8f9fa;
        }
        
        .modal-tab-content tr:hover td:first-child {
            color: var(--primary-blue);
            font-weight: 500;
        }
        
        /* Recursos de Educación Médica */
        .resource-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .resource-card {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            border: 1px solid #eee;
            transition: var(--transition-slow);
        }
        
        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-blue);
        }
        
        .resource-card h3 {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .resource-card ul {
            list-style: none;
            padding: 0;
        }
        
        .resource-card ul li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .resource-card ul li::before {
            content: '→';
            position: absolute;
            left: 0;
            color: var(--primary-blue);
        }
        
        .resource-card ul li a {
            color: var(--text-dark);
            transition: var(--transition-fast);
        }
        
        .resource-card ul li a:hover {
            color: var(--primary-blue);
            text-decoration: underline;
        }
        
        /* Calculadoras Médicas */
        .calculator-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--background-light);
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        .calculator-selector label {
            margin-right: 10px;
            font-weight: 500;
        }
        
        .calculator-selector select {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 1em;
        }
        
        .calculator-form {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            margin-bottom: 20px;
            border: 1px solid #eee;
        }
        
        .calculator-form h3 {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .child-pugh-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: var(--shadow-small);
        }
        
        .child-pugh-table th,
        .child-pugh-table td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .child-pugh-table th {
            background-color: var(--primary-blue);
            color: white;
            font-weight: 500;
        }
        
        .child-pugh-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        /* Resultados */
        .result-display {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--primary-blue-lighter);
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-blue);
        }
        
        .result-display h4 {
            margin: 0 0 10px 0;
            color: var(--primary-blue);
        }
        
        .result-display p {
            margin: 5px 0;
            color: var(--text-dark);
        }
        
        .result-display strong {
            color: var(--text-dark);
            font-weight: 600;
        }
        
        /* Interacciones Medicamentosas */
        .interactions-warning {
            background-color: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .interactions-warning .material-symbols-outlined {
            color: var(--warning-yellow);
            margin-right: 10px;
            font-size: 1.5em;
            vertical-align: middle;
        }
        
        .interactions-warning strong {
            color: var(--text-dark);
        }
        
        .interactions-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .interactions-list li {
            margin-bottom: 5px;
        }
        
        .severity-fatal {
            color: var(--alert-red);
            font-weight: 600;
        }
        
        .severity-moderate {
            color: var(--warning-yellow);
        }
        
        .severity-leve {
            color: var(--text-dark);
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 15px;
                gap: 10px;
            }
            
            .subtitle {
                display: none;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            nav ul li {
                margin: 5px 10px;
            }
            
            #app-content {
                padding: 0 15px 15px;
            }
            
            .patient-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .patient-selector label {
                margin-bottom: 0;
            }
            
            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            #patient-search, #specialty-filter {
                width: 100%;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .chart-controls {
                flex-direction: column;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .result-actions {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5em;
            }
            
            .user-profile span {
                font-size: 0.9em;
            }
            
            nav ul li a {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            
            .indicator-cards {
                grid-template-columns: 1fr;
            }
            
            .alert-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .alert-icon {
                margin-bottom: 10px;
            }
            
            .patient-card {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.3em;
            }
            
            .modal-close-btn {
                font-size: 1.8em;
                width: 35px;
                height: 35px;
            }
            
            .result-actions button {
                flex: 1;
            }
        }
    </style>
</head>
<body class="theme-light">
    <header>
        <div class="logo-container">
            <span class="material-symbols-outlined app-icon">local_hospital</span>
            <h1>SaludPro</h1>
        </div>
        <div class="subtitle">Asistente Clínico Inteligente</div>
        <div class="header-controls">
            <button id="theme-toggle" class="theme-toggle" title="Cambiar tema">
                <span class="material-symbols-outlined">dark_mode</span>
            </button>
            <div class="user-profile">
                <img src="https://placehold.co/40x40/1a73e8/ffffff?text=JP" alt="Avatar del médico" class="avatar">
                <span>Dr. Juan Pérez</span>
            </div>
        </div>
    </header>
    <nav>
        <ul>
            <li><a href="#dashboard" data-section="dashboard" class="active"><span class="material-symbols-outlined">dashboard</span> Dashboard</a></li>
            <li><a href="#consultorio" data-section="consultorio"><span class="material-symbols-outlined">search</span> Consultorio Virtual</a></li>
            <li><a href="#pacientes" data-section="pacientes"><span class="material-symbols-outlined">people</span> Pacientes</a></li>
            <li><a href="#personal" data-section="personal"><span class="material-symbols-outlined">groups</span> Personal</a></li>
            <li><a href="#recursos" data-section="recursos"><span class="material-symbols-outlined">library_books</span> Recursos</a></li>
            <li><a href="#signos-vitales" data-section="signos-vitales"><span class="material-symbols-outlined">monitor_heart</span> Signos Vitales</a></li>
            <li><a href="#recetas" data-section="recetas"><span class="material-symbols-outlined">medication</span> Recetas</a></li>
            <li><a href="#calculadoras" data-section="calculadoras"><span class="material-symbols-outlined">calculate</span> Calculadoras</a></li>
        </ul>
    </nav>
    <main id="app-content">
        <!-- Dashboard -->
        <section id="dashboard" class="page active">
            <div class="page-header">
                <h2>Dashboard Clínico</h2>
                <div class="dashboard-controls">
                    <button class="btn btn-secondary"><span class="material-symbols-outlined">settings</span> Personalizar</button>
                </div>
            </div>
            <p>Bienvenido, Dr. Juan Pérez.</p>
            <div class="patient-selector">
                <label for="active-patient">Paciente Activo:</label>
                <select id="active-patient">
                    <option value="">Selecciona un paciente...</option>
                </select>
            </div>
            <div class="alert-card">
                <span class="material-symbols-outlined alert-icon">warning</span>
                <div>
                    <strong>Seguimiento pendiente:</strong> Paciente Ana García con VIH requiere control de carga viral.
                </div>
            </div>
            <div class="indicator-cards">
                <div class="indicator-card">
                    <span class="material-symbols-outlined">trending_up</span>
                    <h3>CD4</h3>
                    <p>500 cel/µL <span class="status-indicator" style="background-color: var(--status-success);"></span></p>
                </div>
                <div class="indicator-card">
                    <span class="material-symbols-outlined">analytics</span>
                    <h3>Carga Viral</h3>
                    <p>Indetectable <span class="status-indicator" style="background-color: var(--status-success);"></span></p>
                </div>
                <div class="indicator-card">
                    <span class="material-symbols-outlined">fitness_center</span>
                    <h3>IMC</h3>
                    <p>24.5 <span class="status-indicator" style="background-color: var(--status-info);"></span></p>
                </div>
                <div class="indicator-card">
                    <span class="material-symbols-outlined">blood_pressure</span>
                    <h3>PA</h3>
                    <p>120/80 mmHg <span class="status-indicator" style="background-color: var(--status-success);"></span></p>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Evolución de Signos Vitales</h3>
                    <div class="chart-actions">
                        <button class="btn btn-secondary"><span class="material-symbols-outlined">download</span> Exportar</button>
                    </div>
                </div>
                <canvas id="vitalSignsChart"></canvas>
                <div class="chart-controls">
                    <select id="chart-type-selector">
                        <option value="pressure">Presión Arterial</option>
                        <option value="heartRate">Frecuencia Cardíaca</option>
                        <option value="temperature">Temperatura</option>
                        <option value="spo2">Saturación O2</option>
                    </select>
                    <button id="refresh-chart" class="btn btn-secondary"><span class="material-symbols-outlined">refresh</span> Actualizar</button>
                </div>
            </div>
            <div class="chart-container">
                <h3>Recomendaciones de IA</h3>
                <p><strong>Basado en los datos del paciente:</strong> Se sugiere considerar ajuste en medicación antihipertensiva para paciente Ana García, considerando tendencia a descenso de PA en últimos controles.</p>
                <p><strong>Alerta de riesgo:</strong> Paciente Carlos Martínez presenta perfil lipídico con LDL elevado, considerar intensificación de tratamiento estatínico.</p>
            </div>
        </section>
        
        <!-- Consultorio Virtual -->
        <section id="consultorio" class="page">
            <div class="page-header">
                <h2>Consultorio Virtual</h2>
            </div>
            <div class="consultorio-container">
                <div class="search-box">
                    <input type="text" id="search-query" placeholder="¿Qué desea consultar? (síntomas, enfermedades, medicamentos, protocolos...)">
                    <button id="search-button"><span class="material-symbols-outlined">search</span> Buscar</button>
                </div>
                <div id="suggestions-container" class="suggestions-container"></div>
            </div>
            <div id="search-results" class="search-results">
                <p>Busque información médica relevante utilizando el cuadro de búsqueda superior.</p>
                <div class="chart-container" style="margin-top: 30px;">
                    <h3>Consulta Reciente</h3>
                    <p><strong>Término:</strong> Cefalea intensa, fotofobia, fiebre</p>
                    <p><strong>Diagnósticos sugeridos:</strong> Meningitis bacteriana, Migraña con aura, Encefalitis</p>
                    <p><strong>Pruebas recomendadas:</strong> Punción lumbar, Tomografía computarizada, Resonancia magnética</p>
                    <button class="btn btn-primary" onclick="showExampleSearch()">Ver ejemplo de búsqueda</button>
                </div>
            </div>
        </section>
        
        <!-- Gestión de Pacientes -->
        <section id="pacientes" class="page">
            <div class="page-header">
                <h2>Gestión de Pacientes</h2>
                <div class="patient-controls">
                    <button class="btn btn-primary btn-add-patient"><span class="material-symbols-outlined">add</span> Nuevo Paciente</button>
                </div>
            </div>
            <div class="search-filter-bar">
                <input type="text" id="patient-search" placeholder="Buscar paciente por nombre, diagnóstico o CIE-10...">
                <select id="specialty-filter">
                    <option value="">Filtrar por especialidad...</option>
                </select>
                <button id="advanced-search" class="btn btn-secondary"><span class="material-symbols-outlined">search</span> Búsqueda Avanzada</button>
            </div>
            <div id="patient-grid" class="patient-grid">
                <!-- Tarjetas de pacientes se cargarán aquí -->
            </div>
        </section>
        
        <!-- Gestión de Personal -->
        <section id="personal" class="page">
            <div class="page-header">
                <h2>Gestión de Personal Médico</h2>
                <button class="btn btn-primary btn-add-staff"><span class="material-symbols-outlined">add</span> Nuevo Miembro</button>
            </div>
            <div class="search-filter-bar">
                <input type="text" id="staff-search" placeholder="Buscar personal por nombre, especialidad o rol...">
                <select id="role-filter">
                    <option value="">Filtrar por rol...</option>
                </select>
            </div>
            <div id="staff-grid" class="patient-grid">
                <!-- Tarjetas de personal se cargarán aquí -->
            </div>
        </section>
        
        <!-- Recursos Educativos -->
        <section id="recursos" class="page">
            <div class="page-header">
                <h2>Recursos Educativos</h2>
                <div class="resource-controls">
                    <button class="btn btn-primary btn-add-resource"><span class="material-symbols-outlined">add</span> Nuevo Recurso</button>
                </div>
            </div>
            <div class="search-filter-bar">
                <input type="text" id="resource-search" placeholder="Buscar recursos por título, etiqueta o contenido...">
                <select id="category-filter">
                    <option value="">Filtrar por categoría...</option>
                </select>
            </div>
            <div class="resource-tabs">
                <button class="resource-tab active" data-category="all">Todos</button>
                <button class="resource-tab" data-category="imagenes">Imágenes</button>
                <button class="resource-tab" data-category="videos">Videos</button>
                <button class="resource-tab" data-category="documentos">Documentos</button>
            </div>
            <div id="resource-grid" class="resource-cards">
                <!-- Recursos educativos se cargarán aquí -->
            </div>
        </section>
        
        <!-- Signos Vitales -->
        <section id="signos-vitales" class="page">
            <div class="page-header">
                <h2>Registro de Signos Vitales</h2>
            </div>
            <div class="patient-selector">
                <label for="vitals-patient">Paciente:</label>
                <select id="vitals-patient">
                    <option value="">Selecciona un paciente...</option>
                </select>
            </div>
            <div class="form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature">Temperatura (°C)</label>
                        <input type="number" id="temperature" step="0.1" placeholder="36.5">
                    </div>
                    <div class="form-group">
                        <label for="pa">Presión Arterial (mmHg)</label>
                        <input type="text" id="pa" placeholder="120/80">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fc">Frecuencia Cardíaca (ppm)</label>
                        <input type="number" id="fc" placeholder="75">
                    </div>
                    <div class="form-group">
                        <label for="fr">Frecuencia Respiratoria (rpm)</label>
                        <input type="number" id="fr" placeholder="16">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="spo2">Saturación O2 (%)</label>
                        <input type="number" id="spo2" placeholder="98">
                    </div>
                    <div class="form-group">
                        <label for="weight">Peso (kg)</label>
                        <input type="number" id="weight" step="0.1" placeholder="70">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="height">Talla (cm)</label>
                        <input type="number" id="height" placeholder="165">
                    </div>
                    <div class="form-group">
                        <label for="imc">IMC</label>
                        <input type="text" id="imc" readonly placeholder="Calculado automáticamente">
                    </div>
                </div>
                <div class="form-group">
                    <label for="notes">Notas adicionales</label>
                    <textarea id="notes" rows="3" placeholder="Observaciones del paciente..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="clear-vitals">Limpiar</button>
                    <button class="btn btn-primary" id="save-vitals">Guardar Signos Vitales</button>
                </div>
            </div>
            <div class="chart-container">
                <h3>Historial de Signos Vitales</h3>
                <canvas id="vitalsHistoryChart"></canvas>
            </div>
        </section>
        
        <!-- Recetas -->
        <section id="recetas" class="page">
            <div class="page-header">
                <h2>Emisión de Recetas</h2>
            </div>
            <div class="patient-selector">
                <label for="recipe-patient">Paciente:</label>
                <select id="recipe-patient">
                    <option value="">Selecciona un paciente...</option>
                </select>
            </div>
            <div class="medication-list">
                <h3>Medicamentos</h3>
                <div id="medication-entries">
                    <div class="medication-entry">
                        <div class="form-row">
                            <div class="form-group flex-grow">
                                <label for="medication-1">Medicamento</label>
                                <input type="text" id="medication-1" class="medication-name" placeholder="Nombre del medicamento">
                            </div>
                            <div class="form-group">
                                <label for="dose-1">Dosis</label>
                                <input type="text" id="dose-1" placeholder="10mg">
                            </div>
                            <div class="form-group">
                                <label for="frequency-1">Frecuencia</label>
                                <select id="frequency-1">
                                    <option value="once">1 vez al día</option>
                                    <option value="twice">2 veces al día</option>
                                    <option value="thrice">3 veces al día</option>
                                    <option value="four-times">4 veces al día</option>
                                    <option value="as-needed">Según necesidad</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="duration-1">Duración</label>
                                <input type="text" id="duration-1" placeholder="7 días">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="instructions-1">Instrucciones</label>
                            <textarea id="instructions-1" rows="2" placeholder="Tomar después de las comidas..."></textarea>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="add-medication"><span class="material-symbols-outlined">add</span> Añadir Medicamento</button>
            </div>
            <div class="interactions-warning" id="interactions-warning" style="display: none;">
                <span class="material-symbols-outlined">dangerous</span>
                <div>
                    <strong>Interacciones Medicamentosas Detectadas</strong>
                    <p id="interactions-list"></p>
                </div>
            </div>
            <div class="form-group">
                <label for="prescription-notes">Notas para el paciente</label>
                <textarea id="prescription-notes" rows="3" placeholder="Información adicional para el paciente..."></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary">Guardar Borrador</button>
                <button class="btn btn-primary" id="issue-prescription">Emitir Receta</button>
            </div>
        </section>
        
        <!-- Educación Médica -->
        <section id="educacion" class="page">
            <div class="page-header">
                <h2>Recursos de Educación Médica</h2>
            </div>
            <div class="resource-cards">
                <div class="resource-card">
                    <h3>Guías Clínicas</h3>
                    <p>Accede a las guías clínicas más recientes y actualizadas.</p>
                    <ul>
                        <li><a href="#">Hipertensión Arterial - 2023</a></li>
                        <li><a href="#">Diabetes Mellitus - 2023</a></li>
                        <li><a href="#">Enfermedad Pulmonar Obstructiva Crónica</a></li>
                        <li><a href="#">VIH/SIDA - Manejo Integral</a></li>
                        <li><a href="#">Insuficiencia Cardíaca - 2023</a></li>
                    </ul>
                </div>
                <div class="resource-card">
                    <h3>Artículos Científicos</h3>
                    <p>Revisa los últimos estudios y publicaciones científicas.</p>
                    <ul>
                        <li><a href="#">Avances en inmunoterapia oncológica</a></li>
                        <li><a href="#">Nuevos fármacos para enfermedades cardiovasculares</a></li>
                        <li><a href="#">Tratamientos innovadores para enfermedades neurodegenerativas</a></li>
                        <li><a href="#">Medicina de precisión en oncología</a></li>
                        <li><a href="#">Inteligencia artificial en diagnóstico médico</a></li>
                    </ul>
                </div>
                <div class="resource-card">
                    <h3>Educación al Paciente</h3>
                    <p>Materiales educativos para compartir con tus pacientes.</p>
                    <ul>
                        <li><a href="#">Cómo controlar tu diabetes</a></li>
                        <li><a href="#">Ejercicios para pacientes con artrosis</a></li>
                        <li><a href="#">Alimentación saludable para hipertensos</a></li>
                        <li><a href="#">Manejo del estrés y ansiedad</a></li>
                        <li><a href="#">Vacunación en adultos mayores</a></li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- Calculadoras Médicas -->
        <section id="calculadoras" class="page">
            <div class="page-header">
                <h2>Calculadoras Clínicas</h2>
            </div>
            <div class="calculator-selector">
                <label for="calc-selector">Selecciona una calculadora:</label>
                <select id="calc-selector">
                    <option value="imc">Índice de Masa Corporal (IMC)</option>
                    <option value="filtration">Filtrado Glomerular (CKD-EPI)</option>
                    <option value="child-pugh">Child-Pugh</option>
                    <option value="apgar">Apgar</option>
                    <option value="gestational-age">Edad Gestacional</option>
                    <option value="cardiovascular-risk">Riesgo Cardiovascular</option>
                </select>
            </div>
            
            <!-- Calculadora de IMC -->
            <div class="calculator-form" id="imc-calculator">
                <h3>Calculadora de Índice de Masa Corporal (IMC)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="imc-weight">Peso (kg)</label>
                        <input type="number" id="imc-weight" step="0.1" placeholder="70">
                    </div>
                    <div class="form-group">
                        <label for="imc-height">Talla (cm)</label>
                        <input type="number" id="imc-height" placeholder="170">
                    </div>
                </div>
                <button class="btn btn-primary" id="calculate-imc">Calcular IMC</button>
                <div class="result-display" id="imc-result" style="display: none;">
                    <h4>Resultado</h4>
                    <p><strong>IMC:</strong> <span id="imc-value"></span></p>
                    <p><strong>Clasificación:</strong> <span id="imc-classification"></span></p>
                    <p><strong>Recomendaciones:</strong> <span id="imc-recommendations"></span></p>
                </div>
            </div>
            
            <!-- Calculadora de Filtrado Glomerular -->
            <div class="calculator-form" id="filtration-calculator" style="display: none;">
                <h3>Calculadora de Filtrado Glomerular (CKD-EPI)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="creatinine">Creatinina sérica (mg/dL)</label>
                        <input type="number" id="creatinine" step="0.1" placeholder="1.0">
                    </div>
                    <div class="form-group">
                        <label for="age">Edad (años)</label>
                        <input type="number" id="age" placeholder="45">
                    </div>
                </div>
                <div class="form-group">
                    <label>Sexo</label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="male" checked> Masculino</label>
                        <label><input type="radio" name="gender" value="female"> Femenino</label>
                    </div>
                </div>
                <button class="btn btn-primary" id="calculate-filtration">Calcular TFG</button>
                <div class="result-display" id="filtration-result" style="display: none;">
                    <h4>Resultado</h4>
                    <p><strong>Filtrado Glomerular:</strong> <span id="filtration-value"></span> ml/min/1.73m²</p>
                    <p><strong>Estadio de Enfermedad Renal:</strong> <span id="filtration-stage"></span></p>
                    <p><strong>Recomendaciones:</strong> <span id="filtration-recommendations"></span></p>
                </div>
            </div>
            
            <!-- Calculadora Child-Pugh -->
            <div class="calculator-form" id="child-pugh-calculator" style="display: none;">
                <h3>Calculadora Child-Pugh</h3>
                <table class="child-pugh-table">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>1 Punto</th>
                            <th>2 Puntos</th>
                            <th>3 Puntos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ascitis</td>
                            <td>Ausente</td>
                            <td>Leve/Moderada</td>
                            <td>Refractaria</td>
                        </tr>
                        <tr>
                            <td>Encefalopatía</td>
                            <td>Grado 0-1</td>
                            <td>Grado 2</td>
                            <td>Grado 3-4</td>
                        </tr>
                        <tr>
                            <td>Bilirrubina (mg/dL)</td>
                            <td>&lt; 2.0</td>
                            <td>2.0-3.0</td>
                            <td>&gt; 3.0</td>
                        </tr>
                        <tr>
                            <td>Albúmina (g/dL)</td>
                            <td>&gt; 3.5</td>
                            <td>2.8-3.5</td>
                            <td>&lt; 2.8</td>
                        </tr>
                        <tr>
                            <td>INR</td>
                            <td>&lt; 1.7</td>
                            <td>1.7-2.3</td>
                            <td>&gt; 2.3</td>
                        </tr>
                    </tbody>
                </table>
                <div class="form-group">
                    <label for="ascites">Ascitis</label>
                    <select id="ascites">
                        <option value="1">Ausente (1 punto)</option>
                        <option value="2">Leve/Moderada (2 puntos)</option>
                        <option value="3">Refractaria (3 puntos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="encephalopathy">Encefalopatía</label>
                    <select id="encephalopathy">
                        <option value="1">Grado 0-1 (1 punto)</option>
                        <option value="2">Grado 2 (2 puntos)</option>
                        <option value="3">Grado 3-4 (3 puntos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bilirubin">Bilirrubina (mg/dL)</label>
                    <select id="bilirubin">
                        <option value="1">&lt; 2.0 (1 punto)</option>
                        <option value="2">2.0-3.0 (2 puntos)</option>
                        <option value="3">&gt; 3.0 (3 puntos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="albumin">Albúmina (g/dL)</label>
                    <select id="albumin">
                        <option value="1">&gt; 3.5 (1 punto)</option>
                        <option value="2">2.8-3.5 (2 puntos)</option>
                        <option value="3">&lt; 2.8 (3 puntos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inr">INR</label>
                    <select id="inr">
                        <option value="1">&lt; 1.7 (1 punto)</option>
                        <option value="2">1.7-2.3 (2 puntos)</option>
                        <option value="3">&gt; 2.3 (3 puntos)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="calculate-child-pugh">Calcular Puntuación</button>
                <div class="result-display" id="child-pugh-result" style="display: none;">
                    <h4>Resultado</h4>
                    <p><strong>Puntuación total:</strong> <span id="child-pugh-score"></span> puntos</p>
                    <p><strong>Clasificación:</strong> <span id="child-pugh-class"></span></p>
                    <p><strong>Prognóstico medio de supervivencia:</strong> <span id="child-pugh-prognosis"></span></p>
                    <p><strong>Recomendaciones:</strong> <span id="child-pugh-recommendations"></span></p>
                </div>
            </div>
            
            <!-- Calculadora de Riesgo Cardiovascular -->
            <div class="calculator-form" id="cardiovascular-risk-calculator" style="display: none;">
                <h3>Calculadora de Riesgo Cardiovascular (SCORE)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cv-age">Edad (años)</label>
                        <input type="number" id="cv-age" placeholder="55">
                    </div>
                    <div class="form-group">
                        <label for="cv-total-cholesterol">Colesterol total (mg/dL)</label>
                        <input type="number" id="cv-total-cholesterol" placeholder="200">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cv-systolic">Presión arterial sistólica (mmHg)</label>
                        <input type="number" id="cv-systolic" placeholder="130">
                    </div>
                    <div class="form-group">
                        <label for="cv-smoking">Tabaquismo</label>
                        <select id="cv-smoking">
                            <option value="no">No fumador</option>
                            <option value="yes">Fumador</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sexo</label>
                    <div class="radio-group">
                        <label><input type="radio" name="cv-gender" value="male" checked> Masculino</label>
                        <label><input type="radio" name="cv-gender" value="female"> Femenino</label>
                    </div>
                </div>
                <button class="btn btn-primary" id="calculate-cardiovascular-risk">Calcular Riesgo</button>
                <div class="result-display" id="cardiovascular-risk-result" style="display: none;">
                    <h4>Resultado</h4>
                    <p><strong>Riesgo cardiovascular a 10 años:</strong> <span id="cv-risk-value"></span></p>
                    <p><strong>Nivel de riesgo:</strong> <span id="cv-risk-level"></span></p>
                    <p><strong>Recomendaciones:</strong> <span id="cv-recommendations"></span></p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Paneles Modales -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <!-- El contenido del modal se cargará aquí -->
        </div>
    </div>
    
    <!-- Lightbox para imágenes -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="Imagen ampliada">
            <div id="lightbox-caption" class="lightbox-caption"></div>
        </div>
        <div class="lightbox-nav">
            <button id="lightbox-prev" class="lightbox-nav-btn"><span class="material-symbols-outlined">arrow_back</span></button>
            <button id="lightbox-next" class="lightbox-nav-btn"><span class="material-symbols-outlined">arrow_forward</span></button>
        </div>
        <div id="lightbox-close" class="lightbox-close"><span class="material-symbols-outlined">close</span></div>
    </div>

    

<script>
// --- Carga de Librerías Externas ---
// Cargar Chart.js desde CDN
const chartScript = document.createElement('script');
chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
chartScript.onload = () => {
    console.log('Chart.js cargado.');
    // Inicializar gráficos una vez que Chart.js esté disponible
    if (APP_STATE.currentSection === 'dashboard') {
        showVitalSignsChart();
    }
    if (APP_STATE.currentSection === 'signos-vitales') { // Si la sección de signos vitales tiene historial
        setupVitalsHistoryChart();
    }
};
chartScript.onerror = () => {
    console.error('Error al cargar Chart.js. Los gráficos no estarán disponibles.');
};
document.head.appendChild(chartScript);


// --- Datos Simulados ---
const simulatedPatients = [
    {
        id: 1,
        nombre: "Ana García",
        edad: 45,
        diagnosticoPrincipal: "Hipertensión Arterial",
        especialidad: "Cardiología",
        riesgoCardiovascular: "alto",
        alergias: ["Penicilina"],
        historiaClinica: {
            resumen: "Paciente femenina de 45 años con HTA controlada desde hace 2 años. Actualmente en tratamiento con Losartán.",
            diagnosticos: [
                { fecha: "2023-01-15", cie10: "I10", descripcion: "Hipertensión esencial (primaria)", estado: "Activo" },
                { fecha: "2023-03-20", cie10: "E78.0", descripcion: "Hipercolesterolemia", estado: "Activo" }
            ],
            tratamientos: ["Losartán 50mg cada 12h", "Atorvastatina 20mg cada 24h"],
            evolucion: [
                { fecha: "2023-01-15", nota: "Primer diagnóstico de HTA. Iniciado tratamiento con Losartán." },
                { fecha: "2023-03-20", nota: "Control de PA satisfactorio. Se agrega Atorvastatina por perfil lipídico alterado." },
                { fecha: "2023-06-20", nota: "PA 120/80 mmHg. Perfil lipídico mejorado." }
            ],
            signosVitales: [
                { fecha: "2023-01-15", temperatura: 36.8, pa: "130/85", fc: 75, fr: 16, spo2: 98, peso: 70, talla: 1.65, imc: 25.7 },
                { fecha: "2023-03-20", temperatura: 36.7, pa: "125/82", fc: 72, fr: 15, spo2: 99, peso: 69, talla: 1.65, imc: 25.3 },
                { fecha: "2023-06-20", temperatura: 36.7, pa: "120/80", fc: 70, fr: 15, spo2: 99, peso: 69, talla: 1.65, imc: 25.3 }
            ]
        }
    },
    {
        id: 2,
        nombre: "Carlos Martínez",
        edad: 52,
        diagnosticoPrincipal: "Diabetes Mellitus Tipo 2",
        especialidad: "Endocrinología",
        riesgoCardiovascular: "moderado",
        alergias: [],
        historiaClinica: {
            resumen: "Paciente masculino de 52 años con DM2 diagnosticada hace 5 años. Control metabólico subóptimo.",
            diagnosticos: [
                { fecha: "2018-05-10", cie10: "E11.9", descripcion: "Diabetes mellitus tipo 2 sin complicaciones", estado: "Activo" },
                { fecha: "2022-11-03", cie10: "I25.10", descripcion: "Enfermedad arterial coronaria", estado: "Activo" }
            ],
            tratamientos: ["Metformina 850mg cada 12h", "Glibenclamida 5mg cada 24h", "Aspirina 100mg cada 24h"],
            evolucion: [
                { fecha: "2018-05-10", nota: "Diagnóstico de DM2. Iniciado tratamiento con Metformina." },
                { fecha: "2020-02-15", nota: "HbA1c 8.5%. Se agrega Glibenclamida." },
                { fecha: "2022-11-03", nota: "Angioplastia coronaria por angina inestable. Iniciado tratamiento con Aspirina." }
            ],
            signosVitales: [
                { fecha: "2023-02-10", temperatura: 36.6, pa: "140/90", fc: 78, fr: 16, spo2: 97, peso: 85, talla: 1.75, imc: 27.8 },
                { fecha: "2023-05-15", temperatura: 36.5, pa: "135/85", fc: 76, fr: 15, spo2: 98, peso: 83, talla: 1.75, imc: 27.1 },
                { fecha: "2023-08-20", temperatura: 36.7, pa: "130/80", fc: 74, fr: 15, spo2: 99, peso: 82, talla: 1.75, imc: 26.8 }
            ]
        }
    },
    {
        id: 3,
        nombre: "María López",
        edad: 38,
        diagnosticoPrincipal: "VIH",
        especialidad: "Infectología",
        riesgoCardiovascular: "bajo",
        alergias: ["Sulfa"],
        historiaClinica: {
            resumen: "Paciente femenina de 38 años con VIH diagnosticado hace 8 años. En terapia antirretroviral con buena adherencia.",
            diagnosticos: [
                { fecha: "2015-07-22", cie10: "B20", descripcion: "VIH con manifestaciones clínicas", estado: "Activo" },
                { fecha: "2021-03-18", cie10: "Z79.899", descripcion: "Terapia de mantenimiento con antirretrovirales", estado: "Activo" }
            ],
            tratamientos: ["Tenofovir/Emtricitabina/Efavirenz 300/200/600mg cada 24h"],
            evolucion: [
                { fecha: "2015-07-22", nota: "Diagnóstico de VIH. Iniciado TARV con buen control inmunológico." },
                { fecha: "2020-01-10", nota: "Cambio de esquema por efectos secundarios." },
                { fecha: "2023-04-05", nota: "Carga viral indetectable desde hace 3 años. CD4 estable en 500-600 cel/µL." }
            ],
            signosVitales: [
                { fecha: "2023-01-10", temperatura: 36.8, pa: "115/75", fc: 72, fr: 14, spo2: 98, peso: 62, talla: 1.60, imc: 24.2 },
                { fecha: "2023-04-05", temperatura: 36.7, pa: "118/78", fc: 70, fr: 14, spo2: 99, peso: 63, talla: 1.60, imc: 24.6 },
                { fecha: "2023-07-12", temperatura: 36.6, pa: "116/76", fc: 71, fr: 14, spo2: 98, peso: 62, talla: 1.60, imc: 24.2 }
            ]
        }
    },
    {
        id: 4,
        nombre: "Roberto Sánchez",
        edad: 67,
        diagnosticoPrincipal: "Insuficiencia Cardíaca",
        especialidad: "Cardiología",
        riesgoCardiovascular: "alto",
        alergias: [],
        historiaClinica: {
            resumen: "Paciente masculino de 67 años con IC por miocardiopatía isquémica. Clase funcional II NYHA.",
            diagnosticos: [
                { fecha: "2019-09-05", cie10: "I50.9", descripcion: "Insuficiencia cardíaca no especificada", estado: "Activo" },
                { fecha: "2019-09-05", cie10: "I25.5", descripcion: "Miocardiopatía isquémica", estado: "Activo" }
            ],
            tratamientos: ["Enalapril 10mg cada 12h", "Carvedilol 12.5mg cada 12h", "Espironolactona 25mg cada 24h", "Furosemida 40mg cada 24h"],
            evolucion: [
                { fecha: "2019-09-05", nota: "Diagnóstico de IC tras infarto de miocardio. Iniciado tratamiento farmacológico." },
                { fecha: "2021-06-18", nota: "Optimizado tratamiento. Clase funcional II NYHA." },
                { fecha: "2023-03-22", nota: "Estable con tratamiento actual. Control de peso y PA adecuado." }
            ],
            signosVitales: [
                { fecha: "2023-02-08", temperatura: 36.5, pa: "125/80", fc: 68, fr: 16, spo2: 96, peso: 78, talla: 1.72, imc: 26.4 },
                { fecha: "2023-05-11", temperatura: 36.6, pa: "122/78", fc: 66, fr: 15, spo2: 97, peso: 77, talla: 1.72, imc: 26.0 },
                { fecha: "2023-08-15", temperatura: 36.4, pa: "120/75", fc: 65, fr: 15, spo2: 98, peso: 77, talla: 1.72, imc: 26.0 }
            ]
        }
    }
];

const medicalStaff = [
    {
        id: 1,
        nombre: "Juan Pérez",
        especialidad: "Cardiología",
        rol: "Médico",
        avatar: "https://placehold.co/40x40/1a73e8/ffffff?text=JP",
        contacto: { telefono: "555-1234", email: "juan.perez@hospital.com" },
        bio: "Cardiólogo con 15 años de experiencia en el manejo de hipertensión y arritmias.",
        citas: 12
    },
    {
        id: 2,
        nombre: "Ana Martínez",
        especialidad: "Enfermería",
        rol: "Enfermera",
        avatar: "https://placehold.co/40x40/34a853/ffffff?text=AM",
        contacto: { telefono: "555-5678", email: "ana.martinez@hospital.com" },
        bio: "Enfermera especializada en cuidados intensivos y manejo de pacientes críticos.",
        citas: 8
    },
    {
        id: 3,
        nombre: "Carlos Gómez",
        especialidad: "Administración",
        rol: "Administrador",
        avatar: "https://placehold.co/40x40/f9ab00/ffffff?text=CG",
        contacto: { telefono: "555-9012", email: "carlos.gomez@hospital.com" },
        bio: "Administrador de la clínica con experiencia en gestión de recursos y personal.",
        citas: 0
    },
    {
        id: 4,
        nombre: "Lucía Fernández",
        especialidad: "Pediatría",
        rol: "Médico",
        avatar: "https://placehold.co/40x40/ea4335/ffffff?text=LF",
        contacto: { telefono: "555-3456", email: "lucia.fernandez@hospital.com" },
        bio: "Pediatra con enfoque en desarrollo infantil y vacunación.",
        citas: 15
    }
];

const educationalResources = [
    {
        id: 1,
        titulo: "Técnica de Curación de Herida Quirúrgica",
        tipo: "imagen",
        url: "https://placehold.co/300x200/1a73e8/ffffff?text=Curación+Herida",
        categoria: "curacion",
        etiquetas: ["curacion", "procedimiento", "enfermeria"],
        descripcion: "Guía visual para el correcto procedimiento de curación de heridas quirúrgicas."
    },
    {
        id: 2,
        titulo: "Anatomía del Sistema Cardiovascular",
        tipo: "imagen",
        url: "https://placehold.co/300x200/34a853/ffffff?text=Sistema+Cardiovascular",
        categoria: "anatomia",
        etiquetas: ["anatomia", "cardiovascular"],
        descripcion: "Diagrama detallado del sistema cardiovascular humano."
    },
    {
        id: 3,
        titulo: "Protocolo de Reanimación Cardiopulmonar",
        tipo: "documento",
        url: "https://www.redalyc.org/pdf/1996/199614564007.pdf", // URL de ejemplo de protocolo
        categoria: "protocolo",
        etiquetas: ["resucitación", "emergencia", "protocolo"],
        descripcion: "Documento PDF con el protocolo oficial de RCP para profesionales de la salud."
    },
    {
        id: 4,
        titulo: "Introducción a la Diabetes Mellitus",
        tipo: "video",
        url: "https://www.youtube.com/embed/example_video_id", // URL de ejemplo de video embebido
        categoria: "educacion",
        etiquetas: ["diabetes", "educacion", "paciente"],
        descripcion: "Video educativo sobre los fundamentos de la diabetes mellitus para pacientes."
    }
];

const medicalKnowledgeBase = {
    diseases: [
        {
            id: "d-001",
            nombre: "Esclerosis Múltiple",
            codigoCIE10: "G35",
            etiologia: "Enfermedad autoinmune donde el sistema inmunológico ataca la mielina, la cubierta protectora de los nervios, en el sistema nervioso central.",
            fisiopatologia: "La inflamación autoinmune conduce a la desmielinización de las fibras nerviosas, lo que interrumpe la transmisión de señales nerviosas entre el cerebro y otras partes del cuerpo.",
            epidemiologia: "Afecta a aproximadamente 2.8 millones de personas en todo el mundo. Más común en mujeres que en hombres (3:1), generalmente diagnosticada entre los 20 y 40 años.",
            presentacionClinica: [
                "Fatiga extrema", "Debilidad muscular", "Entumecimiento u hormigueo", "Problemas de visión (neuritis óptica)",
                "Problemas de equilibrio y coordinación", "Espasmos musculares", "Problemas cognitivos (dificultad para concentrarse, memoria)"
            ],
            diagnostico: "Basado en criterios de McDonald, que requieren evidencia de lesiones en diferentes partes del sistema nervioso central (diseminación en el espacio) y en diferentes momentos (diseminación en el tiempo), generalmente confirmadas por resonancia magnética (RM) y estudios del líquido cefalorraquídeo.",
            diagnosticosDiferenciales: ["Neuromielitis óptica", "Síndrome de Guillain-Barré", "Enfermedad de Lyme", "Tumores del sistema nervioso central", "Deficiencia de vitamina B12"],
            clasificacion: "Forma recurrente-remitente (RRMS), progresiva primaria (PPMS), progresiva secundaria (SPMS), progresiva activa, progresiva no activa.",
            tratamientos: ["Interferón beta (reduce la frecuencia de brotes)", "Glatiramer acetato", "Terapias de células B (Ocrelizumab)", "Inmunosupresores (Mitoxantrona)", "Terapias para síntomas específicos (fatiga, espasmos, depresión)"],
            protocolos: ["Guía de práctica clínica de la Asociación Americana de Esclerosis Múltiple"],
            pronostico: "Variable. La mayoría de los pacientes tienen una esperanza de vida cercana a la normal, pero con discapacidad progresiva. El curso depende del tipo y de la respuesta al tratamiento.",
            educacionPaciente: "La esclerosis múltiple es una condición crónica del sistema nervioso. Aunque no tiene cura, hay tratamientos que pueden ralentizar su progreso y manejar los síntomas. Es importante mantener un estilo de vida saludable.",
            recursosAdicionales: ["https://www.nationalmssociety.org/", "https://www.msif.org/"],
            imagenes: [
                { url: "https://placehold.co/400x300/1a73e8/ffffff?text=RM+Esclerosis+Múltiple", descripcion: "Lesiones desmielinizantes en la resonancia magnética cerebral" },
                { url: "https://placehold.co/400x300/34a853/ffffff?text=Marcha+en+EM", descripcion: "Paciente con esclerosis múltiple mostrando dificultad de marcha" }
            ]
        },
        {
            id: "d-002",
            nombre: "Meningitis Bacteriana",
            codigoCIE10: "G00.9",
            etiologia: "Infección bacteriana del sistema nervioso central, comúnmente causada por Streptococcus pneumoniae, Neisseria meningitidis o Haemophilus influenzae tipo b.",
            fisiopatologia: "Las bacterias ingresan al sistema nervioso central, provocando inflamación de las meninges (membranas que rodean el cerebro y la médula espinal), lo que aumenta la presión intracraneal y puede dañar el tejido cerebral.",
            epidemiologia: "Incide principalmente en niños pequeños, adolescentes y adultos jóvenes. La incidencia ha disminuido gracias a las vacunas.",
            presentacionClinica: [
                "Cefalea intensa", "Fotofobia (sensibilidad a la luz)", "Fiebre alta", "Rigidez de nuca",
                "Náuseas y vómitos", "Confusión mental", "Convulsiones"
            ],
            diagnostico: "Diagnóstico definitivo mediante punción lumbar y análisis del líquido cefalorraquídeo (LCR): elevación de células (predominio de neutrófilos), proteínas elevadas, glucosa baja. Cultivo del LCR para identificar el patógeno.",
            diagnosticosDiferenciales: ["Meningitis viral", "Encefalitis", "Absceso cerebral", "Hemorragia subaracnoidea", "Sepsis"],
            clasificacion: "Aguda (progresión rápida) o subaguda (progresión más lenta).",
            tratamientos: ["Antibióticos de amplio espectro intravenosos (Ceftriaxona, Vancomicina) iniciados de inmediato", "Dexametasona (para reducir la inflamación y las secuelas neurológicas)", "Soporte vital (manejo de la presión intracraneal, hidratación)"],
            protocolos: ["Protocolo de manejo de meningitis bacteriana en adultos y pediatría"],
            pronostico: "Grave, con mortalidad del 10-15%. Los sobrevivientes pueden tener secuelas neurológicas permanentes (sordera, convulsiones, discapacidad cognitiva).",
            educacionPaciente: "La meningitis bacteriana es una emergencia médica. Requiere tratamiento inmediato con antibióticos. La vacunación es clave para la prevención.",
            recursosAdicionales: ["https://www.cdc.gov/meningitis/index.html"],
            imagenes: [
                { url: "https://placehold.co/400x300/ea4335/ffffff?text=RM+Meningitis", descripcion: "Imágenes de resonancia magnética mostrando inflamación de las meninges" },
                { url: "https://placehold.co/400x300/f9ab00/ffffff?text=Signo+Kernig", descripcion: "Signo de Kernig positivo en un paciente con meningitis" }
            ]
        },
        {
            id: "d-003",
            nombre: "Diabetes Mellitus Tipo 2",
            codigoCIE10: "E11.9",
            etiologia: "Resistencia a la insulina combinada con una deficiencia relativa de insulina. Factores de riesgo: obesidad, sedentarismo, antecedentes familiares, edad avanzada.",
            fisiopatologia: "Las células del cuerpo no responden adecuadamente a la insulina (resistencia), lo que lleva a una producción inadecuada de insulina por parte del páncreas, resultando en hiperglucemia crónica.",
            epidemiologia: "La forma más común de diabetes, representa el 90-95% de todos los casos. Prevalencia creciente globalmente, asociada a la epidemia de obesidad.",
            presentacionClinica: [
                "Poliuria (orinar con frecuencia)", "Polidipsia (sed excesiva)", "Polidipsia (hambre excesiva)", "Pérdida de peso inexplicable",
                "Visión borrosa", "Fatiga", "Heridas que sanan lentamente"
            ],
            diagnostico: "Basado en niveles elevados de glucosa en sangre: glucosa plasmática en ayunas ≥126 mg/dL, glucosa plasmática al azar ≥200 mg/dL con síntomas, HbA1c ≥6.5%.",
            diagnosticosDiferenciales: ["Diabetes Mellitus Tipo 1", "Diabetes secundaria (por medicamentos, enfermedades del páncreas)", "Diabetes insípida"],
            clasificacion: "Por gravedad del control glucémico, presencia de complicaciones micro/macrovasculares.",
            tratamientos: ["Modificación del estilo de vida (dieta, ejercicio)", "Metformina (primera línea)", "Sulfonilureas", "Inhibidores de DPP-4", "Análogos del GLP-1", "Insulina (en etapas avanzadas)"],
            protocolos: ["Guías de la Asociación Americana de Diabetes (ADA)"],
            pronostico: "Crónica progresiva. Buen control glucémico reduce significativamente el riesgo de complicaciones como nefropatía, retinopatía, neuropatía y enfermedad cardiovascular.",
            educacionPaciente: "La diabetes tipo 2 se puede manejar con dieta, ejercicio y medicamentos. Es crucial controlar la glucosa, la presión arterial y el colesterol para prevenir complicaciones.",
            recursosAdicionales: ["https://www.diabetes.org/"],
            imagenes: [
                { url: "https://placehold.co/400x300/34a853/ffffff?text=Glucosa+en+Sangre", descripcion: "Gráfico de niveles de glucosa en sangre a lo largo del día" },
                { url: "https://placehold.co/400x300/1a73e8/ffffff?text=Pie+Diabético", descripcion: "Complicaciones del pie diabético" }
            ]
        },
        {
            id: "d-004",
            nombre: "Parkinson",
            codigoCIE10: "G20",
            etiologia: "Degeneración progresiva de las neuronas dopaminérgicas en la sustancia negra del cerebro. La causa exacta es desconocida, factores genéticos y ambientales juegan un papel.",
            fisiopatologia: "La pérdida de neuronas productoras de dopamina en la sustancia negra pars compacta conduce a un desequilibrio en los circuitos del ganglio basal, resultando en los síntomas motores característicos.",
            epidemiologia: "Afecta a aproximadamente 1% de la población mayor de 60 años. Ligeramente más común en hombres.",
            presentacionClinica: [
                "Temblor de reposo (mano, pierna, mandíbula)", "Bradicinesia (lentitud de movimientos)", "Rigidez muscular", "Postura encorvada",
                "Problemas de equilibrio y marcha (falta de balanceo de brazos, arrastre de pies)", "Alteraciones del habla y escritura"
            ],
            diagnostico: "Diagnóstico clínico basado en la historia y el examen físico. No hay una prueba definitiva. Criterios de diagnóstico de la UK Parkinson's Disease Society Brain Bank.",
            diagnosticosDiferenciales: ["Parkinsonismo secundario (por medicamentos, traumatismo)", "Parálisis supranuclear progresiva", "Atrofia multisistémica", "Temblor esencial"],
            clasificacion: "Por etapa (escala de Hoehn y Yahr), por tipo de presentación (temblor-dominante, akinético-rígido).",
            tratamientos: ["Levodopa/Carbidopa (tratamiento más eficaz)", "Agonistas dopaminérgicos (Pramipexol, Ropinirol)", "Inhibidores de la COMT (Entacapona)", "Inhibidores de la MAO-B (Selegilina)", "Terapia con ejercicio y rehabilitación"],
            protocolos: ["Guías de práctica clínica para el manejo del Parkinson"],
            pronostico: "Progresivo. No curable, pero los tratamientos pueden controlar los síntomas durante muchos años. La esperanza de vida puede reducirse ligeramente.",
            educacionPaciente: "El Parkinson es una enfermedad neurodegenerativa que afecta el movimiento. Aunque no tiene cura, hay tratamientos que pueden mejorar significativamente la calidad de vida.",
            recursosAdicionales: ["https://www.parkinson.org/"],
            imagenes: [
                { url: "https://placehold.co/400x300/ea4335/ffffff?text=RM+Parkinson", descripcion: "Resonancia magnética cerebral en Parkinson" },
                { url: "https://placehold.co/400x300/f9ab00/ffffff?text=Marcha+Parkinson", descripcion: "Característica marcha en pacientes con Parkinson" }
            ]
        }
    ],
    treatments: [
        {
            id: "t-001",
            nombre: "Metformina",
            indicaciones: ["Diabetes Mellitus Tipo 2", "Síndrome de ovario poliquístico"],
            mecanismoAccion: "Disminuye la producción de glucosa por el hígado (gluconeogénesis) y mejora la sensibilidad a la insulina en los músculos.",
            farmacocinetica: "Biodisponibilidad del 50-60%. No se metaboliza. Se excreta inalterada por los riñones.",
            efectosAdversos: ["Gastrointestinales (diarrea, náuseas, dolor abdominal) - comunes", "Deficiencia de vitamina B12 - a largo plazo", "Acidosis láctica - rara pero grave"],
            interacciones: ["Contraste yodado (riesgo de acidosis láctica)", "Alcohol (aumenta el riesgo de acidosis láctica)"],
            contraindicaciones: ["Insuficiencia renal (TFG <30 ml/min)", "Acidosis metabólica", "Insuficiencia hepática grave"],
            dosis: "Dosis inicial típica: 500mg dos veces al día. Dosis máxima: 2000-2550mg/día.",
            viaAdministracion: "Oral"
        },
        {
            id: "t-002",
            nombre: "Losartán",
            indicaciones: ["Hipertensión Arterial", "Nefropatía diabética en pacientes con diabetes tipo 2"],
            mecanismoAccion: "Antagonista del receptor de angiotensina II (ARA II). Bloquea el efecto de la angiotensina II, un potente vasoconstrictor, lo que provoca vasodilatación y disminución de la presión arterial.",
            farmacocinetica: "Biodisponibilidad del 33%. Se metaboliza en el hígado. Efecto máximo a las 6 semanas.",
            efectosAdversos: ["Hipotensión", "Hiperkalemia", "Tos (menos frecuente que con IECA)", "Dolor de espalda"],
            interacciones: ["Potencia el efecto de otros antihipertensivos", "Aumenta el riesgo de hipotensión con diuréticos", "Aumenta el riesgo de hiperkalemia con suplementos de potasio o espironolactona"],
            contraindicaciones: ["Embarazo", "Hipersensibilidad", "Estenosis de la arteria renal bilateral"],
            dosis: "Dosis inicial: 50mg una vez al día. Dosis de mantenimiento: 50-100mg/día.",
            viaAdministracion: "Oral"
        }
    ],
    drugs: [ // Consolidado de medicamentos
        {
            id: "dr-001",
            nombre: "Metformina",
            laboratorio: "Merck",
            precio: 12.80,
            contraindicaciones: ["Insuficiencia renal", "Acidosis metabólica"],
            interacciones: {
                "Contraste yodado": { severidad: "fatal", descripcion: "Riesgo muy alto de acidosis láctica." },
                "Alcohol": { severidad: "moderada", descripcion: "Aumenta el riesgo de acidosis láctica." }
            },
            efectosSecundarios: ["Diarrea", "Náuseas", "Dolor abdominal", "Deficiencia de vitamina B12"],
            mecanismoAccion: "Disminuye la producción de glucosa por el hígado y mejora la sensibilidad a la insulina."
        },
        {
            id: "dr-002",
            nombre: "Losartán",
            laboratorio: "MSD",
            precio: 15.50,
            contraindicaciones: ["Embarazo", "Hipersensibilidad"],
            interacciones: {
                "Aspirina": { severidad: "leve", descripcion: "Puede aumentar levemente el riesgo de sangrado." },
                "Furosemida": { severidad: "moderada", descripcion: "Puede potenciar el efecto hipotensor." }
            },
            efectosSecundarios: ["Hipotensión", "Hiperkalemia", "Tos", "Dolor de espalda"],
            mecanismoAccion: "Antagonista del receptor de angiotensina II, causa vasodilatación."
        },
        {
            id: "dr-003",
            nombre: "Aspirina",
            laboratorio: "Bayer",
            precio: 8.20,
            contraindicaciones: ["Hemorragia activa", "Úlcera péptica"],
            interacciones: {
                "Losartán": { severidad: "leve", descripcion: "Puede aumentar levemente el riesgo de sangrado." },
                "Warfarina": { severidad: "fatal", descripcion: "Riesgo muy alto de hemorragia grave." },
                "Metformina": { severidad: "leve", descripcion: "No hay interacción significativa, pero ambos pueden causar molestias gastrointestinales." }
            },
            efectosSecundarios: ["Irritación gástrica", "Sangrado", "Zumbido en los oídos (dosis altas)"],
            mecanismoAccion: "Inhibidor de la ciclooxigenasa (COX), antiagregante plaquetario, antiinflamatorio."
        },
        {
            id: "dr-004",
            nombre: "Glibenclamida",
            laboratorio: "Roche",
            precio: 18.90,
            contraindicaciones: ["Diabetes tipo 1", "Cetoacidosis"],
            interacciones: {
                "Metformina": { severidad: "moderada", descripcion: "Aumenta el riesgo de hipoglucemia." }
            },
            efectosSecundarios: ["Hipoglucemia", "Náuseas", "Malestar gastrointestinal"],
            mecanismoAccion: "Secretagogo de insulina. Estimula la liberación de insulina por las células beta del páncreas."
        },
        {
            id: "dr-005",
            nombre: "Warfarina",
            laboratorio: "Pfizer",
            precio: 25.50,
            contraindicaciones: ["Embarazo", "Hemorragia activa"],
            interacciones: {
                "Aspirina": { severidad: "fatal", descripcion: "Riesgo muy alto de hemorragia grave." },
                "Ibuprofeno": { severidad: "moderada", descripcion: "Aumenta el riesgo de sangrado gastrointestinal." }
            },
            efectosSecundarios: ["Sangrado", "Equimosis"],
            mecanismoAccion: "Antagonista de la vitamina K. Inhibe la síntesis de factores de coagulación dependientes de la vitamina K."
        },
        {
            id: "dr-006",
            nombre: "Tenofovir",
            laboratorio: "Gilead",
            precio: 85.00,
            contraindicaciones: ["Insuficiencia renal severa"],
            interacciones: {
                "Atazanavir": { severidad: "moderada", descripcion: "Aumenta las concentraciones de tenofovir, riesgo de nefrotoxicidad." }
            },
            efectosSecundarios: ["Nefrotoxicidad", "Disminución de la densidad mineral ósea", "Náuseas"],
            mecanismoAccion: "Análogo nucleótido que inhibe la transcriptasa inversa del VIH."
        }
    ],
    protocols: [
        {
            id: "p-001",
            nombre: "Manejo de Meningitis Bacteriana en Adultos",
            area: "Infectología/Neurología",
            descripcion: "Protocolo basado en evidencia para el diagnóstico y tratamiento inmediato de meningitis bacteriana.",
            pasos: [
                "1. Sospecha clínica: Cefalea intensa, fiebre, rigidez de nuca, fotofobia.",
                "2. Estudios inmediatos: Hemograma, función renal, glucemia, cultivos de sangre.",
                "3. Imágenes: Tomografía computarizada (TC) de cráneo si hay signos de herniación o antecedente de lesión cerebral.",
                "4. Punción lumbar: Si la TC es normal o no está indicada, realizar punción lumbar para análisis del LCR.",
                "5. Tratamiento empírico inmediato: Ceftriaxona 2g IV cada 12h + Vancomicina 15mg/kg IV cada 12h + Dexametasona 10mg IV cada 6h.",
                "6. Ajustar tratamiento según cultivo del LCR.",
                "7. Soporte vital y monitoreo neurológico."
            ],
            referencias: ["IDSA Guidelines", "UpToDate"]
        },
        {
            id: "p-002",
            nombre: "Diagnóstico de Esclerosis Múltiple (Criterios McDonald 2017)",
            area: "Neurología",
            descripcion: "Criterios internacionales para el diagnóstico de esclerosis múltiple.",
            pasos: [
                "1. Demostrar diseminación en el espacio (DIS): ≥1 lesión en al menos 2 de las 4 áreas características del SNC (periventricular, juxtacortical, infratentorial, médula espinal).",
                "2. Demostrar diseminación en el tiempo (DIT): ≥1 lesión gadolinio-positiva nueva en relación con una escaneo previo, o una nueva lesión T2 o gadolinio-positiva en un escaneo posterior.",
                "3. Excluir diagnósticos alternativos más probables."
            ],
            referencias: ["Lancet Neurology 2018"]
        }
    ],
    medicalProcedures: [
        {
            id: "pr-001",
            nombre: "Punción Lumbar",
            indicaciones: ["Diagnóstico de meningitis", "Diagnóstico de hemorragia subaracnoidea", "Medición de presión del LCR", "Administración de medicamentos (quimioterapia, anestesia espinal)"],
            contraindicaciones: ["Infección en el sitio de punción", "Trastornos de coagulación no corregidos", "Presión intracraneal muy elevada (riesgo de herniación)"],
            riesgos: ["Dolor de cabeza post-punción", "Infección", "Hemorragia", "Daño nervioso"]
        }
    ],
    medicalTests: [
        {
            id: "te-001",
            nombre: "Resonancia Magnética (RM) Cerebral",
            indicaciones: ["Evaluación de tumores", "Diagnóstico de esclerosis múltiple", "Evaluación de accidente cerebrovascular", "Investigación de epilepsia", "Evaluación de trauma craneal"],
            interpretacion: "Permite visualizar con gran detalle el tejido cerebral. Las lesiones desmielinizantes en EM aparecen como hiperintensidades en secuencias T2/FLAIR. Los tumores pueden realzarse con contraste."
        },
        {
            id: "te-002",
            nombre: "Punción Lumbar",
            indicaciones: ["Diagnóstico de meningitis", "Diagnóstico de hemorragia subaracnoidea", "Medición de presión del LCR"],
            interpretacion: "El LCR normal es claro e incoloro. En meningitis bacteriana: turbio, elevación de células (neutrófilos), proteínas elevadas, glucosa baja. En meningitis viral: líquido claro, linfocitos elevados, proteínas levemente elevadas, glucosa normal."
        }
    ]
};

const medicamentosDB = { // Referencia usada por recetas y chequeo de interacciones
    "Losartán": {
        nombre: "Losartán",
        laboratorio: "MSD",
        precio: 15.50,
        contraindicaciones: ["Embarazo", "Hipersensibilidad"],
        interacciones: {
            "Aspirina": { severidad: "leve", descripcion: "Puede aumentar levemente el riesgo de sangrado." },
            "Furosemida": { severidad: "moderada", descripcion: "Puede potenciar el efecto hipotensor." }
        }
    },
    "Aspirina": {
        nombre: "Aspirina",
        laboratorio: "Bayer",
        precio: 8.20,
        contraindicaciones: ["Hemorragia activa", "Úlcera péptica"],
        interacciones: {
            "Losartán": { severidad: "leve", descripcion: "Puede aumentar levemente el riesgo de sangrado." },
            "Warfarina": { severidad: "fatal", descripcion: "Riesgo muy alto de hemorragia grave." },
            "Metformina": { severidad: "leve", descripcion: "No hay interacción significativa, pero ambos pueden causar molestias gastrointestinales." }
        }
    },
    "Metformina": {
        nombre: "Metformina",
        laboratorio: "Merck",
        precio: 12.80,
        contraindicaciones: ["Insuficiencia renal", "Acidosis metabólica"],
        interacciones: {
            "Contraste yodado": { severidad: "fatal", descripcion: "Riesgo muy alto de acidosis láctica." },
            "Alcohol": { severidad: "moderada", descripcion: "Aumenta el riesgo de acidosis láctica." }
        }
    },
    "Glibenclamida": {
        nombre: "Glibenclamida",
        laboratorio: "Roche",
        precio: 18.90,
        contraindicaciones: ["Diabetes tipo 1", "Cetoacidosis"],
        interacciones: {
            "Metformina": { severidad: "moderada", descripcion: "Aumenta el riesgo de hipoglucemia." }
        }
    },
    "Warfarina": {
        nombre: "Warfarina",
        laboratorio: "Pfizer",
        precio: 25.50,
        contraindicaciones: ["Embarazo", "Hemorragia activa"],
        interacciones: {
            "Aspirina": { severidad: "fatal", descripcion: "Riesgo muy alto de hemorragia grave." },
            "Ibuprofeno": { severidad: "moderada", descripcion: "Aumenta el riesgo de sangrado gastrointestinal." }
        }
    },
    "Tenofovir": {
        nombre: "Tenofovir",
        laboratorio: "Gilead",
        precio: 85.00,
        contraindicaciones: ["Insuficiencia renal severa"],
        interacciones: {
            "Atazanavir": { severidad: "moderada", descripcion: "Aumenta las concentraciones de tenofovir, riesgo de nefrotoxicidad." }
        }
    },
    "Enalapril": {
        nombre: "Enalapril",
        laboratorio: "Novartis",
        precio: 10.50,
        contraindicaciones: ["Embarazo", "Angioedema previo a IECA"],
        interacciones: {
            "Espironolactona": { severidad: "moderada", descripcion: "Riesgo de hiperkalemia." }
        }
    },
    "Carvedilol": {
        nombre: "Carvedilol",
        laboratorio: "Abbott",
        precio: 14.70,
        contraindicaciones: ["Asma severa", "Bloqueo AV de 2do o 3er grado"],
        interacciones: {
            "Ranitidina": { severidad: "leve", descripcion: "Puede aumentar niveles de carvedilol." }
        }
    },
    "Espironolactona": {
        nombre: "Espironolactona",
        laboratorio: "Pfizer",
        precio: 16.20,
        contraindicaciones: ["Hiperkalemia", "Insuficiencia renal grave"],
        interacciones: {
            "Enalapril": { severidad: "moderada", descripcion: "Riesgo de hiperkalemia." },
            "AINEs": { severidad: "moderada", descripcion: "Puede aumentar el riesgo de hiperkalemia y reducir el efecto antihipertensivo." }
        }
    },
    "Furosemida": {
        nombre: "Furosemida",
        laboratorio: "Sanofi",
        precio: 9.80,
        contraindicaciones: ["Anuria", "Hipersensibilidad a diuréticos de asa"],
        interacciones: {
            "Losartán": { severidad: "moderada", descripcion: "Puede potenciar el efecto hipotensor." },
            "Aminoglucósidos": { severidad: "moderada", descripcion: "Riesgo de ototoxicidad y nefrotoxicidad." }
        }
    },
    "Tenofovir/Emtricitabina/Efavirenz": {
        nombre: "Tenofovir/Emtricitabina/Efavirenz",
        laboratorio: "Gilead",
        precio: 120.00,
        contraindicaciones: ["Insuficiencia renal", "Problemas hepáticos graves"],
        interacciones: {
            "Rifampicina": { severidad: "moderada", descripcion: "Puede disminuir la concentración de efavirenz." }
        }
    }
};

// --- Estado de la Aplicación ---
const APP_STATE = {
    activePatientId: null,
    currentSection: 'dashboard',
    filters: {
        patientSearch: '',
        specialty: '',
        staffSearch: '',
        staffRole: '',
        resourceSearch: '',
        resourceCategory: '',
        resourceType: '' // Para filtro por tipo de recurso
    },
    theme: 'light', // 'light' o 'dark'
    activeChart: 'pressure', // Para el selector de gráficos
    searchQuery: '',
    searchResults: [],
    currentImageIndex: 0,
    imageGallery: [],
    isModalOpen: false
};

// --- Utility Functions ---

// Helper para crear elementos DOM con clases y atributos
function createEl(tag, attributes = {}, children = []) {
    const el = document.createElement(tag);
    for (const key in attributes) {
        if (key.startsWith('on')) {
            el.addEventListener(key.substring(2).toLowerCase(), attributes[key]);
        } else {
            el.setAttribute(key, attributes[key]);
        }
    }
    children.forEach(child => {
        if (typeof child === 'string') {
            el.appendChild(document.createTextNode(child));
        } else {
            el.appendChild(child);
        }
    });
    return el;
}

// Helper para mostrar notificaciones más amigables que alert()
function showNotification(message, type = 'info') {
    const notificationContainer = document.getElementById('notification-container');
    if (!notificationContainer) return;

    const notifEl = createEl('div', {
        className: `notification notification-${type}`,
        textContent: message
    });
    notificationContainer.appendChild(notifEl);

    setTimeout(() => {
        notifEl.remove();
    }, 5000); // Duración de la notificación
}

// --- Gestión de Ventanas Modales ---
function showModal(title, contentHtml) {
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContent = document.getElementById('modal-content');
    
    if (!modalOverlay || !modalContent) return;

    modalContent.innerHTML = `
        <div class="modal-header">
            <h2><span class="material-symbols-outlined">${getIconForType(title.toLowerCase().includes('paciente') ? 'patient' : title.toLowerCase().includes('personal') ? 'staff' : title.toLowerCase().includes('recurso') ? 'resource' : 'info')}</span> ${title}</h2>
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            ${contentHtml}
        </div>
    `;
    modalOverlay.style.display = 'flex';
    document.body.classList.add('modal-open');
    APP_STATE.isModalOpen = true;

    // Activar la primera pestaña si existe
    const firstTabButton = modalContent.querySelector('.modal-tab');
    if (firstTabButton) firstTabButton.click();
}

function closeModal() {
    const modalOverlay = document.getElementById('modal-overlay');
    if (!modalOverlay) return;
    modalOverlay.style.display = 'none';
    document.body.classList.remove('modal-open');
    APP_STATE.isModalOpen = false;
    // Limpiar contenido para evitar que se acumulen listeners de modales previos
    document.getElementById('modal-content').innerHTML = ''; 
}

// Manejo de clics fuera del modal para cerrarlo
document.getElementById('modal-overlay')?.addEventListener('click', (e) => {
    if (e.target.id === 'modal-overlay') {
        closeModal();
    }
});

// Manejo de pestañas dentro de modales
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-tab')) {
        const tabId = e.target.getAttribute('data-tab');
        const modalContent = e.target.closest('.modal-content');
        
        modalContent.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
        modalContent.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
        
        e.target.classList.add('active');
        modalContent.querySelector(`.modal-tab-content[data-tab-pane="${tabId}"]`).classList.add('active');
    }
});

// --- Navegación ---
function setupNavigation() {
    document.querySelectorAll('nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('data-section');
            showPage(sectionId);
            
            // Actualizar clase activa en navegación
            document.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
        });
    });
}

function showPage(sectionId) {
    document.querySelectorAll('.page').forEach(section => {
        section.classList.remove('active');
    });
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        APP_STATE.currentSection = sectionId;
        
        // Cargar gráficos si se accede a la sección del dashboard
        if (sectionId === 'dashboard' && typeof Chart !== 'undefined' && !window.vitalSignsChart) {
            showVitalSignsChart();
        }
    }
}

function getIconForType(type) {
    switch(type) {
        case 'patient': return 'person';
        case 'staff': return 'medical_services';
        case 'resource': return 'article';
        case 'disease': return 'medical_information';
        case 'treatment': return 'medication';
        case 'protocol': return 'description';
        case 'drug': return 'science';
        case 'test': return 'lab_result';
        case 'procedure': return 'medical_examination';
        case 'dashboard': return 'dashboard';
        case 'pacientes': return 'people';
        case 'personal': return 'groups';
        case 'signos vitales': return 'monitor_heart';
        case 'recetas': return 'medication';
        case 'educacion': return 'school';
        case 'calculadoras': return 'calculate';
        case 'historias clínicas': return 'history';
        case 'configuración': return 'settings';
        default: return 'info';
    }
}

// --- Inicialización General ---
function initializeApp() {
    // Cargar estado inicial
    showPage('dashboard'); // Mostrar dashboard al inicio
    document.querySelector('nav a[data-section="dashboard"]')?.classList.add('active');
    
    // Configurar elementos de la UI
    setupNavigation();
    setupThemeToggle();
    setupModals();
    setupConsultorioVirtual();
    
    // Cargar datos iniciales en selectores y grillas
    loadPatientsIntoSelectors();
    renderPatientGrid();
    renderStaffGrid();
    renderResourceGrid();
    
    // Configurar filtros y buscadores
    loadSpecialties();
    loadRoles();
    loadCategories();
    setupPatientFilters();
    setupStaffFilters();
    setupResourceFilters();
    
    // Configurar otras secciones específicas
    setupCalculators();
    setupVitalSigns();
    setupPrescriptions();
    
    // Configurar menú usuario
    setupUserProfile();
    
    // Configurar botón de refresh de gráfico
    document.getElementById('refresh-chart')?.addEventListener('click', refreshChart);
    
    // Configurar botón de ejemplo de búsqueda
    document.getElementById('example-search-btn')?.addEventListener('click', showExampleSearch);
}

// --- Gestión de Usuario ---
function setupUserProfile() {
    const userProfileContainer = document.querySelector('.user-profile');
    if (userProfileContainer) {
        userProfileContainer.innerHTML = `
            <img src="${currentUser.avatar}" alt="Avatar de ${currentUser.nombre}" class="avatar">
            <span>${currentUser.nombre}</span>
            <button class="btn btn-transparent dropdown-toggle" id="user-menu-toggle">
                <span class="material-symbols-outlined">arrow_drop_down</span>
            </button>
            <div class="user-menu" id="user-menu">
                <a href="#"><span class="material-symbols-outlined">person</span> Mi Perfil</a>
                <a href="#"><span class="material-symbols-outlined">settings</span> Configuración</a>
                <a href="#"><span class="material-symbols-outlined">logout</span> Cerrar Sesión</a>
            </div>
        `;
        
        const menuToggle = document.getElementById('user-menu-toggle');
        const userMenu = document.getElementById('user-menu');
        
        menuToggle?.addEventListener('click', () => {
            userMenu.classList.toggle('show');
        });
        
        document.addEventListener('click', (e) => {
            if (!menuToggle.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });
    }
}

// --- Gestión de Pacientes ---
function loadPatientsIntoSelectors() {
    const selectors = [
        document.getElementById('active-patient'),
        document.getElementById('vitals-patient'),
        document.getElementById('recipe-patient')
    ];
    
    selectors.forEach(selector => {
        if (selector) {
            selector.innerHTML = '<option value="">Selecciona un paciente...</option>';
            simulatedPatients.forEach(patient => {
                const option = createEl('option', { value: patient.id }, [`${patient.nombre} (${patient.diagnosticoPrincipal})`]);
                selector.appendChild(option);
            });
        }
    });
}

function renderPatientGrid() {
    const grid = document.getElementById('patient-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    simulatedPatients.forEach(patient => {
        const riskClass = `risk-${patient.riesgoCardiovascular || 'low'}`;
        const riskText = patient.riesgoCardiovascular === 'alto' ? 'Alto riesgo cardiovascular' : 
                        patient.riesgoCardiovascular === 'moderado' ? 'Riesgo moderado' : 'Riesgo bajo';
        
        const card = createEl('div', { className: 'patient-card' }, [
            createEl('h3', {}, [patient.nombre]),
            createEl('p', {}, ['Edad: ', patient.edad]),
            createEl('p', {}, ['Diagnóstico Principal: ', patient.diagnosticoPrincipal]),
            createEl('p', {}, ['Especialidad: ', patient.especialidad]),
            createEl('span', { className: `patient-risk ${riskClass}` }, [riskText]),
            createEl('div', { className: 'patient-actions' }, [
                createEl('button', { className: 'btn btn-secondary btn-edit-patient', 'data-patient-id': patient.id, onclick: () => handleEditPatient(patient.id) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                ]),
                createEl('button', { className: 'btn btn-warning btn-delete-patient', 'data-patient-id': patient.id, onclick: () => handleConfirmDeletePatient(patient) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                ])
            ]),
            createEl('button', { className: 'btn btn-primary btn-view-history', 'data-patient-id': patient.id, onclick: () => handleViewHistory(patient.id) }, [
                createEl('span', { className: 'material-symbols-outlined' }, ['history']), 'Ver Historia Completa'
            ])
        ]);
        grid.appendChild(card);
    });
}

function handleViewHistory(patientId) {
    const patient = simulatedPatients.find(p => p.id === patientId);
    if (patient) {
        showModal('Historia Clínica', generateHistoryModalContent(patient));
    }
}

function handleEditPatient(patientId) {
    const patient = simulatedPatients.find(p => p.id === patientId);
    if (patient) {
        showModal('Editar Paciente', generateEditPatientModalContent(patient));
    }
}

function handleConfirmDeletePatient(patient) {
    const confirmModalContent = `
        <div class="modal-tab-content active">
            <p><strong>¿Está seguro de que desea eliminar al paciente ${patient.nombre}?</strong></p>
            <p>Esta acción no se puede deshacer y eliminará todos los registros clínicos asociados a este paciente.</p>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDeletePatient(${patient.id})">Eliminar</button>
            </div>
        </div>
    `;
    showModal('Confirmar Eliminación', confirmModalContent);
}

function confirmDeletePatient(patientId) {
    const index = simulatedPatients.findIndex(p => p.id === patientId);
    if (index !== -1) {
        simulatedPatients.splice(index, 1);
        closeModal();
        renderPatientGrid();
        loadPatientsIntoSelectors();
        showNotification(`Paciente ${patient.nombre} eliminado correctamente.`, 'success');
    }
}

function savePatientChanges(patientId) {
    const nombre = document.getElementById('edit-patient-nombre').value;
    const edad = parseInt(document.getElementById('edit-patient-edad').value);
    const diagnostico = document.getElementById('edit-patient-diagnostico').value;
    const especialidad = document.getElementById('edit-patient-especialidad').value;
    const alergiasInput = document.getElementById('edit-patient-alergias').value;
    const alergias = alergiasInput ? alergiasInput.split(',').map(a => a.trim()).filter(a => a !== '') : [];
    const riesgo = document.getElementById('edit-patient-riesgo').value;
    
    if (!nombre || isNaN(edad) || !diagnostico || !especialidad) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'error');
        return;
    }
    
    const patientIndex = simulatedPatients.findIndex(p => p.id === patientId);
    if (patientIndex !== -1) {
        simulatedPatients[patientIndex] = {
            ...simulatedPatients[patientIndex],
            nombre,
            edad,
            diagnosticoPrincipal: diagnostico,
            especialidad,
            alergias,
            riesgoCardiovascular: riesgo
        };
        
        closeModal();
        renderPatientGrid();
        loadPatientsIntoSelectors();
        showNotification('Paciente actualizado correctamente.', 'success');
    }
}

// --- Gestión de Personal ---
function renderStaffGrid() {
    const grid = document.getElementById('staff-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    medicalStaff.forEach(staff => {
        const card = createEl('div', { className: 'patient-card' }, [
            createEl('div', { style: "display: flex; align-items: center; gap: 10px; margin-bottom: 15px;" }, [
                createEl('img', { src: staff.avatar, alt: staff.nombre, style: "width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary-blue);" }),
                createEl('div', {}, [
                    createEl('h3', {}, [staff.nombre]),
                    createEl('p', {}, ['Rol: ', staff.rol]),
                    createEl('p', {}, ['Especialidad: ', staff.especialidad])
                ])
            ]),
            createEl('div', { className: 'staff-actions' }, [
                createEl('button', { className: 'btn btn-secondary btn-edit-staff', 'data-staff-id': staff.id, onclick: () => handleEditStaff(staff.id) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                ]),
                createEl('button', { className: 'btn btn-warning btn-delete-staff', 'data-staff-id': staff.id, onclick: () => handleConfirmDeleteStaff(staff) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                ])
            ]),
            createEl('button', { className: 'btn btn-primary btn-view-staff', 'data-staff-id': staff.id, onclick: () => handleViewStaff(staff.id) }, [
                createEl('span', { className: 'material-symbols-outlined' }, ['person']), 'Ver Perfil'
            ])
        ]);
        grid.appendChild(card);
    });
}

function handleViewStaff(staffId) {
    const staff = medicalStaff.find(s => s.id === staffId);
    if (staff) {
        showModal('Perfil del Personal', generateStaffProfileModalContent(staff));
    }
}

function handleEditStaff(staffId) {
    const staff = medicalStaff.find(s => s.id === staffId);
    if (staff) {
        showModal('Editar Personal', generateEditStaffModalContent(staff));
    }
}

function handleConfirmDeleteStaff(staff) {
    const confirmModalContent = `
        <div class="modal-tab-content active">
            <p><strong>¿Está seguro de que desea eliminar al miembro del personal ${staff.nombre}?</strong></p>
            <p>Esta acción no se puede deshacer y eliminará todos los registros asociados a este miembro.</p>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDeleteStaff(${staff.id})">Eliminar</button>
            </div>
        </div>
    `;
    showModal('Confirmar Eliminación', confirmModalContent);
}

function confirmDeleteStaff(staffId) {
    const index = medicalStaff.findIndex(s => s.id === staffId);
    if (index !== -1) {
        const staffName = medicalStaff[index].nombre; // Obtener nombre antes de eliminar
        medicalStaff.splice(index, 1);
        closeModal();
        renderStaffGrid();
        showNotification(`Miembro del personal ${staffName} eliminado correctamente.`, 'success');
    }
}

function generateStaffProfileModalContent(staff) {
    return `
        <div class="modal-tab-content active">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="${staff.avatar}" alt="${staff.nombre}" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-blue);">
            </div>
            <p><strong>Rol:</strong> ${staff.rol}</p>
            <p><strong>Especialidad:</strong> ${staff.especialidad}</p>
            <p><strong>Contacto:</strong> ${staff.contacto.telefono} / ${staff.contacto.email}</p>
            <p><strong>Biografía:</strong> ${staff.bio}</p>
            <p><strong>Citas programadas:</strong> ${staff.citas}</p>
        </div>
    `;
}

function generateEditStaffModalContent(staff) {
    return `
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-staff-nombre">Nombre</label>
                    <input type="text" id="edit-staff-nombre" value="${staff.nombre}" required>
                </div>
                <div class="form-group">
                    <label for="edit-staff-rol">Rol</label>
                    <select id="edit-staff-rol">
                        <option value="Médico" ${staff.rol === 'Médico' ? 'selected' : ''}>Médico</option>
                        <option value="Enfermero" ${staff.rol === 'Enfermero' ? 'selected' : ''}>Enfermero</option>
                        <option value="Administrador" ${staff.rol === 'Administrador' ? 'selected' : ''}>Administrador</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-staff-especialidad">Especialidad</label>
                    <input type="text" id="edit-staff-especialidad" value="${staff.especialidad}" required>
                </div>
                <div class="form-group">
                    <label for="edit-staff-telefono">Teléfono</label>
                    <input type="text" id="edit-staff-telefono" value="${staff.contacto.telefono}" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-staff-email">Email</label>
                <input type="email" id="edit-staff-email" value="${staff.contacto.email}" required>
            </div>
            <div class="form-group">
                <label for="edit-staff-bio">Biografía</label>
                <textarea id="edit-staff-bio" rows="3">${staff.bio}</textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveStaffChanges(${staff.id})">Guardar Cambios</button>
            </div>
        </div>
    `;
}

function saveStaffChanges(staffId) {
    const nombre = document.getElementById('edit-staff-nombre').value;
    const rol = document.getElementById('edit-staff-rol').value;
    const especialidad = document.getElementById('edit-staff-especialidad').value;
    const telefono = document.getElementById('edit-staff-telefono').value;
    const email = document.getElementById('edit-staff-email').value;
    const bio = document.getElementById('edit-staff-bio').value;
    
    if (!nombre || !rol || !especialidad || !telefono || !email) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'error');
        return;
    }
    
    const staffIndex = medicalStaff.findIndex(s => s.id === staffId);
    if (staffIndex !== -1) {
        medicalStaff[staffIndex] = {
            ...medicalStaff[staffIndex],
            nombre,
            rol,
            especialidad,
            contacto: {
                telefono,
                email
            },
            bio
        };
        
        closeModal();
        renderStaffGrid();
        showNotification('Personal actualizado correctamente.', 'success');
    }
}

// --- Gestión de Recursos Educativos ---
function renderResourceGrid() {
    const grid = document.getElementById('resource-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    educationalResources.forEach(resource => {
        const card = createEl('div', { className: 'resource-card' }, [
            createEl('div', { style: "text-align: center; margin-bottom: 15px;" }, [
                createEl('img', { src: resource.url, alt: resource.titulo, style: "max-width: 100%; height: auto; border-radius: var(--border-radius);" })
            ]),
            createEl('h3', {}, [resource.titulo]),
            createEl('p', {}, ['Tipo: ', resource.tipo]),
            createEl('p', {}, ['Categoría: ', resource.categoria]),
            createEl('p', {}, [resource.descripcion]),
            createEl('div', { className: 'resource-actions' }, [
                createEl('button', { className: 'btn btn-secondary btn-edit-resource', 'data-resource-id': resource.id, onclick: () => handleEditResource(resource.id) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                ]),
                createEl('button', { className: 'btn btn-warning btn-delete-resource', 'data-resource-id': resource.id, onclick: () => handleConfirmDeleteResource(resource) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                ])
            ]),
            createEl('button', { className: 'btn btn-primary btn-view-resource', 'data-resource-id': resource.id, onclick: () => handleViewResource(resource.id) }, [
                createEl('span', { className: 'material-symbols-outlined' }, ['visibility']), 'Ver Recurso'
            ])
        ]);
        grid.appendChild(card);
    });
}

function handleViewResource(resourceId) {
    const resource = educationalResources.find(r => r.id === resourceId);
    if (resource) {
        showModal('Recurso Educativo', generateResourceModalContent(resource));
    }
}

function handleEditResource(resourceId) {
    const resource = educationalResources.find(r => r.id === resourceId);
    if (resource) {
        showModal('Editar Recurso', generateEditResourceModalContent(resource));
    }
}

function handleConfirmDeleteResource(resource) {
    const confirmModalContent = `
        <div class="modal-tab-content active">
            <p><strong>¿Está seguro de que desea eliminar el recurso "${resource.titulo}"?</strong></p>
            <p>Esta acción no se puede deshacer y eliminará este recurso educativo del sistema.</p>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDeleteResource(${resource.id})">Eliminar</button>
            </div>
        </div>
    `;
    showModal('Confirmar Eliminación', confirmModalContent);
}

function confirmDeleteResource(resourceId) {
    const index = educationalResources.findIndex(r => r.id === resourceId);
    if (index !== -1) {
        const resourceTitle = educationalResources[index].titulo;
        educationalResources.splice(index, 1);
        closeModal();
        renderResourceGrid();
        showNotification(`Recurso educativo "${resourceTitle}" eliminado correctamente.`, 'success');
    }
}

function generateResourceModalContent(resource) {
    let content = `
        <div class="modal-tab-content active">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="${resource.url}" alt="${resource.titulo}" style="max-width: 100%; height: auto; border-radius: var(--border-radius);">
            </div>
            <p><strong>Tipo:</strong> ${resource.tipo}</p>
            <p><strong>Categoría:</strong> ${resource.categoria}</p>
            <p><strong>Etiquetas:</strong> ${resource.etiquetas.join(', ')}</p>
            <p><strong>Descripción:</strong> ${resource.descripcion}</p>
    `;
    
    // Si es un video, incluir iframe (simulado)
    if (resource.tipo === 'video' && resource.url.includes('youtube.com')) {
        content += `<div style="margin-top: 15px;">
                        <iframe width="100%" height="315" src="${resource.url}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>`;
    }
    
    content += `</div>`;
    return content;
}

function generateEditResourceModalContent(resource) {
    return `
        <div class="form-container">
            <div class="form-group">
                <label for="edit-resource-titulo">Título</label>
                <input type="text" id="edit-resource-titulo" value="${resource.titulo}" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-resource-tipo">Tipo</label>
                    <select id="edit-resource-tipo">
                        <option value="imagen" ${resource.tipo === 'imagen' ? 'selected' : ''}>Imagen</option>
                        <option value="video" ${resource.tipo === 'video' ? 'selected' : ''}>Video</option>
                        <option value="documento" ${resource.tipo === 'documento' ? 'selected' : ''}>Documento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-resource-categoria">Categoría</label>
                    <select id="edit-resource-categoria">
                        <option value="curacion" ${resource.categoria === 'curacion' ? 'selected' : ''}>Curación</option>
                        <option value="anatomia" ${resource.categoria === 'anatomia' ? 'selected' : ''}>Anatomía</option>
                        <option value="protocolo" ${resource.categoria === 'protocolo' ? 'selected' : ''}>Protocolo</option>
                        <option value="educacion" ${resource.categoria === 'educacion' ? 'selected' : ''}>Educación</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-resource-url">URL</label>
                <input type="text" id="edit-resource-url" value="${resource.url}" required placeholder="https://ejemplo.com/recurso">
            </div>
            <div class="form-group">
                <label for="edit-resource-etiquetas">Etiquetas (separadas por comas)</label>
                <input type="text" id="edit-resource-etiquetas" value="${resource.etiquetas.join(', ')}">
            </div>
            <div class="form-group">
                <label for="edit-resource-descripcion">Descripción</label>
                <textarea id="edit-resource-descripcion" rows="3">${resource.descripcion}</textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveResourceChanges(${resource.id})">Guardar Cambios</button>
            </div>
        </div>
    `;
}

function saveResourceChanges(resourceId) {
    const titulo = document.getElementById('edit-resource-titulo').value;
    const tipo = document.getElementById('edit-resource-tipo').value;
    const categoria = document.getElementById('edit-resource-categoria').value;
    const url = document.getElementById('edit-resource-url').value;
    const etiquetasInput = document.getElementById('edit-resource-etiquetas').value;
    const etiquetas = etiquetasInput ? etiquetasInput.split(',').map(e => e.trim()).filter(e => e !== '') : [];
    const descripcion = document.getElementById('edit-resource-descripcion').value;
    
    if (!titulo || !tipo || !categoria || !url) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'error');
        return;
    }
    
    const resourceIndex = educationalResources.findIndex(r => r.id === resourceId);
    if (resourceIndex !== -1) {
        educationalResources[resourceIndex] = {
            ...educationalResources[resourceIndex],
            titulo,
            tipo,
            categoria,
            url,
            etiquetas,
            descripcion
        };
        
        closeModal();
        renderResourceGrid();
        showNotification('Recurso educativo actualizado correctamente.', 'success');
    }
}

// --- Filtros y Búsquedas ---
function setupPatientFilters() {
    const searchInput = document.getElementById('patient-search');
    const specialtyFilter = document.getElementById('specialty-filter');
    
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedSpecialty = specialtyFilter.value.toLowerCase();
        
        const grid = document.getElementById('patient-grid');
        grid.innerHTML = '';
        
        simulatedPatients
            .filter(patient => {
                const matchesSearch = patient.nombre.toLowerCase().includes(searchTerm) ||
                                      patient.diagnosticoPrincipal.toLowerCase().includes(searchTerm) ||
                                      patient.especialidad.toLowerCase().includes(searchTerm);
                const matchesSpecialty = selectedSpecialty === '' || patient.especialidad.toLowerCase() === selectedSpecialty;
                return matchesSearch && matchesSpecialty;
            })
            .forEach(patient => {
                const card = createEl('div', { className: 'patient-card' }, [
                    createEl('h3', {}, [patient.nombre]),
                    createEl('p', {}, ['Edad: ', patient.edad]),
                    createEl('p', {}, ['Diagnóstico Principal: ', patient.diagnosticoPrincipal]),
                    createEl('p', {}, ['Especialidad: ', patient.especialidad]),
                    createEl('span', { className: `patient-risk risk-${patient.riesgoCardiovascular || 'low'}` }, [
                        patient.riesgoCardiovascular === 'alto' ? 'Alto riesgo cardiovascular' : 
                        patient.riesgoCardiovascular === 'moderado' ? 'Riesgo moderado' : 'Riesgo bajo'
                    ]),
                    createEl('div', { className: 'patient-actions' }, [
                        createEl('button', { className: 'btn btn-secondary btn-edit-patient', 'data-patient-id': patient.id, onclick: () => handleEditPatient(patient.id) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                        ]),
                        createEl('button', { className: 'btn btn-warning btn-delete-patient', 'data-patient-id': patient.id, onclick: () => handleConfirmDeletePatient(patient) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                        ])
                    ]),
                    createEl('button', { className: 'btn btn-primary btn-view-history', 'data-patient-id': patient.id, onclick: () => handleViewHistory(patient.id) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['history']), 'Ver Historia Completa'
                    ])
                ]);
                grid.appendChild(card);
            });
    }
    
    searchInput?.addEventListener('input', applyFilters);
    specialtyFilter?.addEventListener('change', applyFilters);
    applyFilters(); // Aplicar filtros iniciales
}

function loadSpecialties() {
    const filterSelect = document.getElementById('specialty-filter');
    if (!filterSelect) return;
    
    // Limpiar opciones existentes excepto la primera (placeholder)
    filterSelect.innerHTML = '<option value="">Filtrar por especialidad...</option>';
    const specialties = [...new Set(simulatedPatients.map(p => p.especialidad))].sort();
    
    specialties.forEach(specialty => {
        const option = createEl('option', { value: specialty }, [specialty]);
        filterSelect.appendChild(option);
    });
}

function setupStaffFilters() {
    const searchInput = document.getElementById('staff-search');
    const roleFilter = document.getElementById('role-filter');
    
    function applyStaffFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedRole = roleFilter.value.toLowerCase();
        
        const grid = document.getElementById('staff-grid');
        if (!grid) return;
        grid.innerHTML = '';
        
        medicalStaff
            .filter(staff => {
                const matchesSearch = staff.nombre.toLowerCase().includes(searchTerm) ||
                                     staff.especialidad.toLowerCase().includes(searchTerm) ||
                                     staff.rol.toLowerCase().includes(searchTerm);
                const matchesRole = selectedRole === '' || staff.rol.toLowerCase() === selectedRole;
                return matchesSearch && matchesRole;
            })
            .forEach(staff => {
                const card = createEl('div', { className: 'patient-card' }, [
                    createEl('div', { style: "display: flex; align-items: center; gap: 10px; margin-bottom: 15px;" }, [
                        createEl('img', { src: staff.avatar, alt: staff.nombre, style: "width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary-blue);" }),
                        createEl('div', {}, [
                            createEl('h3', {}, [staff.nombre]),
                            createEl('p', {}, ['Rol: ', staff.rol]),
                            createEl('p', {}, ['Especialidad: ', staff.especialidad])
                        ])
                    ]),
                    createEl('div', { className: 'staff-actions' }, [
                        createEl('button', { className: 'btn btn-secondary btn-edit-staff', 'data-staff-id': staff.id, onclick: () => handleEditStaff(staff.id) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                        ]),
                        createEl('button', { className: 'btn btn-warning btn-delete-staff', 'data-staff-id': staff.id, onclick: () => handleConfirmDeleteStaff(staff) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                        ])
                    ]),
                    createEl('button', { className: 'btn btn-primary btn-view-staff', 'data-staff-id': staff.id, onclick: () => handleViewStaff(staff.id) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['person']), 'Ver Perfil'
                    ])
                ]);
                grid.appendChild(card);
            });
    }
    
    searchInput?.addEventListener('input', applyStaffFilters);
    roleFilter?.addEventListener('change', applyStaffFilters);
    applyStaffFilters(); // Aplicar filtros iniciales
}

function loadRoles() {
    const filterSelect = document.getElementById('role-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por rol...</option>';
    const roles = [...new Set(medicalStaff.map(s => s.rol))].sort();
    
    roles.forEach(rol => {
        const option = createEl('option', { value: rol }, [rol]);
        filterSelect.appendChild(option);
    });
}

function setupResourceFilters() {
    const searchInput = document.getElementById('resource-search');
    const categoryFilter = document.getElementById('category-filter');
    const typeFilter = document.getElementById('type-filter'); // Nuevo filtro por tipo
    const resourceTabs = document.querySelectorAll('.resource-tab');
    
    function applyResourceFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedCategory = categoryFilter.value.toLowerCase();
        const selectedType = typeFilter.value.toLowerCase(); // Obtener valor del nuevo filtro
        
        const grid = document.getElementById('resource-grid');
        if (!grid) return;
        grid.innerHTML = '';
        
        educationalResources
            .filter(resource => {
                const matchesSearch = resource.titulo.toLowerCase().includes(searchTerm) ||
                                     resource.descripcion.toLowerCase().includes(searchTerm) ||
                                     resource.etiquetas.some(tag => tag.toLowerCase().includes(searchTerm));
                const matchesCategory = selectedCategory === '' || resource.categoria.toLowerCase() === selectedCategory;
                const matchesType = selectedType === '' || resource.tipo.toLowerCase() === selectedType;
                return matchesSearch && matchesCategory && matchesType;
            })
            .forEach(resource => {
                const card = createEl('div', { className: 'resource-card' }, [
                    createEl('div', { style: "text-align: center; margin-bottom: 15px;" }, [
                        createEl('img', { src: resource.url, alt: resource.titulo, style: "max-width: 100%; height: auto; border-radius: var(--border-radius);" })
                    ]),
                    createEl('h3', {}, [resource.titulo]),
                    createEl('p', {}, ['Tipo: ', resource.tipo]),
                    createEl('p', {}, ['Categoría: ', resource.categoria]),
                    createEl('p', {}, [resource.descripcion]),
                    createEl('div', { className: 'resource-actions' }, [
                        createEl('button', { className: 'btn btn-secondary btn-edit-resource', 'data-resource-id': resource.id, onclick: () => handleEditResource(resource.id) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['edit']), 'Editar'
                        ]),
                        createEl('button', { className: 'btn btn-warning btn-delete-resource', 'data-resource-id': resource.id, onclick: () => handleConfirmDeleteResource(resource) }, [
                            createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
                        ])
                    ]),
                    createEl('button', { className: 'btn btn-primary btn-view-resource', 'data-resource-id': resource.id, onclick: () => handleViewResource(resource.id) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['visibility']), 'Ver Recurso'
                    ])
                ]);
                grid.appendChild(card);
            });
    }
    
    searchInput?.addEventListener('input', applyResourceFilters);
    categoryFilter?.addEventListener('change', applyResourceFilters);
    typeFilter?.addEventListener('change', applyResourceFilters); // Listener para el nuevo filtro
    
    // Event listeners para las pestañas de recursos
    resourceTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            resourceTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            applyResourceFilters();
        });
    });
    
    applyResourceFilters(); // Aplicar filtros iniciales
}

function loadCategories() {
    const filterSelect = document.getElementById('category-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por categoría...</option>';
    const categories = [...new Set(educationalResources.map(r => r.categoria))].sort();
    
    categories.forEach(category => {
        const option = createEl('option', { value: category }, [category]);
        filterSelect.appendChild(option);
    });
}

// Función para cargar tipos de recursos en el filtro
function loadResourceTypes() {
    const filterSelect = document.getElementById('type-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por tipo...</option>';
    const types = [...new Set(educationalResources.map(r => r.tipo))].sort();
    
    types.forEach(type => {
        const option = createEl('option', { value: type }, [type]);
        filterSelect.appendChild(option);
    });
}

// --- Tema ---
function setupThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const icon = themeToggle?.querySelector('.material-symbols-outlined');
    const body = document.body;
    
    if (!themeToggle || !icon || !body) return;
    
    // Cargar tema guardado (si hubiera) o aplicar el default
    body.classList.add(`theme-${APP_STATE.theme}`);
    icon.textContent = APP_STATE.theme === 'light' ? 'dark_mode' : 'light_mode';
    
    themeToggle.addEventListener('click', () => {
        if (body.classList.contains('theme-light')) {
            body.classList.remove('theme-light');
            body.classList.add('theme-dark');
            icon.textContent = 'light_mode';
            APP_STATE.theme = 'dark';
        } else {
            body.classList.remove('theme-dark');
            body.classList.add('theme-light');
            icon.textContent = 'dark_mode';
            APP_STATE.theme = 'light';
        }
    });
}

// --- Gráficos ---
function showVitalSignsChart() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no está cargado, no se puede inicializar el gráfico.');
        return;
    }
    
    const chartData = {
        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
        datasets: [{
            label: 'Presión Arterial Sistólica',
            data: [130, 128, 125, 122, 120, 118],
            borderColor: '#1a73e8',
            backgroundColor: 'rgba(26, 115, 232, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#1a73e8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'Presión Arterial Diastólica',
            data: [85, 84, 82, 80, 79, 78],
            borderColor: '#34a853',
            backgroundColor: 'rgba(52, 168, 83, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#34a853',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    };
    
    const ctx = document.getElementById('vitalSignsChart');
    if (!ctx) return;

    window.vitalSignsChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Evolución de Signos Vitales' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                x: { grid: { color: 'rgba(0, 0, 0, 0.1)' } }
            }
        }
    });
    
    // Actualizar gráfico según selector
    document.getElementById('chart-type-selector')?.addEventListener('change', (e) => {
        const type = e.target.value;
        updateVitalSignsChart(type);
    });
}

function updateVitalSignsChart(type) {
    const chart = window.vitalSignsChart;
    if (!chart) return;
    
    let newData;
    
    switch(type) {
        case 'heartRate':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Frecuencia Cardíaca', data: [75, 74, 73, 72, 71, 70], borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#1a73e8', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        case 'temperature':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Temperatura', data: [36.8, 36.7, 36.6, 36.7, 36.6, 36.5], borderColor: '#f9ab00', backgroundColor: 'rgba(249, 171, 0, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#f9ab00', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        case 'spo2':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Saturación O2', data: [98, 98, 99, 99, 99, 98], borderColor: '#34a853', backgroundColor: 'rgba(52, 168, 83, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#34a853', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        default: // pressure (default)
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{
                    label: 'Presión Arterial Sistólica', data: [130, 128, 125, 122, 120, 118], borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#1a73e8', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4
                }, {
                    label: 'Presión Arterial Diastólica', data: [85, 84, 82, 80, 79, 78], borderColor: '#34a853', backgroundColor: 'rgba(52, 168, 83, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#34a853', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4
                }]
            };
    }
    
    chart.data = newData;
    chart.update();
    APP_STATE.activeChart = type;
}

function refreshChart() {
    if (window.vitalSignsChart) {
        updateVitalSignsChart(APP_STATE.activeChart);
        showNotification('Gráfico actualizado con los últimos datos.', 'success');
    } else {
        showNotification('El gráfico aún no ha sido inicializado.', 'warning');
    }
}

function setupVitalsHistoryChart() {
    const chartData = {
        labels: ['2023-01-15', '2023-03-20', '2023-06-20'],
        datasets: [{
            label: 'Presión Arterial Sistólica',
            data: [130, 125, 120],
            borderColor: '#1a73e8',
            backgroundColor: 'rgba(26, 115, 232, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#1a73e8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'Presión Arterial Diastólica',
            data: [85, 82, 80],
            borderColor: '#34a853',
            backgroundColor: 'rgba(52, 168, 83, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#34a853',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    };
    
    const ctx = document.getElementById('vitalsHistoryChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Historial de Presión Arterial' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                x: { grid: { color: 'rgba(0, 0, 0, 0.1)' } }
            }
        }
    });
}

// --- Calculadoras Médicas ---
function setupCalculators() {
    // Selector de calculadoras
    document.getElementById('calc-selector')?.addEventListener('change', (e) => {
        const calculatorId = e.target.value + '-calculator';
        document.querySelectorAll('.calculator-form').forEach(form => {
            form.style.display = 'none';
        });
        const targetForm = document.getElementById(calculatorId);
        if (targetForm) {
            targetForm.style.display = 'block';
            // Podría ser útil pre-llenar datos del paciente activo aquí si estuviera seleccionado
        }
    });

    // Calculadora de IMC
    document.getElementById('calculate-imc')?.addEventListener('click', () => {
        const weightInput = document.getElementById('imc-weight');
        const heightInput = document.getElementById('imc-height');
        const weight = parseFloat(weightInput.value);
        const heightCm = parseFloat(heightInput.value);
        
        if (weight > 0 && heightCm > 0) {
            const heightM = heightCm / 100;
            const imc = weight / (heightM * heightM);
            const imcValue = imc.toFixed(2);
            
            let classification = '';
            let recommendations = '';
            
            if (imc < 18.5) {
                classification = 'Bajo peso';
                recommendations = 'Considerar evaluación nutricional y aumento de ingesta calórica.';
            } else if (imc < 25) {
                classification = 'Peso normal';
                recommendations = 'Mantener estilo de vida saludable con dieta equilibrada y ejercicio regular.';
            } else if (imc < 30) {
                classification = 'Sobrepeso';
                recommendations = 'Recomendar dieta hipocalórica y ejercicio físico regular. Evaluar factores de riesgo cardiovascular.';
            } else if (imc < 35) {
                classification = 'Obesidad grado I';
                recommendations = 'Intervención nutricional intensiva. Considerar tratamiento farmacológico si hay comorbilidades.';
            } else if (imc < 40) {
                classification = 'Obesidad grado II';
                recommendations = 'Tratamiento multidisciplinario. Evaluar candidatura a cirugía bariátrica.';
            } else {
                classification = 'Obesidad grado III (mórbida)';
                recommendations = 'Evaluación urgente para tratamiento multidisciplinario y cirugía bariátrica.';
            }
            
            document.getElementById('imc-value').textContent = imcValue;
            document.getElementById('imc-classification').textContent = classification;
            document.getElementById('imc-recommendations').textContent = recommendations;
            document.getElementById('imc-result').style.display = 'block';
        } else {
            showNotification('Por favor, ingrese valores válidos de peso y talla.', 'warning');
        }
    });

    // Calculadora de Filtrado Glomerular (CKD-EPI)
    document.getElementById('calculate-filtration')?.addEventListener('click', () => {
        const creatinineInput = document.getElementById('creatinine');
        const ageInput = document.getElementById('age');
        const genderInputs = document.querySelectorAll('input[name="gender"]');
        
        const creatinine = parseFloat(creatinineInput.value);
        const age = parseInt(ageInput.value);
        let gender = '';
        genderInputs.forEach(input => { if (input.checked) gender = input.value; });
        
        if (creatinine > 0 && age > 0 && gender) {
            // Fórmula CKD-EPI
            let k, a, sex_factor;
            if (gender === 'female') {
                k = 0.7;
                a = creatinine <= 0.7 ? -0.241 : -1.2;
                sex_factor = 1.018;
            } else { // male
                k = 0.9;
                a = creatinine <= 0.9 ? -0.302 : -1.2;
                sex_factor = 1;
            }
            
            const egfr = 141 * Math.pow(Math.min(creatinine/k, 1), a) * 
                         Math.pow(Math.max(creatinine/k, 1), -1.209) * 
                         Math.pow(0.993, age) * sex_factor;
            
            const egfrValue = Math.round(egfr);
            
            let stage = '';
            let recommendations = '';
            
            if (egfrValue >= 90) {
                stage = 'Estadio 1: Daño renal con filtrado normal (eGFR ≥ 90)';
                recommendations = 'Control anual de función renal. Mantener factores de riesgo bajo control.';
            } else if (egfrValue >= 60) {
                stage = 'Estadio 2: Daño renal con filtrado ligeramente disminuido (eGFR 60-89)';
                recommendations = 'Control cada 6-12 meses. Evaluar causa de daño renal.';
            } else if (egfrValue >= 30) {
                stage = 'Estadio 3: Filtrado moderadamente disminuido (eGFR 30-59)';
                recommendations = 'Control cada 3-6 meses. Referir a nefrología. Evitar nefrotóxicos.';
            } else if (egfrValue >= 15) {
                stage = 'Estadio 4: Filtrado severamente disminuido (eGFR 15-29)';
                recommendations = 'Control cada 1-3 meses. Preparar para terapia de reemplazo renal.';
            } else {
                stage = 'Estadio 5: Insuficiencia renal (eGFR <15)';
                recommendations = 'Iniciar plan de terapia de reemplazo renal (diálisis o trasplante).';
            }
            
            document.getElementById('filtration-value').textContent = egfrValue;
            document.getElementById('filtration-stage').textContent = stage;
            document.getElementById('filtration-recommendations').textContent = recommendations;
            document.getElementById('filtration-result').style.display = 'block';
        } else {
            showNotification('Por favor, ingrese valores válidos de creatinina, edad y género.', 'warning');
        }
    });

    // Calculadora Child-Pugh
    document.getElementById('calculate-child-pugh')?.addEventListener('click', () => {
        const ascitesInput = document.getElementById('ascites');
        const encephalopathyInput = document.getElementById('encephalopathy');
        const bilirubinInput = document.getElementById('bilirubin');
        const albuminInput = document.getElementById('albumin');
        const inrInput = document.getElementById('inr');
        
        const ascites = parseInt(ascitesInput.value);
        const encephalopathy = parseInt(encephalopathyInput.value);
        const bilirubin = parseFloat(bilirubinInput.value);
        const albumin = parseFloat(albuminInput.value);
        const inr = parseFloat(inrInput.value);
        
        if (isNaN(ascites) || isNaN(encephalopathy) || isNaN(bilirubin) || isNaN(albumin) || isNaN(inr)) {
            showNotification('Por favor, ingrese valores válidos para todos los campos.', 'warning');
            return;
        }

        const totalScore = ascites + encephalopathy + bilirubin + albumin + inr;
        
        let classification = '';
        let prognosis = '';
        let recommendations = '';
        
        if (totalScore <= 6) {
            classification = 'Clase A';
            prognosis = 'Pronóstico bueno (esperanza de vida: 7-10 años)';
            recommendations = 'Manejo médico conservador. Control cada 6-12 meses.';
        } else if (totalScore <= 9) {
            classification = 'Clase B';
            prognosis = 'Pronóstico intermedio (esperanza de vida: 3-5 años)';
            recommendations = 'Evaluar candidatura a trasplante hepático. Control cada 3-6 meses.';
        } else {
            classification = 'Clase C';
            prognosis = 'Pronóstico malo (esperanza de vida: 1-2 años)';
            recommendations = 'Urgente evaluación para trasplante hepático. Manejo de complicaciones.';
        }
        
        document.getElementById('child-pugh-score').textContent = totalScore;
        document.getElementById('child-pugh-class').textContent = classification;
        document.getElementById('child-pugh-prognosis').textContent = prognosis;
        document.getElementById('child-pugh-recommendations').textContent = recommendations;
        document.getElementById('child-pugh-result').style.display = 'block';
    });

    // Calculadora de Riesgo Cardiovascular (SCORE)
    document.getElementById('calculate-cardiovascular-risk')?.addEventListener('click', () => {
        const ageInput = document.getElementById('cv-age');
        const cholesterolInput = document.getElementById('cv-total-cholesterol');
        const systolicInput = document.getElementById('cv-systolic');
        const smokingSelect = document.getElementById('cv-smoking');
        const genderInputs = document.querySelectorAll('input[name="cv-gender"]');
        
        const age = parseInt(ageInput.value);
        const totalCholesterol = parseFloat(cholesterolInput.value);
        const systolic = parseInt(systolicInput.value);
        const smoking = smokingSelect.value;
        let gender = '';
        genderInputs.forEach(input => { if (input.checked) gender = input.value; });
        
        if (isNaN(age) || totalCholesterol <= 0 || isNaN(systolic) || !smoking || !gender) {
            showNotification('Por favor, ingrese valores válidos en todos los campos.', 'warning');
            return;
        }

        // Estimación simplificada del riesgo SCORE
        let riskScore = 0;
        // Factores de riesgo simulados para la demostración
        if (gender === 'male') riskScore += 5; // Bonus para hombres
        if (smoking === 'yes') riskScore += 7; // Bonus para fumadores
        riskScore += (age - 50) / 5; // Por cada 5 años sobre 50
        riskScore += (totalCholesterol - 5) / 1; // Por cada mmol/L sobre 5.0
        riskScore += (systolic - 120) / 10; // Por cada 10 mmHg sobre 120

        // Clases de riesgo aproximadas
        let level = '';
        let recommendations = '';
        
        if (riskScore < 1) {
            level = 'Riesgo Bajo (<1%)';
            recommendations = 'Mantener estilo de vida saludable. Control anual.';
        } else if (riskScore < 5) {
            level = 'Riesgo Bajo (1-5%)';
            recommendations = 'Mantener factores de riesgo bajo control. Evaluación cada 1-2 años.';
        } else if (riskScore < 10) {
            level = 'Riesgo Moderado (5-10%)';
            recommendations = 'Intervención en factores de riesgo modificables. Considerar tratamiento farmacológico.';
        } else if (riskScore < 20) {
            level = 'Alto Riesgo (10-20%)';
            recommendations = 'Tratamiento intensivo de factores de riesgo. Iniciar estatinas si está indicado.';
        } else {
            level = 'Muy Alto Riesgo (>20%)';
            recommendations = 'Tratamiento agresivo de todos los factores de riesgo. Alta prioridad para prevención cardiovascular.';
        }
        
        document.getElementById('cv-risk-value').textContent = `${Math.max(0, riskScore).toFixed(1)}%`; // Asegurar no negativo
        document.getElementById('cv-risk-level').textContent = level;
        document.getElementById('cv-recommendations').textContent = recommendations;
        document.getElementById('cardiovascular-risk-result').style.display = 'block';
    });
}

// --- Signos Vitales ---
function setupVitalSigns() {
    const weightInput = document.getElementById('weight');
    const heightInput = document.getElementById('height');
    const imcOutput = document.getElementById('imc');
    
    function updateIMC() {
        const weight = parseFloat(weightInput?.value);
        const height = parseFloat(heightInput?.value);
        
        if (weight > 0 && height > 0) {
            const heightInMeters = height / 100;
            const imc = weight / (heightInMeters * heightInMeters);
            if (imcOutput) imcOutput.value = imc.toFixed(2);
        } else {
            if (imcOutput) imcOutput.value = '';
        }
    }
    
    weightInput?.addEventListener('input', updateIMC);
    heightInput?.addEventListener('input', updateIMC);
    
    document.getElementById('save-vitals')?.addEventListener('click', () => {
        const patientId = document.getElementById('vitals-patient').value;
        if (!patientId) {
            showNotification('Por favor, seleccione un paciente.', 'warning');
            return;
        }
        
        const temperature = document.getElementById('temperature').value;
        const pa = document.getElementById('pa').value;
        const fc = document.getElementById('fc').value;
        const fr = document.getElementById('fr').value;
        const spo2 = document.getElementById('spo2').value;
        const weight = document.getElementById('weight').value;
        const height = document.getElementById('height').value;
        const notes = document.getElementById('notes').value;
        
        if (!temperature || !pa || !fc || !fr || !spo2 || !weight || !height) {
            showNotification('Por favor, complete todos los campos de signos vitales.', 'warning');
            return;
        }
        
        // Simular guardado y mostrar un mensaje
        showNotification('Signos vitales guardados correctamente.', 'success');
        
        // Limpiar formulario (opcional)
        document.getElementById('temperature').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('fr').value = '';
        document.getElementById('spo2').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('height').value = '';
        document.getElementById('notes').value = '';
        if (imcOutput) imcOutput.value = '';
    });
    
    document.getElementById('clear-vitals')?.addEventListener('click', () => {
        document.getElementById('temperature').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('fr').value = '';
        document.getElementById('spo2').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('height').value = '';
        document.getElementById('notes').value = '';
        if (imcOutput) imcOutput.value = '';
    });
}

// --- Recetas ---
function setupPrescriptions() {
    let entryCounter = 1; // Para generar IDs únicos

    document.getElementById('add-medication')?.addEventListener('click', () => {
        const medicationEntries = document.getElementById('medication-entries');
        
        const newEntry = createEl('div', { className: 'medication-entry' }, [
            createEl('div', { className: 'form-row' }, [
                createEl('div', { className: 'form-group flex-grow' }, [
                    createEl('label', { for: `medication-${entryCounter}` }, ['Medicamento']),
                    createEl('input', { type: 'text', id: `medication-${entryCounter}`, className: 'medication-name', placeholder: 'Nombre del medicamento' })
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `dose-${entryCounter}` }, ['Dosis']),
                    createEl('input', { type: 'text', id: `dose-${entryCounter}`, placeholder: '10mg' })
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `frequency-${entryCounter}` }, ['Frecuencia']),
                    createEl('select', { id: `frequency-${entryCounter}` }, [
                        createEl('option', { value: 'once' }, ['1 vez al día']),
                        createEl('option', { value: 'twice' }, ['2 veces al día']),
                        createEl('option', { value: 'thrice' }, ['3 veces al día']),
                        createEl('option', { value: 'four-times' }, ['4 veces al día']),
                        createEl('option', { value: 'as-needed' }, ['Según necesidad'])
                    ])
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `duration-${entryCounter}` }, ['Duración']),
                    createEl('input', { type: 'text', id: `duration-${entryCounter}`, placeholder: '7 días' })
                ])
            ]),
            createEl('div', { className: 'form-group' }, [
                createEl('label', { for: `instructions-${entryCounter}` }, ['Instrucciones']),
                createEl('textarea', { id: `instructions-${entryCounter}`, rows: 2, placeholder: 'Tomar después de las comidas...' })
            ]),
            createEl('button', { className: 'btn btn-warning remove-medication', 'data-entry': entryCounter, onclick: function() { removeMedicationEntry(this.dataset.entry); } }, [
                createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
            ])
        ]);
        
        medicationEntries.appendChild(newEntry);
        
        // Añadir listener para el nuevo medicamento que active la verificación de interacciones
        newEntry.querySelector('.medication-name').addEventListener('input', checkMedicationInteractions);
        entryCounter++;
    });
    
    // Verificar interacciones medicamentosas
    function checkMedicationInteractions() {
        const medicationInputs = document.querySelectorAll('.medication-name');
        const currentMedications = Array.from(medicationInputs)
            .map(input => input.value.trim())
            .filter(name => name !== '');
        
        const warnings = new Set(); // Usar un Set para evitar duplicados
        
        for (let i = 0; i < currentMedications.length; i++) {
            const med1Name = currentMedications[i];
            if (medicamentosDB[med1Name]) {
                const med1Data = medicamentosDB[med1Name];
                for (let j = i + 1; j < currentMedications.length; j++) {
                    const med2Name = currentMedications[j];
                    if (med1Data.interacciones[med2Name]) {
                        const interaction = med1Data.interacciones[med2Name];
                        warnings.add(`${med1Name} - ${med2Name}: ${interaction.descripcion} (<span class="severity-${interaction.severidad}">${interaction.severidad}</span>)`);
                    }
                    // Verificar la interacción inversa también si el segundo medicamento está en DB
                    if (medicamentosDB[med2Name] && medicamentosDB[med2Name].interacciones[med1Name]) {
                        const interaction = medicamentosDB[med2Name].interacciones[med1Name];
                        warnings.add(`${med2Name} - ${med1Name}: ${interaction.descripcion} (<span class="severity-${interaction.severidad}">${interaction.severidad}</span>)`);
                    }
                }
            }
        }
        
        const warningDiv = document.getElementById('interactions-warning');
        const warningList = document.getElementById('interactions-list');
        
        if (warnings.size > 0) {
            warningList.innerHTML = Array.from(warnings).map(warning => `<li>${warning}</li>`).join('');
            warningDiv.style.display = 'block';
        } else {
            warningDiv.style.display = 'none';
        }
    }
    
    // Verificar interacciones al cambiar el nombre de cualquier medicamento
    document.querySelectorAll('.medication-name').forEach(input => {
        input.addEventListener('input', checkMedicationInteractions);
    });
    
    // Emitir receta
    document.getElementById('issue-prescription')?.addEventListener('click', () => {
        const patientId = document.getElementById('recipe-patient').value;
        if (!patientId) {
            showNotification('Por favor, seleccione un paciente.', 'warning');
            return;
        }
        
        const medicationEntries = document.querySelectorAll('.medication-entry');
        if (medicationEntries.length === 0) {
            showNotification('Por favor, añada al menos un medicamento a la receta.', 'warning');
            return;
        }
        
        // Verificar interacciones antes de emitir
        const warningDiv = document.getElementById('interactions-warning');
        if (warningDiv.style.display === 'block') {
            const confirmIssue = confirm('Hay interacciones medicamentosas detectadas. ¿Desea continuar con la emisión de la receta?');
            if (!confirmIssue) return;
        }
        
        const patient = simulatedPatients.find(p => p.id === parseInt(patientId));
        showNotification(`Receta emitida para ${patient.nombre} con éxito.`, 'success');
    });
}

function removeMedicationEntry(entryId) {
    const entryElement = document.querySelector(`.medication-entry[data-entry="${entryId}"]`);
    if (entryElement) {
        entryElement.remove();
        checkMedicationInteractions(); // Re-verificar interacciones al eliminar
    }
}

// --- Consultorio Virtual ---
function setupConsultorioVirtual() {
    const searchInput = document.getElementById('search-query');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const searchButton = document.getElementById('search-button');
    const searchResultsContainer = document.getElementById('search-results');
    
    // Sugerencias comunes predefinidas
    const commonSuggestions = [
        "cefalea intensa, fotofobia, fiebre", // Meningitis
        "diabetes mellitus tipo 2 tratamiento",
        "metformina mecanismo de acción",
        "protocolo de esclerosis múltiple",
        "parkinson diagnóstico",
        "losartan interacciones",
        "punción lumbar indicaciones",
        "RM cerebral en esclerosis múltiple",
        "síntomas de insuficiencia cardíaca"
    ];
    
    searchInput?.addEventListener('focus', showSuggestions);
    searchInput?.addEventListener('input', showSuggestions);
    
    function showSuggestions() {
        const query = searchInput.value.toLowerCase().trim();
        if (!suggestionsContainer) return;
        
        if (query === '') {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        const filteredSuggestions = commonSuggestions.filter(suggestion => 
            suggestion.toLowerCase().includes(query)
        );
        
        suggestionsContainer.innerHTML = ''; // Limpiar
        if (filteredSuggestions.length > 0) {
            filteredSuggestions.forEach(suggestion => {
                const div = createEl('div', { className: 'suggestion-item', onclick: () => selectSuggestion(suggestion) }, [
                    highlightText(suggestion, query) // Función para resaltar el texto buscado
                ]);
                suggestionsContainer.appendChild(div);
            });
            suggestionsContainer.style.display = 'block';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    function highlightText(text, query) {
        const queryLower = query.toLowerCase();
        const textLower = text.toLowerCase();
        const index = textLower.indexOf(queryLower);
        
        if (index === -1) return document.createTextNode(text);
        
        const span = createEl('span', { className: 'suggestion-highlight' }, [text.substring(index, index + query.length)]);
        const fragment = document.createDocumentFragment();
        fragment.appendChild(document.createTextNode(text.substring(0, index)));
        fragment.appendChild(span);
        fragment.appendChild(document.createTextNode(text.substring(index + query.length)));
        return fragment;
    }
    
    function selectSuggestion(suggestion) {
        searchInput.value = suggestion;
        if (suggestionsContainer) suggestionsContainer.style.display = 'none';
        performSearch(suggestion);
    }
    
    // Ocultar sugerencias al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!searchInput?.contains(e.target) && !suggestionsContainer?.contains(e.target)) {
            if (suggestionsContainer) suggestionsContainer.style.display = 'none';
        }
    });
    
    searchButton?.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) performSearch(query);
    });
    
    searchInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            if (query) performSearch(query);
        }
    });
}

function performSearch(query) {
    if (!query) return;
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;
    
    resultsContainer.innerHTML = '<p>Buscando información para: <strong>' + query + '</strong></p>';
    
    setTimeout(() => {
        const results = searchKnowledgeBase(query);
        displaySearchResults(results, query);
    }, 500); // Simular retraso de búsqueda
}

function searchKnowledgeBase(query) {
    const terms = query.toLowerCase().trim().split(/\s+/);
    const results = [];
    
    // Helper para calcular score de relevancia
    const calculateRelevance = (text, queryTerms) => {
        let score = 0;
        const lowerText = text.toLowerCase();
        queryTerms.forEach(term => {
            if (lowerText.includes(term)) {
                score += lowerText.split(term).length - 1; // Contar ocurrencias
            }
        });
        return score;
    };
    
    const addResult = (type, data, score) => {
        if (score > 0) {
            results.push({ type, data, relevance: score });
        }
    };
    
    // Buscar en enfermedades
    medicalKnowledgeBase.diseases.forEach(disease => {
        const text = `${disease.nombre} ${disease.codigoCIE10} ${disease.etiologia} ${disease.fisiopatologia} ${disease.presentacionClinica.join(' ')} ${disease.diagnostico} ${disease.tratamientos.join(' ')} ${disease.pronostico} ${disease.educacionPaciente}`.toLowerCase();
        addResult('disease', disease, calculateRelevance(text, terms));
    });
    
    // Buscar en tratamientos
    medicalKnowledgeBase.treatments.forEach(treatment => {
        const text = `${treatment.nombre} ${treatment.indicaciones.join(' ')} ${treatment.mecanismoAccion} ${treatment.efectosAdversos.join(' ')} ${treatment.interacciones.join(' ')} ${treatment.contraindicaciones.join(' ')}`.toLowerCase();
        addResult('treatment', treatment, calculateRelevance(text, terms));
    });
    
    // Buscar en fármacos (medicamentosDB)
    for (const medName in medicamentosDB) {
        const drug = { nombre: medName, ...medicamentosDB[medName] }; // Adaptar formato
        const text = `${drug.nombre} ${drug.laboratorio} ${drug.mecanismoAccion} ${drug.efectosSecundarios.join(' ')} ${drug.contraindicaciones.join(' ')}`.toLowerCase();
        addResult('drug', drug, calculateRelevance(text, terms));
    }
    
    // Buscar en protocolos
    medicalKnowledgeBase.protocols.forEach(protocol => {
        const text = `${protocol.nombre} ${protocol.area} ${protocol.descripcion} ${protocol.pasos.join(' ')} ${protocol.referencias.join(' ')}`.toLowerCase();
        addResult('protocol', protocol, calculateRelevance(text, terms));
    });
    
    // Buscar en procedimientos
    medicalKnowledgeBase.medicalProcedures.forEach(procedure => {
        const text = `${procedure.nombre} ${procedure.indicaciones.join(' ')} ${procedure.contraindicaciones.join(' ')} ${procedure.riesgos.join(' ')}`.toLowerCase();
        addResult('procedure', procedure, calculateRelevance(text, terms));
    });
    
    // Buscar en pruebas médicas
    medicalKnowledgeBase.medicalTests.forEach(test => {
        const text = `${test.nombre} ${test.indicaciones.join(' ')} ${test.interpretacion}`.toLowerCase();
        addResult('test', test, calculateRelevance(text, terms));
    });
    
    // Ordenar por relevancia descendente
    return results.sort((a, b) => b.relevance - a.relevance);
}

function displaySearchResults(results, originalQuery) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;
    
    if (results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert-card alert-card-warning">
                <span class="material-symbols-outlined alert-icon">search_off</span>
                <div>
                    <strong>No se encontraron resultados</strong> para "${originalQuery}". Por favor, intente con términos más específicos.
                </div>
            </div>
        `;
        return;
    }
    
    resultsContainer.innerHTML = `<p><strong>Resultados para:</strong> "${originalQuery}"</p>`;
    
    results.forEach((result, index) => {
        const resultItem = createEl('div', { className: 'result-item' }, [
            createEl('div', { className: 'result-header' }, [
                createEl('h3', { className: 'result-title' }, [result.data.nombre || result.data.titulo]),
                createEl('span', { className: 'result-type' }, [capitalize(result.type)])
            ]),
            createEl('div', { className: 'result-content' }, [
                // Contenido resumido
                (result.type === 'disease' ? 
                    `<p><strong>CIE-10:</strong> ${result.data.codigoCIE10}</p><p><strong>Presentación:</strong> ${result.data.presentacionClinica.slice(0, 3).join(', ')}...</p>` :
                 result.type === 'treatment' ? 
                    `<p><strong>Indicación:</strong> ${result.data.indicaciones[0]}</p><p><strong>Mecanismo:</strong> ${result.data.mecanismoAccion.substring(0, 50)}...</p>` :
                 result.type === 'drug' ?
                    `<p><strong>Laboratorio:</strong> ${result.data.laboratorio}</p><p><strong>Efectos:</strong> ${result.data.efectosSecundarios.slice(0,2).join(', ')}...</p>` :
                 result.type === 'protocol' ? 
                    `<p><strong>Área:</strong> ${result.data.area}</p><p><strong>Descripción:</strong> ${result.data.descripcion.substring(0, 70)}...</p>` :
                 result.type === 'procedure' ?
                    `<p><strong>Indicaciones:</strong> ${result.data.indicaciones.slice(0,2).join(', ')}...</p>` :
                 result.type === 'test' ?
                    `<p><strong>Indicaciones:</strong> ${result.data.indicaciones.slice(0,2).join(', ')}...</p>` : ''
                )
            ]),
            createEl('div', { className: 'result-actions' }, [
                createEl('button', { className: 'btn btn-detail', onclick: () => showDetail(result.type, result.data.id || result.data.id) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['info']), 'Detalles'
                ]),
                (result.data.imagenes && result.data.imagenes.length > 0) ? 
                    createEl('button', { className: 'btn btn-images', onclick: () => showImages(result.data.imagenes) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['image']), 'Imágenes'
                    ]) : null,
                (result.type === 'disease' || result.type === 'protocol') ? 
                    createEl('button', { className: 'btn btn-protocol', onclick: () => showProtocol(result.type, result.data.id) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['description']), 'Protocolo'
                    ]) : null,
                createEl('button', { className: 'btn btn-expert', onclick: () => getExpertOpinion(result.type, result.data.nombre || result.data.titulo) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['psychology']), 'Segunda Opinión'
                ])
            ].filter(el => el !== null)) // Eliminar nulos si algún botón no aplica
        ]);
        resultsContainer.appendChild(resultItem);
    });
}

function showDetail(type, id) {
    let data = null;
    switch(type) {
        case 'disease': data = medicalKnowledgeBase.diseases.find(item => item.id === id); break;
        case 'treatment': data = medicalKnowledgeBase.treatments.find(item => item.id === id); break;
        case 'drug': data = Object.values(medicamentosDB).find(item => item.nombre === id); break; // Busca por nombre en medicamentosDB
        case 'protocol': data = medicalKnowledgeBase.protocols.find(item => item.id === id); break;
        case 'procedure': data = medicalKnowledgeBase.medicalProcedures.find(item => item.id === id); break;
        case 'test': data = medicalKnowledgeBase.medicalTests.find(item => item.id === id); break;
    }
    
    if (!data) {
        showNotification('No se pudo cargar el detalle.', 'error');
        return;
    }
    
    let content = `
        <div class="modal-header">
            <h2><span class="material-symbols-outlined">info</span> Detalles de ${data.nombre || data.titulo}</h2>
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body modal-detail-content">
    `;
    
    switch(type) {
        case 'disease':
            content += `
                <h3>Código CIE-10: ${data.codigoCIE10}</h3>
                <h4>Etiología</h4><p>${data.etiologia}</p>
                <h4>Fisiopatología</h4><p>${data.fisiopatologia}</p>
                <h4>Epidemiología</h4><p>${data.epidemiologia}</p>
                <h4>Presentación Clínica</h4><ul>${data.presentacionClinica.map(s => `<li>${s}</li>`).join('')}</ul>
                <h4>Diagnóstico</h4><p>${data.diagnostico}</p>
                <h4>Diagnósticos Diferenciales</h4><ul>${data.diagnosticosDiferenciales.map(d => `<li>${d}</li>`).join('')}</ul>
                <h4>Clasificación</h4><p>${data.clasificacion}</p>
                <h4>Tratamientos</h4><ul>${data.tratamientos.map(t => `<li>${t}</li>`).join('')}</ul>
                <h4>Pronóstico</h4><p>${data.pronostico}</p>
                <h4>Educación para el Paciente</h4><p>${data.educacionPaciente}</p>
                <h4>Recursos Adicionales</h4><ul>${data.recursosAdicionales.map(r => `<li><a href="${r}" target="_blank">${r}</a></li>`).join('')}</ul>
            `;
            break;
        case 'treatment':
            content += `
                <h3>Indicaciones</h3><ul>${data.indicaciones.map(i => `<li>${i}</li>`).join('')}</ul>
                <h4>Mecanismo de Acción</h4><p>${data.mecanismoAccion}</p>
                <h4>Farmacocinética/Farmacodinámica</h4><p>${data.farmacocinetica || 'N/A'}</p>
                <h4>Efectos Adversos</h4><ul>${data.efectosAdversos.map(ea => `<li>${ea}</li>`).join('')}</ul>
                <h4>Interacciones</h4><ul>${data.interacciones.map(inter => `<li>${inter}</li>`).join('')}</ul>
                <h4>Contraindicaciones</h4><p>${data.contraindicaciones.join(', ')}</p>
                <h4>Dosis</h4><p>${data.dosis}</p>
                <h4>Vía de Administración</h4><p>${data.viaAdministracion}</p>
            `;
            break;
        case 'drug':
            content += `
                <h3>Laboratorio: ${data.laboratorio}</h3><h3>Precio: $${data.precio.toFixed(2)}</h3>
                <h4>Mecanismo de Acción</h4><p>${data.mecanismoAccion}</p>
                <h4>Contraindicaciones</h4><p>${data.contraindicaciones.join(', ')}</p>
                <h4>Efectos Secundarios</h4><ul>${data.efectosSecundarios.map(es => `<li>${es}</li>`).join('')}</ul>
                <h4>Interacciones</h4><ul>${Object.entries(data.interacciones).map(([med, inter]) => `<li><strong>${med}:</strong> ${inter.descripcion} (<span class="severity-${inter.severidad}">${inter.severidad}</span>)</li>`).join('')}</ul>
            `;
            break;
        case 'protocol':
            content += `
                <h3>Área: ${data.area}</h3>
                <h4>Descripción</h4><p>${data.descripcion}</p>
                <h4>Pasos</h4><ol>${data.pasos.map(paso => `<li>${paso}</li>`).join('')}</ol>
                <h4>Referencias</h4><p>${data.referencias.join(', ')}</p>
            `;
            break;
        case 'procedure':
            content += `
                <h4>Indicaciones</h4><ul>${data.indicaciones.map(ind => `<li>${ind}</li>`).join('')}</ul>
                <h4>Contraindicaciones</h4><ul>${data.contraindicaciones.map(cont => `<li>${cont}</li>`).join('')}</ul>
                <h4>Riesgos</h4><ul>${data.riesgos.map(riesgo => `<li>${riesgo}</li>`).join('')}</ul>
            `;
            break;
        case 'test':
            content += `
                <h4>Indicaciones</h4><ul>${data.indicaciones.map(ind => `<li>${ind}</li>`).join('')}</ul>
                <h4>Interpretación</h4><p>${data.interpretacion}</p>
            `;
            break;
    }
    
    content += `</div>`;
    showModal(`Detalles de ${data.nombre || data.titulo}`, content);
}

function showImages(images) {
    APP_STATE.imageGallery = images;
    APP_STATE.currentImageIndex = 0;
    
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    if (!lightbox || !lightboxImage || !lightboxCaption || !prevBtn || !nextBtn) return;

    updateLightboxImage();
    lightbox.style.display = 'flex';
}

function updateLightboxImage() {
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    if (!lightboxImage || !lightboxCaption || !prevBtn || !nextBtn) return;

    const image = APP_STATE.imageGallery[APP_STATE.currentImageIndex];
    lightboxImage.src = image.url;
    lightboxCaption.textContent = image.descripcion;
    
    // Actualizar visibilidad de botones prev/next si solo hay una imagen
    if (APP_STATE.imageGallery.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
    }
}

document.getElementById('lightbox-close')?.addEventListener('click', () => {
    document.getElementById('lightbox').style.display = 'none';
});

document.getElementById('lightbox')?.addEventListener('click', (e) => {
    if (e.target.id === 'lightbox') {
        document.getElementById('lightbox').style.display = 'none';
    }
});

document.getElementById('lightbox-next')?.addEventListener('click', () => {
    if (APP_STATE.imageGallery.length > 0) {
        APP_STATE.currentImageIndex = (APP_STATE.currentImageIndex + 1) % APP_STATE.imageGallery.length;
        updateLightboxImage();
    }
});

document.getElementById('lightbox-prev')?.addEventListener('click', () => {
    if (APP_STATE.imageGallery.length > 0) {
        APP_STATE.currentImageIndex = (APP_STATE.currentImageIndex - 1 + APP_STATE.imageGallery.length) % APP_STATE.imageGallery.length;
        updateLightboxImage();
    }
});

function showProtocol(type, id) {
    let protocol = null;
    
    if (type === 'disease') {
        const disease = medicalKnowledgeBase.diseases.find(d => d.id === id);
        if (disease && disease.protocolos && disease.protocolos.length > 0) {
            // Buscar el protocolo por nombre (esto podría ser una debilidad si el nombre cambia)
            protocol = medicalKnowledgeBase.protocols.find(p => p.nombre === disease.protocolos[0]);
        }
    } else if (type === 'protocol') {
        protocol = medicalKnowledgeBase.protocols.find(p => p.id === id);
    }
    
    if (!protocol) {
        showNotification('Protocolo no encontrado o no asociado.', 'warning');
        return;
    }
    
    const content = `
        <div class="modal-body modal-detail-content">
            <h3>Área: ${protocol.area}</h3>
            <h4>Descripción</h4><p>${protocol.descripcion}</p>
            <h4>Pasos</h4><ol>${protocol.pasos.map(paso => `<li>${paso}</li>`).join('')}</ol>
            <h4>Referencias</h4><p>${protocol.referencias.join(', ')}</p>
        </div>
    `;
    showModal(`Protocolo: ${protocol.nombre}`, content);
}

function getExpertOpinion(type, name) {
    const opinionContent = `
        <div class="modal-body">
            <div class="alert-card alert-card-info">
                <span class="material-symbols-outlined alert-icon">lightbulb</span>
                <div>
                    <strong>Recomendación del Experto:</strong> Para ${name}, se recomienda considerar ${type === 'disease' ? 'un enfoque multidisciplinario con seguimiento regular' : 'la evaluación de alternativas terapéuticas según el perfil del paciente'}.
                </div>
            </div>
            <p>Como profesional con experiencia, le sugiero:</p>
            <ul>
                <li>Evaluar cuidadosamente el perfil de riesgo del paciente antes de iniciar cualquier tratamiento.</li>
                <li>Considerar siempre las contraindicaciones y posibles interacciones medicamentosas.</li>
                <li>Mantener una comunicación clara con el paciente sobre el diagnóstico y plan de tratamiento.</li>
                <li>Revisar regularmente la literatura científica más reciente sobre el tema.</li>
            </ul>
            <p>Recuerde que esta es una sugerencia simulada. La toma de decisiones clínica debe basarse en el juicio profesional y la evaluación completa del paciente.</p>
        </div>
    `;
    showModal('Segunda Opinión', opinionContent);
}

function showExampleSearch() {
    const exampleQuery = "cefalea intensa, fotofobia, fiebre";
    const searchInput = document.getElementById('search-query');
    if (searchInput) searchInput.value = exampleQuery;
    performSearch(exampleQuery);
}

// --- Botones de CRUD ---
// Botón Añadir Paciente
document.querySelector('.btn-add-patient')?.addEventListener('click', () => {
    const modalContent = `
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="new-patient-nombre">Nombre</label>
                    <input type="text" id="new-patient-nombre" required>
                </div>
                <div class="form-group">
                    <label for="new-patient-edad">Edad</label>
                    <input type="number" id="new-patient-edad" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-patient-diagnostico">Diagnóstico Principal</label>
                    <input type="text" id="new-patient-diagnostico" required>
                </div>
                <div class="form-group">
                    <label for="new-patient-especialidad">Especialidad</label>
                    <select id="new-patient-especialidad">
                        <option value="">-- Seleccione Especialidad --</option>
                        <option value="Cardiología">Cardiología</option>
                        <option value="Endocrinología">Endocrinología</option>
                        <option value="Infectología">Infectología</option>
                        <option value="Neurología">Neurología</option>
                        <option value="Pediatría">Pediatría</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="new-patient-alergias">Alergias (separadas por comas)</label>
                <input type="text" id="new-patient-alergias">
            </div>
            <div class="form-group">
                <label for="new-patient-riesgo">Riesgo Cardiovascular</label>
                <select id="new-patient-riesgo">
                    <option value="bajo">Bajo</option>
                    <option value="moderado">Moderado</option>
                    <option value="alto">Alto</option>
                </select>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewPatient()">Crear Paciente</button>
            </div>
        </div>
    `;
    showModal('Nuevo Paciente', modalContent);
});

function addNewPatient() {
    const nombre = document.getElementById('new-patient-nombre').value.trim();
    const edad = parseInt(document.getElementById('new-patient-edad').value);
    const diagnostico = document.getElementById('new-patient-diagnostico').value.trim();
    const especialidad = document.getElementById('new-patient-especialidad').value;
    const alergiasInput = document.getElementById('new-patient-alergias').value.trim();
    const alergias = alergiasInput ? alergiasInput.split(',').map(a => a.trim()).filter(a => a !== '') : [];
    const riesgo = document.getElementById('new-patient-riesgo').value;
    
    if (!nombre || isNaN(edad) || !diagnostico || !especialidad) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'warning');
        return;
    }
    
    const newPatient = {
        id: simulatedPatients.length > 0 ? Math.max(...simulatedPatients.map(p => p.id)) + 1 : 1, // Generar ID simple
        nombre,
        edad,
        diagnosticoPrincipal: diagnostico,
        especialidad,
        riesgoCardiovascular: riesgo,
        alergias,
        historiaClinica: {
            resumen: `Paciente ${nombre} agregado recientemente.`,
            diagnosticos: [],
            tratamientos: [],
            evolucion: [],
            signosVitales: []
        }
    };
    
    simulatedPatients.push(newPatient);
    closeModal();
    renderPatientGrid();
    loadPatientsIntoSelectors();
    showNotification('Paciente creado correctamente.', 'success');
}

// Botón Añadir Personal
document.querySelector('.btn-add-staff')?.addEventListener('click', () => {
    const modalContent = `
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="new-staff-nombre">Nombre</label>
                    <input type="text" id="new-staff-nombre" required>
                </div>
                <div class="form-group">
                    <label for="new-staff-rol">Rol</label>
                    <select id="new-staff-rol">
                        <option value="">-- Seleccione Rol --</option>
                        <option value="Médico">Médico</option>
                        <option value="Enfermero">Enfermero</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-staff-especialidad">Especialidad</label>
                    <input type="text" id="new-staff-especialidad" required>
                </div>
                <div class="form-group">
                    <label for="new-staff-telefono">Teléfono</label>
                    <input type="text" id="new-staff-telefono" required>
                </div>
            </div>
            <div class="form-group">
                <label for="new-staff-email">Email</label>
                <input type="email" id="new-staff-email" required>
            </div>
            <div class="form-group">
                <label for="new-staff-bio">Biografía</label>
                <textarea id="new-staff-bio" rows="3"></textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewStaff()">Crear Miembro</button>
            </div>
        </div>
    `;
    showModal('Nuevo Miembro del Personal', modalContent);
});

function addNewStaff() {
    const nombre = document.getElementById('new-staff-nombre').value.trim();
    const rol = document.getElementById('new-staff-rol').value;
    const especialidad = document.getElementById('new-staff-especialidad').value.trim();
    const telefono = document.getElementById('new-staff-telefono').value.trim();
    const email = document.getElementById('new-staff-email').value.trim();
    const bio = document.getElementById('new-staff-bio').value.trim();
    
    if (!nombre || !rol || !especialidad || !telefono || !email) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'warning');
        return;
    }
    
    const newStaff = {
        id: medicalStaff.length > 0 ? Math.max(...medicalStaff.map(s => s.id)) + 1 : 1,
        nombre,
        rol,
        especialidad,
        avatar: `https://placehold.co/40x40/9aa0a6/ffffff?text=${nombre.charAt(0)}`, // Avatar genérico
        contacto: {
            telefono,
            email
        },
        bio: bio || `Profesional ${rol.toLowerCase()} con experiencia en ${especialidad}.`,
        citas: 0
    };
    
    medicalStaff.push(newStaff);
    closeModal();
    renderStaffGrid();
    showNotification('Miembro del personal creado correctamente.', 'success');
}

// Botón Añadir Recurso Educativo
document.querySelector('.btn-add-resource')?.addEventListener('click', () => {
    const modalContent = `
        <div class="form-container">
            <div class="form-group">
                <label for="new-resource-titulo">Título</label>
                <input type="text" id="new-resource-titulo" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-resource-tipo">Tipo</label>
                    <select id="new-resource-tipo">
                        <option value="">-- Seleccione Tipo --</option>
                        <option value="imagen">Imagen</option>
                        <option value="video">Video</option>
                        <option value="documento">Documento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-resource-categoria">Categoría</label>
                    <select id="new-resource-categoria">
                        <option value="">-- Seleccione Categoría --</option>
                        <option value="curacion">Curación</option>
                        <option value="anatomia">Anatomía</option>
                        <option value="protocolo">Protocolo</option>
                        <option value="educacion">Educación</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="new-resource-url">URL</label>
                <input type="text" id="new-resource-url" required placeholder="https://ejemplo.com/recurso">
            </div>
            <div class="form-group">
                <label for="new-resource-etiquetas">Etiquetas (separadas por comas)</label>
                <input type="text" id="new-resource-etiquetas">
            </div>
            <div class="form-group">
                <label for="new-resource-descripcion">Descripción</label>
                <textarea id="new-resource-descripcion" rows="3"></textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewResource()">Crear Recurso</button>
            </div>
        </div>
    `;
    showModal('Nuevo Recurso Educativo', modalContent);
});

function addNewResource() {
    const titulo = document.getElementById('new-resource-titulo').value.trim();
    const tipo = document.getElementById('new-resource-tipo').value;
    const categoria = document.getElementById('new-resource-categoria').value;
    const url = document.getElementById('new-resource-url').value.trim();
    const etiquetasInput = document.getElementById('new-resource-etiquetas').value.trim();
    const etiquetas = etiquetasInput ? etiquetasInput.split(',').map(e => e.trim()).filter(e => e !== '') : [];
    const descripcion = document.getElementById('new-resource-descripcion').value.trim();
    
    if (!titulo || !tipo || !categoria || !url) {
        showNotification('Por favor, complete todos los campos obligatorios.', 'warning');
        return;
    }
    
    const newResource = {
        id: educationalResources.length > 0 ? Math.max(...educationalResources.map(r => r.id)) + 1 : 1,
        titulo,
        tipo,
        categoria,
        url,
        etiquetas,
        descripcion: descripcion || `Recurso educativo sobre ${titulo}.`
    };
    
    educationalResources.push(newResource);
    closeModal();
    renderResourceGrid();
    showNotification('Recurso educativo creado correctamente.', 'success');
}

// --- Event Listeners para Filtros ---
function loadSpecialties() {
    const filterSelect = document.getElementById('specialty-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por especialidad...</option>';
    const specialties = [...new Set(simulatedPatients.map(p => p.especialidad))].sort();
    
    specialties.forEach(specialty => {
        const option = createEl('option', { value: specialty }, [specialty]);
        filterSelect.appendChild(option);
    });
}

function loadRoles() {
    const filterSelect = document.getElementById('role-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por rol...</option>';
    const roles = [...new Set(medicalStaff.map(s => s.rol))].sort();
    
    roles.forEach(rol => {
        const option = createEl('option', { value: rol }, [rol]);
        filterSelect.appendChild(option);
    });
}

function loadCategories() {
    const filterSelect = document.getElementById('category-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por categoría...</option>';
    const categories = [...new Set(educationalResources.map(r => r.categoria))].sort();
    
    categories.forEach(category => {
        const option = createEl('option', { value: category }, [category]);
        filterSelect.appendChild(option);
    });
}

// Cargar tipos de recursos en el filtro
function loadResourceTypes() {
    const filterSelect = document.getElementById('type-filter');
    if (!filterSelect) return;
    
    filterSelect.innerHTML = '<option value="">Filtrar por tipo...</option>';
    const types = [...new Set(educationalResources.map(r => r.tipo))].sort();
    
    types.forEach(type => {
        const option = createEl('option', { value: type }, [type]);
        filterSelect.appendChild(option);
    });
}

// --- Temas ---
function setupThemeToggle() {
    const themeToggle = document.getElementById('theme-toggle');
    const icon = themeToggle?.querySelector('.material-symbols-outlined');
    const body = document.body;
    
    if (!themeToggle || !icon || !body) return;
    
    // Cargar tema guardado o aplicar el default
    body.classList.add(`theme-${APP_STATE.theme}`);
    icon.textContent = APP_STATE.theme === 'light' ? 'dark_mode' : 'light_mode';
    
    themeToggle.addEventListener('click', () => {
        if (body.classList.contains('theme-light')) {
            body.classList.remove('theme-light');
            body.classList.add('theme-dark');
            icon.textContent = 'light_mode';
            APP_STATE.theme = 'dark';
        } else {
            body.classList.remove('theme-dark');
            body.classList.add('theme-light');
            icon.textContent = 'dark_mode';
            APP_STATE.theme = 'light';
        }
    });
}

// --- Gráficos ---
function showVitalSignsChart() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no está cargado, no se puede inicializar el gráfico.');
        return;
    }
    
    const chartData = {
        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
        datasets: [{
            label: 'Presión Arterial Sistólica',
            data: [130, 128, 125, 122, 120, 118],
            borderColor: '#1a73e8',
            backgroundColor: 'rgba(26, 115, 232, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#1a73e8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'Presión Arterial Diastólica',
            data: [85, 84, 82, 80, 79, 78],
            borderColor: '#34a853',
            backgroundColor: 'rgba(52, 168, 83, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#34a853',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    };
    
    const ctx = document.getElementById('vitalSignsChart');
    if (!ctx) return;

    window.vitalSignsChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Evolución de Signos Vitales' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                x: { grid: { color: 'rgba(0, 0, 0, 0.1)' } }
            }
        }
    });
}

function updateVitalSignsChart(type) {
    const chart = window.vitalSignsChart;
    if (!chart) return;
    
    let newData;
    
    switch(type) {
        case 'heartRate':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Frecuencia Cardíaca', data: [75, 74, 73, 72, 71, 70], borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#1a73e8', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        case 'temperature':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Temperatura', data: [36.8, 36.7, 36.6, 36.7, 36.6, 36.5], borderColor: '#f9ab00', backgroundColor: 'rgba(249, 171, 0, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#f9ab00', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        case 'spo2':
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{ label: 'Saturación O2', data: [98, 98, 99, 99, 99, 98], borderColor: '#34a853', backgroundColor: 'rgba(52, 168, 83, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#34a853', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4 }]
            };
            break;
        default: // pressure (default)
            newData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{
                    label: 'Presión Arterial Sistólica', data: [130, 128, 125, 122, 120, 118], borderColor: '#1a73e8', backgroundColor: 'rgba(26, 115, 232, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#1a73e8', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4
                }, {
                    label: 'Presión Arterial Diastólica', data: [85, 84, 82, 80, 79, 78], borderColor: '#34a853', backgroundColor: 'rgba(52, 168, 83, 0.1)', fill: true, tension: 0.1, pointBackgroundColor: '#34a853', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 4
                }]
            };
    }
    
    chart.data = newData;
    chart.update();
    APP_STATE.activeChart = type;
}

function refreshChart() {
    if (window.vitalSignsChart) {
        updateVitalSignsChart(APP_STATE.activeChart);
        showNotification('Gráfico actualizado con los últimos datos.', 'success');
    } else {
        showNotification('El gráfico aún no ha sido inicializado.', 'warning');
    }
}

function setupVitalsHistoryChart() {
    const chartData = {
        labels: ['2023-01-15', '2023-03-20', '2023-06-20'],
        datasets: [{
            label: 'Presión Arterial Sistólica',
            data: [130, 125, 120],
            borderColor: '#1a73e8',
            backgroundColor: 'rgba(26, 115, 232, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#1a73e8',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }, {
            label: 'Presión Arterial Diastólica',
            data: [85, 82, 80],
            borderColor: '#34a853',
            backgroundColor: 'rgba(52, 168, 83, 0.1)',
            fill: true,
            tension: 0.1,
            pointBackgroundColor: '#34a853',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    };
    
    const ctx = document.getElementById('vitalsHistoryChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Historial de Presión Arterial' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.1)' } },
                x: { grid: { color: 'rgba(0, 0, 0, 0.1)' } }
            }
        }
    });
}

// --- Calculadoras Médicas ---
function setupCalculators() {
    document.getElementById('calc-selector')?.addEventListener('change', (e) => {
        const calculatorId = e.target.value + '-calculator';
        document.querySelectorAll('.calculator-form').forEach(form => {
            form.style.display = 'none';
        });
        const targetForm = document.getElementById(calculatorId);
        if (targetForm) targetForm.style.display = 'block';
    });

    // Calculadora de IMC
    document.getElementById('calculate-imc')?.addEventListener('click', () => {
        const weightInput = document.getElementById('imc-weight');
        const heightInput = document.getElementById('imc-height');
        const weight = parseFloat(weightInput?.value);
        const heightCm = parseFloat(heightInput?.value);
        const imcOutput = document.getElementById('imc-value');
        const imcClassification = document.getElementById('imc-classification');
        const imcRecommendations = document.getElementById('imc-recommendations');
        const imcResultDiv = document.getElementById('imc-result');
        
        if (!weightInput || !heightInput || !imcOutput || !imcClassification || !imcRecommendations || !imcResultDiv) return;

        if (weight > 0 && heightCm > 0) {
            const heightM = heightCm / 100;
            const imc = weight / (heightM * heightM);
            const imcValue = imc.toFixed(2);
            
            let classification = '';
            let recommendations = '';
            
            if (imc < 18.5) {
                classification = 'Bajo peso';
                recommendations = 'Considerar evaluación nutricional y aumento de ingesta calórica.';
            } else if (imc < 25) {
                classification = 'Peso normal';
                recommendations = 'Mantener estilo de vida saludable con dieta equilibrada y ejercicio regular.';
            } else if (imc < 30) {
                classification = 'Sobrepeso';
                recommendations = 'Recomendar dieta hipocalórica y ejercicio físico regular. Evaluar factores de riesgo cardiovascular.';
            } else if (imc < 35) {
                classification = 'Obesidad grado I';
                recommendations = 'Intervención nutricional intensiva. Considerar tratamiento farmacológico si hay comorbilidades.';
            } else if (imc < 40) {
                classification = 'Obesidad grado II';
                recommendations = 'Tratamiento multidisciplinario. Evaluar candidatura a cirugía bariátrica.';
            } else {
                classification = 'Obesidad grado III (mórbida)';
                recommendations = 'Evaluación urgente para tratamiento multidisciplinario y cirugía bariátrica.';
            }
            
            imcOutput.textContent = imcValue;
            imcClassification.textContent = classification;
            imcRecommendations.textContent = recommendations;
            imcResultDiv.style.display = 'block';
        } else {
            showNotification('Por favor, ingrese valores válidos de peso y talla.', 'warning');
        }
    });

    // Calculadora de Filtrado Glomerular (CKD-EPI)
    document.getElementById('calculate-filtration')?.addEventListener('click', () => {
        const creatinineInput = document.getElementById('creatinine');
        const ageInput = document.getElementById('age');
        const genderInputs = document.querySelectorAll('input[name="gender"]');
        const filtrationValue = document.getElementById('filtration-value');
        const filtrationStage = document.getElementById('filtration-stage');
        const filtrationRecommendations = document.getElementById('filtration-recommendations');
        const filtrationResultDiv = document.getElementById('filtration-result');
        
        const creatinine = parseFloat(creatinineInput?.value);
        const age = parseInt(ageInput?.value);
        let gender = '';
        genderInputs.forEach(input => { if (input.checked) gender = input.value; });
        
        if (!creatinineInput || !ageInput || !genderInputs || !filtrationValue || !filtrationStage || !filtrationRecommendations || !filtrationResultDiv) return;

        if (creatinine > 0 && age > 0 && gender) {
            // Fórmula CKD-EPI
            let k, a, sex_factor;
            if (gender === 'female') {
                k = 0.7;
                a = creatinine <= 0.7 ? -0.241 : -1.2;
                sex_factor = 1.018;
            } else { // male
                k = 0.9;
                a = creatinine <= 0.9 ? -0.302 : -1.2;
                sex_factor = 1;
            }
            
            const egfr = 141 * Math.pow(Math.min(creatinine/k, 1), a) * 
                         Math.pow(Math.max(creatinine/k, 1), -1.209) * 
                         Math.pow(0.993, age) * sex_factor;
            
            const egfrValue = Math.round(egfr);
            
            let stage = '';
            let recommendations = '';
            
            if (egfrValue >= 90) {
                stage = 'Estadio 1: Daño renal con filtrado normal (eGFR ≥ 90)';
                recommendations = 'Control anual de función renal. Mantener factores de riesgo bajo control.';
            } else if (egfrValue >= 60) {
                stage = 'Estadio 2: Daño renal con filtrado ligeramente disminuido (eGFR 60-89)';
                recommendations = 'Control cada 6-12 meses. Evaluar causa de daño renal.';
            } else if (egfrValue >= 30) {
                stage = 'Estadio 3: Filtrado moderadamente disminuido (eGFR 30-59)';
                recommendations = 'Control cada 3-6 meses. Referir a nefrología. Evitar nefrotóxicos.';
            } else if (egfrValue >= 15) {
                stage = 'Estadio 4: Filtrado severamente disminuido (eGFR 15-29)';
                recommendations = 'Control cada 1-3 meses. Preparar para terapia de reemplazo renal.';
            } else {
                stage = 'Estadio 5: Insuficiencia renal (eGFR <15)';
                recommendations = 'Iniciar plan de terapia de reemplazo renal (diálisis o trasplante).';
            }
            
            filtrationValue.textContent = egfrValue;
            filtrationStage.textContent = stage;
            filtrationRecommendations.textContent = recommendations;
            filtrationResultDiv.style.display = 'block';
        } else {
            showNotification('Por favor, ingrese valores válidos de creatinina, edad y género.', 'warning');
        }
    });

    // Calculadora Child-Pugh
    document.getElementById('calculate-child-pugh')?.addEventListener('click', () => {
        const ascitesInput = document.getElementById('ascites');
        const encephalopathyInput = document.getElementById('encephalopathy');
        const bilirubinInput = document.getElementById('bilirubin');
        const albuminInput = document.getElementById('albumin');
        const inrInput = document.getElementById('inr');
        const childPughScore = document.getElementById('child-pugh-score');
        const childPughClass = document.getElementById('child-pugh-class');
        const childPughPrognosis = document.getElementById('child-pugh-prognosis');
        const childPughRecommendations = document.getElementById('child-pugh-recommendations');
        const childPughResultDiv = document.getElementById('child-pugh-result');
        
        const ascites = parseInt(ascitesInput?.value);
        const encephalopathy = parseInt(encephalopathyInput?.value);
        const bilirubin = parseFloat(bilirubinInput?.value);
        const albumin = parseFloat(albuminInput?.value);
        const inr = parseFloat(inrInput?.value);
        
        if (!ascitesInput || !encephalopathyInput || !bilirubinInput || !albuminInput || !inrInput || !childPughScore || !childPughClass || !childPughPrognosis || !childPughRecommendations || !childPughResultDiv) return;

        if (isNaN(ascites) || isNaN(encephalopathy) || isNaN(bilirubin) || isNaN(albumin) || isNaN(inr)) {
            showNotification('Por favor, ingrese valores válidos para todos los campos.', 'warning');
            return;
        }

        const totalScore = ascites + encephalopathy + bilirubin + albumin + inr;
        
        let classification = '';
        let prognosis = '';
        let recommendations = '';
        
        if (totalScore <= 6) {
            classification = 'Clase A';
            prognosis = 'Pronóstico bueno (esperanza de vida: 7-10 años)';
            recommendations = 'Manejo médico conservador. Control cada 6-12 meses.';
        } else if (totalScore <= 9) {
            classification = 'Clase B';
            prognosis = 'Pronóstico intermedio (esperanza de vida: 3-5 años)';
            recommendations = 'Evaluar candidatura a trasplante hepático. Control cada 3-6 meses.';
        } else {
            classification = 'Clase C';
            prognosis = 'Pronóstico malo (esperanza de vida: 1-2 años)';
            recommendations = 'Urgente evaluación para trasplante hepático. Manejo de complicaciones.';
        }
        
        childPughScore.textContent = totalScore;
        childPughClass.textContent = classification;
        childPughPrognosis.textContent = prognosis;
        childPughRecommendations.textContent = recommendations;
        childPughResultDiv.style.display = 'block';
    });

    // Calculadora de Riesgo Cardiovascular (SCORE - simplificada)
    document.getElementById('calculate-cardiovascular-risk')?.addEventListener('click', () => {
        const ageInput = document.getElementById('cv-age');
        const cholesterolInput = document.getElementById('cv-total-cholesterol');
        const systolicInput = document.getElementById('cv-systolic');
        const smokingSelect = document.getElementById('cv-smoking');
        const genderInputs = document.querySelectorAll('input[name="cv-gender"]');
        
        const age = parseInt(ageInput?.value);
        const totalCholesterol = parseFloat(cholesterolInput?.value);
        const systolic = parseInt(systolicInput?.value);
        const smoking = smokingSelect?.value;
        let gender = '';
        genderInputs.forEach(input => { if (input.checked) gender = input.value; });

        const cvRiskValue = document.getElementById('cv-risk-value');
        const cvRiskLevel = document.getElementById('cv-risk-level');
        const cvRecommendations = document.getElementById('cv-recommendations');
        const cvResultDiv = document.getElementById('cardiovascular-risk-result');
        
        if (!ageInput || !cholesterolInput || !systolicInput || !smokingSelect || !genderInputs || !cvRiskValue || !cvRiskLevel || !cvRecommendations || !cvResultDiv) return;

        if (isNaN(age) || totalCholesterol <= 0 || isNaN(systolic) || !smoking || !gender) {
            showNotification('Por favor, ingrese valores válidos en todos los campos.', 'warning');
            return;
        }

        // Estimación simplificada del riesgo SCORE
        let riskScore = 0;
        if (gender === 'male') riskScore += 5;
        if (smoking === 'yes') riskScore += 7;
        riskScore += (age - 50) / 5;
        riskScore += (totalCholesterol - 5) / 1; 
        riskScore += (systolic - 120) / 10;
        
        riskScore = Math.min(riskScore, 30); // Limitar el score
        
        let level = '';
        let recommendations = '';
        
        if (riskScore < 1) {
            level = 'Riesgo Bajo (<1%)';
            recommendations = 'Mantener estilo de vida saludable. Control anual.';
        } else if (riskScore < 5) {
            level = 'Riesgo Bajo (1-5%)';
            recommendations = 'Mantener factores de riesgo bajo control. Evaluación cada 1-2 años.';
        } else if (riskScore < 10) {
            level = 'Riesgo Moderado (5-10%)';
            recommendations = 'Intervención en factores de riesgo modificables. Considerar tratamiento farmacológico.';
        } else if (riskScore < 20) {
            level = 'Alto Riesgo (10-20%)';
            recommendations = 'Tratamiento intensivo de factores de riesgo. Iniciar estatinas si está indicado.';
        } else {
            level = 'Muy Alto Riesgo (>20%)';
            recommendations = 'Tratamiento agresivo de todos los factores de riesgo. Alta prioridad para prevención cardiovascular.';
        }
        
        cvRiskValue.textContent = `${Math.max(0, riskScore).toFixed(1)}%`;
        cvRiskLevel.textContent = level;
        cvRecommendations.textContent = recommendations;
        cvResultDiv.style.display = 'block';
    });
}

// --- Signos Vitales ---
function setupVitalSigns() {
    const weightInput = document.getElementById('weight');
    const heightInput = document.getElementById('height');
    const imcOutput = document.getElementById('imc');
    
    function updateIMC() {
        const weight = parseFloat(weightInput?.value);
        const height = parseFloat(heightInput?.value);
        
        if (weight > 0 && height > 0) {
            const heightInMeters = height / 100;
            const imc = weight / (heightInMeters * heightInMeters);
            if (imcOutput) imcOutput.value = imc.toFixed(2);
        } else {
            if (imcOutput) imcOutput.value = '';
        }
    }
    
    weightInput?.addEventListener('input', updateIMC);
    heightInput?.addEventListener('input', updateIMC);
    
    document.getElementById('save-vitals')?.addEventListener('click', () => {
        const patientId = document.getElementById('vitals-patient').value;
        if (!patientId) {
            showNotification('Por favor, seleccione un paciente.', 'warning');
            return;
        }
        
        const temperature = document.getElementById('temperature')?.value;
        const pa = document.getElementById('pa')?.value;
        const fc = document.getElementById('fc')?.value;
        const fr = document.getElementById('fr')?.value;
        const spo2 = document.getElementById('spo2')?.value;
        const weight = document.getElementById('weight')?.value;
        const height = document.getElementById('height')?.value;
        const notes = document.getElementById('notes')?.value;
        
        if (!temperature || !pa || !fc || !fr || !spo2 || !weight || !height) {
            showNotification('Por favor, complete todos los campos de signos vitales.', 'warning');
            return;
        }
        
        showNotification('Signos vitales guardados correctamente.', 'success');
        
        // Limpiar formulario
        document.getElementById('temperature').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('fr').value = '';
        document.getElementById('spo2').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('height').value = '';
        document.getElementById('notes').value = '';
        if (imcOutput) imcOutput.value = '';
    });
    
    document.getElementById('clear-vitals')?.addEventListener('click', () => {
        document.getElementById('temperature').value = '';
        document.getElementById('pa').value = '';
        document.getElementById('fc').value = '';
        document.getElementById('fr').value = '';
        document.getElementById('spo2').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('height').value = '';
        document.getElementById('notes').value = '';
        if (imcOutput) imcOutput.value = '';
    });
}

// --- Recetas ---
function setupPrescriptions() {
    let entryCounter = 1;

    document.getElementById('add-medication')?.addEventListener('click', () => {
        const medicationEntries = document.getElementById('medication-entries');
        if (!medicationEntries) return;
        
        const newEntry = createEl('div', { className: 'medication-entry', 'data-entry': entryCounter }, [
            createEl('div', { className: 'form-row' }, [
                createEl('div', { className: 'form-group flex-grow' }, [
                    createEl('label', { for: `medication-${entryCounter}` }, ['Medicamento']),
                    createEl('input', { type: 'text', id: `medication-${entryCounter}`, className: 'medication-name', placeholder: 'Nombre del medicamento' })
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `dose-${entryCounter}` }, ['Dosis']),
                    createEl('input', { type: 'text', id: `dose-${entryCounter}`, placeholder: '10mg' })
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `frequency-${entryCounter}` }, ['Frecuencia']),
                    createEl('select', { id: `frequency-${entryCounter}` }, [
                        createEl('option', { value: 'once' }, ['1 vez al día']),
                        createEl('option', { value: 'twice' }, ['2 veces al día']),
                        createEl('option', { value: 'thrice' }, ['3 veces al día']),
                        createEl('option', { value: 'four-times' }, ['4 veces al día']),
                        createEl('option', { value: 'as-needed' }, ['Según necesidad'])
                    ])
                ]),
                createEl('div', { className: 'form-group' }, [
                    createEl('label', { for: `duration-${entryCounter}` }, ['Duración']),
                    createEl('input', { type: 'text', id: `duration-${entryCounter}`, placeholder: '7 días' })
                ])
            ]),
            createEl('div', { className: 'form-group' }, [
                createEl('label', { for: `instructions-${entryCounter}` }, ['Instrucciones']),
                createEl('textarea', { id: `instructions-${entryCounter}`, rows: 2, placeholder: 'Tomar después de las comidas...' })
            ]),
            createEl('button', { className: 'btn btn-warning remove-medication', 'data-entry': entryCounter, onclick: function() { removeMedicationEntry(this.dataset.entry); } }, [
                createEl('span', { className: 'material-symbols-outlined' }, ['delete']), 'Eliminar'
            ])
        ]);
        
        medicationEntries.appendChild(newEntry);
        
        // Añadir listener para el nuevo medicamento que active la verificación de interacciones
        newEntry.querySelector('.medication-name')?.addEventListener('input', checkMedicationInteractions);
        entryCounter++;
    });
    
    function checkMedicationInteractions() {
        const medicationInputs = document.querySelectorAll('.medication-name');
        const currentMedications = Array.from(medicationInputs)
            .map(input => input.value.trim())
            .filter(name => name !== '');
        
        const warnings = new Set();
        
        for (let i = 0; i < currentMedications.length; i++) {
            const med1Name = currentMedications[i];
            if (medicamentosDB[med1Name]) {
                const med1Data = medicamentosDB[med1Name];
                for (let j = i + 1; j < currentMedications.length; j++) {
                    const med2Name = currentMedications[j];
                    if (med1Data.interacciones[med2Name]) {
                        const interaction = med1Data.interacciones[med2Name];
                        warnings.add(`${med1Name} - ${med2Name}: ${interaction.descripcion} (<span class="severity-${interaction.severidad}">${interaction.severidad}</span>)`);
                    }
                    // Verificar la interacción inversa también si el segundo medicamento está en DB
                    if (medicamentosDB[med2Name] && medicamentosDB[med2Name].interacciones[med1Name]) {
                        const interaction = medicamentosDB[med2Name].interacciones[med1Name];
                        warnings.add(`${med2Name} - ${med1Name}: ${interaction.descripcion} (<span class="severity-${interaction.severidad}">${interaction.severidad}</span>)`);
                    }
                }
            }
        }
        
        const warningDiv = document.getElementById('interactions-warning');
        const warningList = document.getElementById('interactions-list');
        
        if (warnings.size > 0) {
            warningList.innerHTML = Array.from(warnings).map(warning => `<li>${warning}</li>`).join('');
            if (warningDiv) warningDiv.style.display = 'block';
        } else {
            if (warningDiv) warningDiv.style.display = 'none';
        }
    }
    
    // Verificar interacciones al cambiar el nombre de cualquier medicamento
    document.querySelectorAll('.medication-name').forEach(input => {
        input.addEventListener('input', checkMedicationInteractions);
    });
    
    // Emitir receta
    document.getElementById('issue-prescription')?.addEventListener('click', () => {
        const patientId = document.getElementById('recipe-patient').value;
        if (!patientId) {
            showNotification('Por favor, seleccione un paciente.', 'warning');
            return;
        }
        
        const medicationEntries = document.querySelectorAll('.medication-entry');
        if (medicationEntries.length === 0) {
            showNotification('Por favor, añada al menos un medicamento a la receta.', 'warning');
            return;
        }
        
        const warningDiv = document.getElementById('interactions-warning');
        if (warningDiv && warningDiv.style.display === 'block') {
            const confirmIssue = confirm('Hay interacciones medicamentosas detectadas. ¿Desea continuar con la emisión de la receta?');
            if (!confirmIssue) return;
        }
        
        const patient = simulatedPatients.find(p => p.id === parseInt(patientId));
        showNotification(`Receta emitida para ${patient.nombre} con éxito.`, 'success');
    });
}

function removeMedicationEntry(entryId) {
    const entryElement = document.querySelector(`.medication-entry[data-entry="${entryId}"]`);
    if (entryElement) {
        entryElement.remove();
        checkMedicationInteractions(); // Re-verificar interacciones al eliminar
    }
}

// --- Consultorio Virtual ---
function setupConsultorioVirtual() {
    const searchInput = document.getElementById('search-query');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const searchButton = document.getElementById('search-button');
    const searchResultsContainer = document.getElementById('search-results');
    
    if (!searchInput || !suggestionsContainer || !searchButton || !searchResultsContainer) return;

    // Sugerencias comunes predefinidas
    const commonSuggestions = [
        "cefalea intensa, fotofobia, fiebre", // Meningitis
        "diabetes mellitus tipo 2 tratamiento",
        "metformina mecanismo de acción",
        "protocolo de esclerosis múltiple",
        "parkinson diagnóstico",
        "losartan interacciones",
        "punción lumbar indicaciones",
        "RM cerebral en esclerosis múltiple",
        "síntomas de insuficiencia cardíaca"
    ];
    
    searchInput.addEventListener('focus', showSuggestions);
    searchInput.addEventListener('input', showSuggestions);
    
    function showSuggestions() {
        const query = searchInput.value.toLowerCase().trim();
        if (query === '') {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        const filteredSuggestions = commonSuggestions.filter(suggestion => 
            suggestion.toLowerCase().includes(query)
        );
        
        suggestionsContainer.innerHTML = ''; // Limpiar
        if (filteredSuggestions.length > 0) {
            filteredSuggestions.forEach(suggestion => {
                const div = createEl('div', { className: 'suggestion-item', onclick: () => selectSuggestion(suggestion) }, [
                    highlightText(suggestion, query) // Función para resaltar el texto buscado
                ]);
                suggestionsContainer.appendChild(div);
            });
            suggestionsContainer.style.display = 'block';
        } else {
            suggestionsContainer.style.display = 'none';
        }
    }
    
    function highlightText(text, query) {
        const queryLower = query.toLowerCase();
        const textLower = text.toLowerCase();
        const index = textLower.indexOf(queryLower);
        
        if (index === -1) return document.createTextNode(text);
        
        const span = createEl('span', { className: 'suggestion-highlight' }, [text.substring(index, index + query.length)]);
        const fragment = document.createDocumentFragment();
        fragment.appendChild(document.createTextNode(text.substring(0, index)));
        fragment.appendChild(span);
        fragment.appendChild(document.createTextNode(text.substring(index + query.length)));
        return fragment;
    }
    
    function selectSuggestion(suggestion) {
        searchInput.value = suggestion;
        suggestionsContainer.style.display = 'none';
        performSearch(suggestion);
    }
    
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });
    
    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) performSearch(query);
    });
    
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const query = searchInput.value.trim();
            if (query) performSearch(query);
        }
    });
}

function performSearch(query) {
    if (!query) return;
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;
    
    resultsContainer.innerHTML = '<p>Buscando información para: <strong>' + query + '</strong></p>';
    
    setTimeout(() => {
        const results = searchKnowledgeBase(query);
        displaySearchResults(results, query);
    }, 500);
}

function searchKnowledgeBase(query) {
    const terms = query.toLowerCase().trim().split(/\s+/);
    const results = [];
    
    const calculateRelevance = (text, queryTerms) => {
        let score = 0;
        const lowerText = text.toLowerCase();
        queryTerms.forEach(term => {
            if (lowerText.includes(term)) {
                score += (lowerText.split(term).length - 1); // Contar ocurrencias
            }
        });
        return score;
    };
    
    const addResult = (type, data, score) => {
        if (score > 0) {
            results.push({ type, data, relevance: score });
        }
    };
    
    // Búsqueda en Enfermedades
    medicalKnowledgeBase.diseases.forEach(disease => {
        const text = `${disease.nombre} ${disease.codigoCIE10} ${disease.etiologia} ${disease.fisiopatologia} ${disease.presentacionClinica.join(' ')} ${disease.diagnostico} ${disease.tratamientos.join(' ')} ${disease.pronostico} ${disease.educacionPaciente}`.toLowerCase();
        addResult('disease', disease, calculateRelevance(text, terms));
    });
    
    // Búsqueda en Tratamientos
    medicalKnowledgeBase.treatments.forEach(treatment => {
        const text = `${treatment.nombre} ${treatment.indicaciones.join(' ')} ${treatment.mecanismoAccion} ${treatment.efectosAdversos.join(' ')} ${treatment.interacciones.join(' ')} ${treatment.contraindicaciones.join(' ')}`.toLowerCase();
        addResult('treatment', treatment, calculateRelevance(text, terms));
    });
    
    // Búsqueda en Fármacos (medicamentosDB)
    for (const medName in medicamentosDB) {
        const drug = { nombre: medName, ...medicamentosDB[medName] }; // Adaptar formato
        const text = `${drug.nombre} ${drug.laboratorio} ${drug.mecanismoAccion} ${drug.efectosSecundarios.join(' ')} ${drug.contraindicaciones.join(' ')}`.toLowerCase();
        addResult('drug', drug, calculateRelevance(text, terms));
    }
    
    // Búsqueda en Protocolos
    medicalKnowledgeBase.protocols.forEach(protocol => {
        const text = `${protocol.nombre} ${protocol.area} ${protocol.descripcion} ${protocol.pasos.join(' ')} ${protocol.referencias.join(' ')}`.toLowerCase();
        addResult('protocol', protocol, calculateRelevance(text, terms));
    });
    
    // Búsqueda en Procedimientos
    medicalKnowledgeBase.medicalProcedures.forEach(procedure => {
        const text = `${procedure.nombre} ${procedure.indicaciones.join(' ')} ${procedure.contraindicaciones.join(' ')} ${procedure.riesgos.join(' ')}`.toLowerCase();
        addResult('procedure', procedure, calculateRelevance(text, terms));
    });
    
    // Búsqueda en Pruebas Médicas
    medicalKnowledgeBase.medicalTests.forEach(test => {
        const text = `${test.nombre} ${test.indicaciones.join(' ')} ${test.interpretacion}`.toLowerCase();
        addResult('test', test, calculateRelevance(text, terms));
    });
    
    return results.sort((a, b) => b.relevance - a.relevance);
}

function displaySearchResults(results, originalQuery) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;
    
    if (results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert-card alert-card-warning">
                <span class="material-symbols-outlined alert-icon">search_off</span>
                <div>
                    <strong>No se encontraron resultados</strong> para "${originalQuery}". Por favor, intente con términos más específicos.
                </div>
            </div>
        `;
        return;
    }
    
    resultsContainer.innerHTML = `<p><strong>Resultados para:</strong> "${originalQuery}"</p>`;
    
    results.forEach((result, index) => {
        const resultItem = createEl('div', { className: 'result-item' }, [
            createEl('div', { className: 'result-header' }, [
                createEl('h3', { className: 'result-title' }, [result.data.nombre || result.data.titulo]),
                createEl('span', { className: 'result-type' }, [capitalize(result.type)])
            ]),
            createEl('div', { className: 'result-content' }, [
                (result.type === 'disease' ? 
                    `<p><strong>CIE-10:</strong> ${result.data.codigoCIE10}</p><p><strong>Presentación:</strong> ${result.data.presentacionClinica.slice(0, 3).join(', ')}...</p>` :
                 result.type === 'treatment' ? 
                    `<p><strong>Indicación:</strong> ${result.data.indicaciones[0]}</p><p><strong>Mecanismo:</strong> ${result.data.mecanismoAccion.substring(0, 50)}...</p>` :
                 result.type === 'drug' ?
                    `<p><strong>Laboratorio:</strong> ${result.data.laboratorio}</p><p><strong>Efectos:</strong> ${result.data.efectosSecundarios.slice(0,2).join(', ')}...</p>` :
                 result.type === 'protocol' ? 
                    `<p><strong>Área:</strong> ${result.data.area}</p><p><strong>Descripción:</strong> ${result.data.descripcion.substring(0, 70)}...</p>` :
                 result.type === 'procedure' ?
                    `<p><strong>Indicaciones:</strong> ${result.data.indicaciones.slice(0,2).join(', ')}...</p>` :
                 result.type === 'test' ?
                    `<p><strong>Indicaciones:</strong> ${result.data.indicaciones.slice(0,2).join(', ')}...</p>` : ''
                )
            ]),
            createEl('div', { className: 'result-actions' }, [
                createEl('button', { className: 'btn btn-detail', onclick: () => showDetail(result.type, result.data.id) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['info']), 'Detalles'
                ]),
                (result.data.imagenes && result.data.imagenes.length > 0) ? 
                    createEl('button', { className: 'btn btn-images', onclick: () => showImages(result.data.imagenes) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['image']), 'Imágenes'
                    ]) : null,
                (result.type === 'disease' || result.type === 'protocol') ? 
                    createEl('button', { className: 'btn btn-protocol', onclick: () => showProtocol(result.type, result.data.id) }, [
                        createEl('span', { className: 'material-symbols-outlined' }, ['description']), 'Protocolo'
                    ]) : null,
                createEl('button', { className: 'btn btn-expert', onclick: () => getExpertOpinion(result.type, result.data.nombre || result.data.titulo) }, [
                    createEl('span', { className: 'material-symbols-outlined' }, ['psychology']), 'Segunda Opinión'
                ])
            ].filter(el => el !== null))
        ]);
        resultsContainer.appendChild(resultItem);
    });
}

function showDetail(type, id) {
    let data = null;
    switch(type) {
        case 'disease': data = medicalKnowledgeBase.diseases.find(item => item.id === id); break;
        case 'treatment': data = medicalKnowledgeBase.treatments.find(item => item.id === id); break;
        case 'drug': data = Object.values(medicamentosDB).find(item => item.nombre === id); break; 
        case 'protocol': data = medicalKnowledgeBase.protocols.find(item => item.id === id); break;
        case 'procedure': data = medicalKnowledgeBase.medicalProcedures.find(item => item.id === id); break;
        case 'test': data = medicalKnowledgeBase.medicalTests.find(item => item.id === id); break;
    }
    
    if (!data) {
        showNotification('No se pudo cargar el detalle.', 'error');
        return;
    }
    
    let content = `
        <div class="modal-body modal-detail-content">
    `;
    
    switch(type) {
        case 'disease':
            content += `
                <h3>Código CIE-10: ${data.codigoCIE10}</h3>
                <h4>Etiología</h4><p>${data.etiologia}</p>
                <h4>Fisiopatología</h4><p>${data.fisiopatologia}</p>
                <h4>Epidemiología</h4><p>${data.epidemiologia}</p>
                <h4>Presentación Clínica</h4><ul>${data.presentacionClinica.map(s => `<li>${s}</li>`).join('')}</ul>
                <h4>Diagnóstico</h4><p>${data.diagnostico}</p>
                <h4>Diagnósticos Diferenciales</h4><ul>${data.diagnosticosDiferenciales.map(d => `<li>${d}</li>`).join('')}</ul>
                <h4>Clasificación</h4><p>${data.clasificacion}</p>
                <h4>Tratamientos</h4><ul>${data.tratamientos.map(t => `<li>${t}</li>`).join('')}</ul>
                <h4>Pronóstico</h4><p>${data.pronostico}</p>
                <h4>Educación para el Paciente</h4><p>${data.educacionPaciente}</p>
                <h4>Recursos Adicionales</h4><ul>${data.recursosAdicionales.map(r => `<li><a href="${r}" target="_blank">${r}</a></li>`).join('')}</ul>
            `;
            break;
        case 'treatment':
            content += `
                <h3>Indicaciones</h3><ul>${data.indicaciones.map(i => `<li>${i}</li>`).join('')}</ul>
                <h4>Mecanismo de Acción</h4><p>${data.mecanismoAccion}</p>
                <h4>Farmacocinética/Farmacodinámica</h4><p>${data.farmacocinetica || 'N/A'}</p>
                <h4>Efectos Adversos</h4><ul>${data.efectosAdversos.map(ea => `<li>${ea}</li>`).join('')}</ul>
                <h4>Interacciones</h4><ul>${data.interacciones.map(inter => `<li>${inter}</li>`).join('')}</ul>
                <h4>Contraindicaciones</h4><p>${data.contraindicaciones.join(', ')}</p>
                <h4>Dosis</h4><p>${data.dosis}</p>
                <h4>Vía de Administración</h4><p>${data.viaAdministracion}</p>
            `;
            break;
        case 'drug':
            content += `
                <h3>Laboratorio: ${data.laboratorio}</h3><h3>Precio: $${data.precio.toFixed(2)}</h3>
                <h4>Mecanismo de Acción</h4><p>${data.mecanismoAccion}</p>
                <h4>Contraindicaciones</h4><p>${data.contraindicaciones.join(', ')}</p>
                <h4>Efectos Secundarios</h4><ul>${data.efectosSecundarios.map(es => `<li>${es}</li>`).join('')}</ul>
                <h4>Interacciones</h4><ul>${Object.entries(data.interacciones).map(([med, inter]) => `<li><strong>${med}:</strong> ${inter.descripcion} (<span class="severity-${inter.severidad}">${inter.severidad}</span>)</li>`).join('')}</ul>
            `;
            break;
        case 'protocol':
            content += `
                <h3>Área: ${data.area}</h3>
                <h4>Descripción</h4><p>${data.descripcion}</p>
                <h4>Pasos</h4><ol>${data.pasos.map(paso => `<li>${paso}</li>`).join('')}</ol>
                <h4>Referencias</h4><p>${data.referencias.join(', ')}</p>
            `;
            break;
        case 'procedure':
            content += `
                <h4>Indicaciones</h4><ul>${data.indicaciones.map(ind => `<li>${ind}</li>`).join('')}</ul>
                <h4>Contraindicaciones</h4><ul>${data.contraindicaciones.map(cont => `<li>${cont}</li>`).join('')}</ul>
                <h4>Riesgos</h4><ul>${data.riesgos.map(riesgo => `<li>${riesgo}</li>`).join('')}</ul>
            `;
            break;
        case 'test':
            content += `
                <h4>Indicaciones</h4><ul>${data.indicaciones.map(ind => `<li>${ind}</li>`).join('')}</ul>
                <h4>Interpretación</h4><p>${data.interpretacion}</p>
            `;
            break;
    }
    
    content += `</div>`;
    showModal(`Detalles de ${data.nombre || data.titulo}`, content);
}

function showImages(images) {
    APP_STATE.imageGallery = images;
    APP_STATE.currentImageIndex = 0;
    
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    if (!lightbox || !lightboxImage || !lightboxCaption || !prevBtn || !nextBtn) return;

    updateLightboxImage();
    lightbox.style.display = 'flex';
}

function updateLightboxImage() {
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxCaption = document.getElementById('lightbox-caption');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    
    if (!lightboxImage || !lightboxCaption || !prevBtn || !nextBtn) return;

    const image = APP_STATE.imageGallery[APP_STATE.currentImageIndex];
    lightboxImage.src = image.url;
    lightboxCaption.textContent = image.descripcion;
    
    if (APP_STATE.imageGallery.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
    } else {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
    }
}

// --- Control del DOM ---
document.addEventListener('DOMContentLoaded', () => {
    // Inicializar la aplicación principal
    initializeApp();
    
    // Cargar los selectores de filtros si existen
    loadSpecialties();
    loadRoles();
    loadCategories();
    loadResourceTypes(); // Cargar el nuevo filtro por tipo
    
    // Configurar los buscadores y filtros
    setupPatientFilters();
    setupStaffFilters();
    setupResourceFilters();
    
    // Configurar la navegación
    setupNavigation();
    
    // Configurar el tema
    setupThemeToggle();
    
    // Configurar modales y sus eventos
    setupModals();
    
    // Configurar el consultorio virtual
    setupConsultorioVirtual();
    
    // Configurar calculadoras
    setupCalculators();
    
    // Configurar el módulo de signos vitales
    setupVitalSigns();
    
    // Configurar el módulo de recetas
    setupPrescriptions();
    
    // Configurar el perfil de usuario
    setupUserProfile();
    
    // Configurar el lightbox de imágenes
    document.getElementById('lightbox-close')?.addEventListener('click', () => { document.getElementById('lightbox').style.display = 'none'; });
    document.getElementById('lightbox')?.addEventListener('click', (e) => { if (e.target.id === 'lightbox') document.getElementById('lightbox').style.display = 'none'; });
    document.getElementById('lightbox-next')?.addEventListener('click', () => { if (APP_STATE.imageGallery.length > 0) { APP_STATE.currentImageIndex = (APP_STATE.currentImageIndex + 1) % APP_STATE.imageGallery.length; updateLightboxImage(); } });
    document.getElementById('lightbox-prev')?.addEventListener('click', () => { if (APP_STATE.imageGallery.length > 0) { APP_STATE.currentImageIndex = (APP_STATE.currentImageIndex - 1 + APP_STATE.imageGallery.length) % APP_STATE.imageGallery.length; updateLightboxImage(); } });
    
    // Botones de acción general (ej. añadir)
    document.querySelector('.btn-add-patient')?.addEventListener('click', () => showModal('Nuevo Paciente', generateNewPatientModalContent()));
    document.querySelector('.btn-add-staff')?.addEventListener('click', () => showModal('Nuevo Miembro del Personal', generateNewStaffModalContent()));
    document.querySelector('.btn-add-resource')?.addEventListener('click', () => showModal('Nuevo Recurso Educativo', generateNewResourceModalContent()));
});

// --- Helpers para Modales de Creación (llamados por los botones 'add') ---
function generateNewPatientModalContent() {
    return `
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="new-patient-nombre">Nombre</label>
                    <input type="text" id="new-patient-nombre" required>
                </div>
                <div class="form-group">
                    <label for="new-patient-edad">Edad</label>
                    <input type="number" id="new-patient-edad" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-patient-diagnostico">Diagnóstico Principal</label>
                    <input type="text" id="new-patient-diagnostico" required>
                </div>
                <div class="form-group">
                    <label for="new-patient-especialidad">Especialidad</label>
                    <select id="new-patient-especialidad">
                        <option value="">-- Seleccione Especialidad --</option>
                        <option value="Cardiología">Cardiología</option>
                        <option value="Endocrinología">Endocrinología</option>
                        <option value="Infectología">Infectología</option>
                        <option value="Neurología">Neurología</option>
                        <option value="Pediatría">Pediatría</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="new-patient-alergias">Alergias (separadas por comas)</label>
                <input type="text" id="new-patient-alergias">
            </div>
            <div class="form-group">
                <label for="new-patient-riesgo">Riesgo Cardiovascular</label>
                <select id="new-patient-riesgo">
                    <option value="bajo">Bajo</option>
                    <option value="moderado">Moderado</option>
                    <option value="alto">Alto</option>
                </select>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewPatient()">Crear Paciente</button>
            </div>
        </div>
    `;
}

function generateNewStaffModalContent() {
    return `
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="new-staff-nombre">Nombre</label>
                    <input type="text" id="new-staff-nombre" required>
                </div>
                <div class="form-group">
                    <label for="new-staff-rol">Rol</label>
                    <select id="new-staff-rol">
                        <option value="">-- Seleccione Rol --</option>
                        <option value="Médico">Médico</option>
                        <option value="Enfermero">Enfermero</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-staff-especialidad">Especialidad</label>
                    <input type="text" id="new-staff-especialidad" required>
                </div>
                <div class="form-group">
                    <label for="new-staff-telefono">Teléfono</label>
                    <input type="text" id="new-staff-telefono" required>
                </div>
            </div>
            <div class="form-group">
                <label for="new-staff-email">Email</label>
                <input type="email" id="new-staff-email" required>
            </div>
            <div class="form-group">
                <label for="new-staff-bio">Biografía</label>
                <textarea id="new-staff-bio" rows="3"></textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewStaff()">Crear Miembro</button>
            </div>
        </div>
    `;
}

function generateNewResourceModalContent() {
    return `
        <div class="form-container">
            <div class="form-group">
                <label for="new-resource-titulo">Título</label>
                <input type="text" id="new-resource-titulo" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="new-resource-tipo">Tipo</label>
                    <select id="new-resource-tipo">
                        <option value="">-- Seleccione Tipo --</option>
                        <option value="imagen">Imagen</option>
                        <option value="video">Video</option>
                        <option value="documento">Documento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-resource-categoria">Categoría</label>
                    <select id="new-resource-categoria">
                        <option value="">-- Seleccione Categoría --</option>
                        <option value="curacion">Curación</option>
                        <option value="anatomia">Anatomía</option>
                        <option value="protocolo">Protocolo</option>
                        <option value="educacion">Educación</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="new-resource-url">URL</label>
                <input type="text" id="new-resource-url" required placeholder="https://ejemplo.com/recurso">
            </div>
            <div class="form-group">
                <label for="new-resource-etiquetas">Etiquetas (separadas por comas)</label>
                <input type="text" id="new-resource-etiquetas">
            </div>
            <div class="form-group">
                <label for="new-resource-descripcion">Descripción</label>
                <textarea id="new-resource-descripcion" rows="3"></textarea>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="addNewResource()">Crear Recurso</button>
            </div>
        </div>
    `;
}


// --- Helpers Adicionales ---
function capitalize(str) {
    if (typeof str !== 'string' || str.length === 0) {
        return '';
    }
    return str.charAt(0).toUpperCase() + str.slice(1);
}
<script>
</body>
</html>
