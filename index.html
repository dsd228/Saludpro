<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Enfermería DAVID · Sistema completo con almacenamiento persistente">
    <title>Enfermería DAVID · Sistema Completo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --glass: rgba(15, 30, 40, 0.9);
            --glass-2: rgba(255, 255, 255, 0.1);
            --accent: #00b4d8;
            --accent-2: #0077b6;
            --accent-3: #023e8a;
            --primary-blue: #3a86ff;
            --primary-blue-darker: #00509d;
            --primary-blue-lighter: rgba(58, 134, 255, 0.1);
            --success-green: #38b000;
            --warning-yellow: #ffca3a;
            --alert-red: #d90429;
            --text-light: #e0f7fa;
            --text-dark: #073b4c;
            --muted: #8d99ae;
            --danger: #ef233c;
            --card-radius: 20px;
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 8px 24px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 16px 32px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 32px 64px rgba(0, 0, 0, 0.3);
            --shadow-inset: inset 0 1px 2px rgba(255, 255, 255, 0.1);
            --tap: 48px;
            --font: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            --maxwidth: 1400px;
            --border: rgba(141, 153, 174, 0.3);
            --border-light: rgba(141, 153, 174, 0.2);
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: all 0.2s ease;
            --z-header: 100;
            --z-sidebar: 90;
            --z-modal: 200;
            --gradient-primary: linear-gradient(135deg, #00b4d8, #0077b6);
            --gradient-secondary: linear-gradient(135deg, #3a86ff, #00509d);
            --gradient-success: linear-gradient(135deg, #38b000, #006d21);
            --gradient-warning: linear-gradient(135deg, #ffca3a, #e69500);
            --gradient-danger: linear-gradient(135deg, #d90429, #9d0208);
        }
        
        :root[data-theme="light"] {
            --bg: linear-gradient(135deg, #f0f2f5, #e6e9ef, #d8dee9);
            --glass: rgba(255, 255, 255, 0.95);
            --glass-2: rgba(15, 30, 40, 0.05);
            --accent: #0077b6;
            --accent-2: #00509d;
            --accent-3: #003f7f;
            --primary-blue: #1e3a8a;
            --primary-blue-darker: #1e3a8a;
            --primary-blue-lighter: rgba(30, 58, 138, 0.1);
            --success-green: #16a34a;
            --warning-yellow: #d97706;
            --alert-red: #dc2626;
            --text-light: #073b4c;
            --text-dark: #073b4c;
            --muted: #64748b;
            --border: rgba(100, 116, 139, 0.3);
            --border-light: rgba(100, 116, 139, 0.2);
            --gradient-primary: linear-gradient(135deg, #0077b6, #00509d);
            --gradient-secondary: linear-gradient(135deg, #1e3a8a, #1e3a8a);
            --gradient-success: linear-gradient(135deg, #16a34a, #059669);
            --gradient-warning: linear-gradient(135deg, #d97706, #b45309);
            --gradient-danger: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: var(--transition);
        }
        
        html, body {
            height: 100%;
            margin: 0;
            font-family: var(--font);
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            display: flex;
            justify-content: center;
            padding: 16px;
            color: var(--text-dark);
            overflow-x: hidden;
        }
        
        .app {
            width: 100%;
            max-width: var(--maxwidth);
            height: calc(100vh - 32px);
            display: flex;
            flex-direction: column;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }
        
        header {
            padding: 20px 32px;
            background: rgba(15, 30, 40, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: var(--z-header);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 14px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .brand-icon {
            font-size: 2rem;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(0, 180, 216, 0.5);
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .theme-toggle {
            background: var(--glass-2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 12px;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .theme-toggle:hover {
            background: var(--accent-2);
            transform: translateY(-2px) rotate(15deg);
            box-shadow: var(--shadow-md);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 320px;
            background: var(--glass);
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
            transition: var(--transition);
            position: relative;
            z-index: var(--z-sidebar);
            box-shadow: var(--shadow-sm);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
            color: var(--accent);
        }
        
        .sidebar-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .cat-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }
        
        .cat-btn {
            padding: 18px 22px;
            border: none;
            border-radius: 16px;
            background: var(--glass-2);
            color: var(--text-light);
            font-weight: 500;
            cursor: pointer;
            text-align: left;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .cat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            transition: var(--transition);
        }
        
        .cat-btn:hover {
            background: var(--accent-2);
            color: white;
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        
        .cat-btn:hover::before {
            background: var(--accent);
        }
        
        .cat-btn.active {
            background: var(--accent-2);
            color: white;
            box-shadow: var(--shadow-md);
            font-weight: 600;
        }
        
        .cat-btn.active::before {
            background: var(--accent);
        }
        
        .cat-btn i {
            font-size: 1.6rem;
            width: 28px;
            text-align: center;
            transition: var(--transition);
        }
        
        .cat-btn[data-cat="higiene"] i { color: #4CAF50; }
        .cat-btn[data-cat="curaciones"] i { color: #2196F3; }
        .cat-btn[data-cat="farmaco"] i { color: #9C27B0; }
        .cat-btn[data-cat="emergencias"] i { color: #F44336; }
        .cat-btn[data-cat="movilizacion"] i { color: #FF9800; }
        .cat-btn[data-cat="nutricion"] i { color: #8D6E63; }
        .cat-btn[data-cat="infeccion"] i { color: #795548; }
        .cat-btn[data-cat="medicamentos"] i { color: #009688; }
        .cat-btn[data-cat="enfermedades"] i { color: #607D8B; }
        .cat-btn[data-cat="pae"] i { color: #3F51B5; }
        .cat-btn[data-cat="rcp"] i { color: #E91E63; }
        .cat-btn[data-cat="calculadoras"] i { color: #FF5722; }
        .cat-btn[data-cat="recursos"] i { color: #00BCD4; }
        .cat-btn[data-cat="pacientes"] i { color: #673AB7; }
        
        .small {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 10px;
            line-height: 1.5;
            opacity: 0.9;
        }
        
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--glass);
            backdrop-filter: blur(10px);
        }
        
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            position: sticky;
            top: 92px;
            background: var(--glass);
            padding: 12px 0;
            z-index: 50;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .input {
            flex: 1;
            padding: 16px 20px;
            border: 1px solid var(--border-light);
            border-radius: 16px;
            font-family: var(--font);
            font-size: 1.05rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
        }
        
        .input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
            font-size: 1.05rem;
            transition: var(--transition);
        }
        
        .btn.primary {
            background: var(--gradient-primary);
            color: white;
            border: 1px solid rgba(0, 119, 182, 0.3);
        }
        
        .btn.primary:hover {
            background: var(--gradient-secondary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .btn.secondary {
            background: var(--gradient-secondary);
            color: white;
            border: 1px solid rgba(30, 58, 138, 0.3);
        }
        
        .btn.secondary:hover {
            background: var(--primary-blue-darker);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .btn.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        
        .btn.ghost:hover {
            background: var(--glass-2);
            transform: translateY(-3px);
        }
        
        .btn.small {
            padding: 10px 14px;
            font-size: 0.95rem;
        }
        
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .category-card {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .category-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
        }
        
        .category-card h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }
        
        .category-card h2 i {
            font-size: 1.7rem;
        }
        
        .category-card h3 {
            color: var(--accent-2);
            margin: 20px 0 12px 0;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.3px;
        }
        
        .category-card h4 {
            color: var(--primary-blue);
            margin: 12px 0 8px 0;
            font-size: 1.15rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .procedure {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
            position: relative;
        }
        
        .procedure::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--accent);
            transition: var(--transition);
        }
        
        .procedure:hover::after {
            width: 100%;
        }
        
        .procedure:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .procedure h3 {
            color: var(--accent-2);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .procedure h3 i {
            font-size: 1.3rem;
            color: var(--accent);
        }
        
        .procedure p {
            margin: 6px 0;
            color: var(--text-light);
            line-height: 1.6;
            font-size: 1.02rem;
        }
        
        .procedure .summary {
            font-style: italic;
            color: var(--muted);
            margin-bottom: 12px;
            padding: 16px;
            background: var(--primary-blue-lighter);
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
            border: 1px solid var(--border-light);
        }
        
        .procedure .summary i {
            color: var(--primary-blue);
            margin-right: 8px;
        }
        
        .materials, .steps, .notes {
            margin: 12px 0;
        }
        
        .materials ul, .steps ol {
            margin: 10px 0;
            padding-left: 28px;
        }
        
        .materials li, .steps li {
            margin: 6px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            line-height: 1.5;
        }
        
        .materials li::before, .steps li::before {
            content: "•";
            color: var(--accent);
            font-weight: bold;
            margin-top: 6px;
            font-size: 1.2rem;
        }
        
        .steps li::before {
            content: counter(step);
            counter-increment: step;
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 4px;
        }
        
        .notes {
            background: var(--primary-blue-lighter);
            padding: 18px 22px;
            border-radius: 14px;
            border-left: 4px solid var(--primary-blue);
            margin: 14px 0;
            font-size: 0.98rem;
            border: 1px solid var(--border-light);
        }
        
        .notes i {
            color: var(--primary-blue);
            margin-right: 10px;
        }
        
        .disease-panel {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .disease-panel h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .disease-panel h2 i {
            font-size: 1.7rem;
        }
        
        .disease-item {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
            position: relative;
        }
        
        .disease-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--accent);
            transition: var(--transition);
        }
        
        .disease-item:hover::after {
            width: 100%;
        }
        
        .disease-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .disease-item strong {
            color: var(--accent-2);
            font-size: 1.15rem;
            font-weight: 600;
        }
        
        .disease-item .small {
            font-size: 0.98rem;
            color: var(--muted);
            margin-top: 8px;
            line-height: 1.6;
        }
        
        .disease-item .small i {
            color: var(--primary-blue);
            margin-right: 6px;
        }
        
        .med-combo {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .med-combo h2 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .med-combo h2 i {
            font-size: 1.7rem;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 240px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.05rem;
        }
        
        .form-group label i {
            color: var(--accent);
            font-size: 1.15rem;
        }
        
        select.form-control, input.form-control {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border-light);
            border-radius: 16px;
            font-family: var(--font);
            font-size: 1.05rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
        }
        
        select.form-control:focus, input.form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .interactions-warning {
            background: rgba(255, 202, 58, 0.15);
            border: 1px solid rgba(255, 202, 58, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            animation: fadeIn 0.4s ease;
            backdrop-filter: blur(10px);
            border-left: 4px solid var(--warning-yellow);
        }
        
        .interactions-warning.danger {
            background: rgba(217, 4, 41, 0.15);
            border: 1px solid rgba(217, 4, 41, 0.3);
            color: #f8d7da;
            border-left: 4px solid var(--alert-red);
        }
        
        .interactions-warning.success {
            background: rgba(56, 176, 0, 0.15);
            border: 1px solid rgba(56, 176, 0, 0.3);
            color: #d1f7e5;
            border-left: 4px solid var(--success-green);
        }
        
        .interactions-warning i {
            font-size: 1.6rem;
            margin-top: 4px;
        }
        
        .interactions-warning.danger i {
            color: var(--alert-red);
        }
        
        .interactions-warning.success i {
            color: var(--success-green);
        }
        
        .interactions-list {
            margin: 10px 0 0 48px;
            flex: 1;
        }
        
        .interactions-list li {
            margin: 8px 0;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }
        
        .interactions-list li:last-child {
            border-bottom: none;
        }
        
        .interactions-list li a {
            color: var(--accent);
            text-decoration: none;
            margin-left: 8px;
        }
        
        .interactions-list li a:hover {
            text-decoration: underline;
        }
        
        .pae-form {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .pae-form h2 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .pae-form h2 i {
            font-size: 1.7rem;
        }
        
        .rcp-guide {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .rcp-guide h2 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .rcp-guide h2 i {
            font-size: 1.7rem;
        }
        
        .rcp-step {
            margin-bottom: 24px;
            padding-left: 36px;
            position: relative;
            transition: var(--transition);
            padding: 16px 20px;
            background: rgba(58, 134, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
            border: 1px solid var(--border-light);
        }
        
        .rcp-step:hover {
            background: rgba(58, 134, 255, 0.1);
            transform: translateX(8px);
        }
        
        .rcp-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            z-index: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .score-result {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            text-align: center;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .score-result h3 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .score-value {
            font-size: 2.4rem;
            font-weight: bold;
            color: var(--accent);
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0, 180, 216, 0.3);
            font-family: 'Courier New', monospace;
        }
        
        .score-category {
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--accent-2);
        }
        
        .tab-container {
            margin-top: 24px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 24px;
            border-radius: 16px 16px 0 0;
            overflow: hidden;
            background: var(--glass-2);
            border: 1px solid var(--border-light);
        }
        
        .tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--muted);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            background: transparent;
            flex: 1;
            text-align: center;
        }
        
        .tab:first-child {
            border-radius: 16px 0 0 0;
        }
        
        .tab:last-child {
            border-radius: 0 16px 0 0;
        }
        
        .tab:hover {
            background: var(--accent-2);
            color: white;
        }
        
        .tab.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
            background: rgba(0, 180, 216, 0.1);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .calculator-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .calculator-form {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .calculator-form:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
        }
        
        .calculator-form h3 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .calculator-form h3 i {
            font-size: 1.5rem;
        }
        
        .patient-list {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .patient-list h2 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .patient-list h2 i {
            font-size: 1.7rem;
        }
        
        .patient-card {
            background: var(--primary-blue-lighter);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 5px solid var(--primary-blue);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-light);
        }
        
        .patient-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(58, 134, 255, 0.1));
            opacity: 0;
            transition: var(--transition);
        }
        
        .patient-card:hover {
            transform: translateX(8px);
            background: rgba(58, 134, 255, 0.18);
        }
        
        .patient-card:hover::before {
            opacity: 1;
        }
        
        .patient-card::after {
            content: "→";
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: var(--transition);
            color: var(--primary-blue);
            font-weight: bold;
        }
        
        .patient-card:hover::after {
            opacity: 1;
        }
        
        .patient-card:last-child {
            margin-bottom: 0;
        }
        
        .patient-card h3 {
            color: var(--primary-blue-darker);
            margin-bottom: 8px;
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .patient-card h3 i {
            color: var(--primary-blue);
            font-size: 1.3rem;
        }
        
        .patient-card p {
            margin: 4px 0;
            font-size: 0.98rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .patient-card p i {
            color: var(--muted);
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }
        
        .resource-panel {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            margin-top: 24px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .resource-panel h2 {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .resource-panel h2 i {
            font-size: 1.7rem;
        }
        
        .resource-card {
            background: var(--primary-blue-lighter);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 5px solid var(--primary-blue);
            transition: var(--transition);
            border: 1px solid var(--border-light);
        }
        
        .resource-card:hover {
            transform: translateX(8px);
            background: rgba(58, 134, 255, 0.18);
        }
        
        .resource-card:last-child {
            margin-bottom: 0;
        }
        
        .resource-card h3 {
            color: var(--primary-blue-darker);
            margin-bottom: 8px;
            font-size: 1.15rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .resource-card h3 i {
            color: var(--primary-blue);
            font-size: 1.3rem;
        }
        
        .resource-card p {
            margin: 4px 0;
            font-size: 0.98rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resource-card p i {
            color: var(--muted);
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
        }
        
        .resource-card a {
            display: inline-block;
            margin-top: 12px;
            padding: 10px 16px;
            background: var(--gradient-secondary);
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            border: 1px solid rgba(30, 58, 138, 0.3);
        }
        
        .resource-card a:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .welcome-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .welcome-card {
            background: var(--glass-2);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .welcome-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(0, 180, 216, 0.1));
            opacity: 0;
            transition: var(--transition);
        }
        
        .welcome-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        
        .welcome-card:hover::before {
            opacity: 1;
        }
        
        .welcome-card i {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 16px;
            transition: var(--transition);
        }
        
        .welcome-card:hover i {
            transform: scale(1.1);
        }
        
        .welcome-card h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .welcome-card p {
            color: var(--muted);
            font-size: 0.98rem;
            line-height: 1.6;
        }
        
        .rcp-controls {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .rcp-timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            background: rgba(0, 180, 216, 0.1);
            padding: 16px;
            border-radius: 16px;
            border: 2px solid var(--accent);
            box-shadow: var(--shadow-sm);
        }
        
        .rcp-state {
            font-size: 1rem;
            color: var(--muted);
            margin-bottom: 16px;
            text-align: center;
        }
        
        .detailed-info {
            background: rgba(58, 134, 255, 0.08);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            font-size: 0.98rem;
        }
        
        .detailed-info h4 {
            color: var(--primary-blue);
            margin: 12px 0 8px 0;
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detailed-info p {
            margin: 6px 0;
            color: var(--text-light);
            line-height: 1.6;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: var(--z-modal);
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: var(--glass);
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--card-radius);
            width: 90%;
            max-width: 700px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            background: none;
            border: none;
        }
        
        .close-modal:hover {
            color: var(--alert-red);
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            background: var(--glass-2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 12px;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .mobile-menu-btn:hover {
            background: var(--accent-2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        /* Patient form styles */
        .patient-form-container {
            padding: 20px 0;
        }
        
        .patient-form-container .form-row {
            margin-bottom: 20px;
        }
        
        .patient-form-container .form-group {
            margin-bottom: 15px;
        }
        
        .patient-form-container textarea {
            width: 100%;
            min-height: 100px;
            padding: 16px 20px;
            border: 1px solid var(--border-light);
            border-radius: 16px;
            font-family: var(--font);
            font-size: 1.05rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
            resize: vertical;
        }
        
        .patient-form-container textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-light);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 1024px) {
            .app {
                border-radius: 16px;
            }
            
            .category-card, .disease-panel, .med-combo, .pae-form, .rcp-guide, .patient-list, .resource-panel {
                border-radius: 16px;
                padding: 24px;
            }
            
            .calculator-container {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 280px;
                border-right: none;
                border-bottom: 1px solid var(--border);
                position: relative;
                z-index: 60;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .calculator-container {
                grid-template-columns: 1fr;
            }
            
            .welcome-actions {
                grid-template-columns: 1fr;
            }
            
            .rcp-controls {
                flex-direction: column;
            }
            
            header {
                padding: 16px;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .app {
                border-radius: 12px;
            }
            
            .category-card, .disease-panel, .med-combo, .pae-form, .rcp-guide, .patient-list, .resource-panel {
                border-radius: 12px;
                padding: 20px;
            }
            
            .mobile-menu-btn {
                display: flex;
            }
            
            .sidebar.hidden-mobile {
                display: none;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .app {
                border-radius: 12px;
            }
            
            .category-card, .disease-panel, .med-combo, .pae-form, .rcp-guide, .patient-list, .resource-panel {
                border-radius: 12px;
                padding: 16px;
            }
            
            .cat-btn {
                padding: 14px 18px;
                font-size: 0.95rem;
            }
            
            .input, .btn {
                font-size: 0.95rem;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            .modal-content {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1><i class="fas fa-microscope brand-icon"></i> Enfermería DAVID · Sistema Completo</h1>
            <div class="controls">
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>
        
        <div class="container">
            <nav class="sidebar" id="sidebar" aria-label="Categorías">
                <div class="sidebar-header">
                    <i class="fas fa-th-large"></i>
                    <h3>Funcionalidades</h3>
                </div>
                <div class="cat-grid" role="navigation">
                    <button class="cat-btn" data-cat="higiene">
                        <i class="fas fa-soap"></i>
                        Higiene Clínica
                    </button>
                    <button class="cat-btn" data-cat="curaciones">
                        <i class="fas fa-band-aid"></i>
                        Curaciones Avanzadas
                    </button>
                    <button class="cat-btn" data-cat="farmaco">
                        <i class="fas fa-pills"></i>
                        Farmacología
                    </button>
                    <button class="cat-btn" data-cat="emergencias">
                        <i class="fas fa-ambulance"></i>
                        Emergencias Médicas
                    </button>
                    <button class="cat-btn" data-cat="movilizacion">
                        <i class="fas fa-wheelchair"></i>
                        Movilización
                    </button>
                    <button class="cat-btn" data-cat="nutricion">
                        <i class="fas fa-utensils"></i>
                        Nutrición
                    </button>
                    <button class="cat-btn" data-cat="infeccion">
                        <i class="fas fa-virus"></i>
                        Control Infecciones
                    </button>
                    <button class="cat-btn" data-cat="medicamentos">
                        <i class="fas fa-prescription-bottle-alt"></i>
                        Medicamentos
                    </button>
                    <button class="cat-btn" data-cat="enfermedades">
                        <i class="fas fa-notes-medical"></i>
                        Enfermedades
                    </button>
                    <button class="cat-btn" data-cat="pae">
                        <i class="fas fa-clipboard-list"></i>
                        PAE Avanzado
                    </button>
                    <button class="cat-btn" data-cat="rcp">
                        <i class="fas fa-heartbeat"></i>
                        RCP Integral
                    </button>
                    <button class="cat-btn" data-cat="calculadoras">
                        <i class="fas fa-calculator"></i>
                        Calculadoras Clínicas
                    </button>
                    <button class="cat-btn" data-cat="recursos">
                        <i class="fas fa-book"></i>
                        Recursos Educativos
                    </button>
                    <button class="cat-btn active" data-cat="pacientes">
                        <i class="fas fa-users"></i>
                        Gestión de Pacientes
                    </button>
                </div>
                <div class="small">
                    Seleccione una categoría para acceder a procedimientos, guías clínicas, combinador de fármacos, enfermedades y más funciones especializadas.
                </div>
            </nav>
            
            <main class="panel" id="mainPanel" aria-live="polite">
                <div class="search-container">
                    <input id="globalSearch" class="input" placeholder="Buscar procedimiento, enfermedad, medicamento o paciente..." aria-label="Buscar">
                    <button id="searchBtn" class="btn primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <button id="openAllBtn" class="btn secondary">
                        <i class="fas fa-expand"></i> Mostrar Todo
                    </button>
                </div>
                
                <div class="content-area" id="contentArea">
                    <!-- Panel de pacientes como vista principal -->
                    <div class="patient-list" id="pacientes">
                        <h2><i class="fas fa-users"></i> Gestión Integral de Pacientes</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patient-search"><i class="fas fa-search"></i> Buscar paciente por nombre</label>
                                <input type="text" id="patient-search" class="form-control" placeholder="Nombre del paciente...">
                            </div>
                            <div class="form-group">
                                <label for="patient-specialty"><i class="fas fa-stethoscope"></i> Especialidad médica</label>
                                <select id="patient-specialty" class="form-control">
                                    <option value="">Todas las especialidades</option>
                                    <option value="Cardiología">Cardiología</option>
                                    <option value="Neumología">Neumología</option>
                                    <option value="Endocrinología">Endocrinología</option>
                                    <option value="Neurología">Neurología</option>
                                    <option value="Oncología">Oncología</option>
                                    <option value="Nefrología">Nefrología</option>
                                    <option value="Gastroenterología">Gastroenterología</option>
                                    <option value="Reumatología">Reumatología</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap">
                            <button id="addPatientBtn" class="btn primary">
                                <i class="fas fa-plus"></i> Agregar Nuevo Paciente
                            </button>
                            <button id="exportPatientsBtn" class="btn secondary">
                                <i class="fas fa-file-export"></i> Exportar Pacientes
                            </button>
                        </div>
                        <div id="patients-container"></div>
                    </div>
                </div>
                
                <!-- Panel de enfermedades -->
                <div class="disease-panel" id="diseasePanel" style="display:none;">
                    <h2><i class="fas fa-notes-medical"></i> Enfermedades y Condiciones Clínicas</h2>
                    <div id="diseaseResults"></div>
                    <div style="margin-top:16px">
                        <button id="wikiFetchBtn" class="btn primary">
                            <i class="fas fa-wikipedia-w"></i> Buscar en Wikipedia
                        </button>
                        <div id="wikiOutput" class="small" style="margin-top:12px"></div>
                    </div>
                </div>
                
                <!-- Combinador de fármacos -->
                <div class="med-combo" id="medCombo" style="display:none;">
                    <h2><i class="fas fa-prescription-bottle-alt"></i> Combinador de Fármacos Inteligente</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="medSearchBox"><i class="fas fa-search"></i> Búsqueda Rápida de Fármaco</label>
                            <input type="text" id="medSearchBox" class="form-control" placeholder="Buscar fármaco por nombre...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="medSelectA"><i class="fas fa-capsules"></i> Medicamento A</label>
                            <select id="medSelectA" class="form-control">
                                <option value="">Seleccionar medicamento...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="medSelectB"><i class="fas fa-capsules"></i> Medicamento B</label>
                            <select id="medSelectB" class="form-control">
                                <option value="">Seleccionar medicamento...</option>
                            </select>
                        </div>
                    </div>
                    <button id="checkInteractionsBtn" class="btn primary">
                        <i class="fas fa-exchange-alt"></i> Verificar Interacciones
                    </button>
                    <div id="medAlert" style="margin-top:24px;"></div>
                    <details style="margin-top:14px">
                        <summary class="small">
                            <i class="fas fa-exclamation-triangle"></i> Lista de Combinaciones Críticas (Nunca combinar)
                        </summary>
                        <div id="neverList" style="margin-top:12px;max-height:320px;overflow:auto;padding: 8px 0;"></div>
                    </details>
                </div>
                
                <!-- Formulario PAE -->
                <div class="pae-form" id="paeForm" style="display:none;">
                    <h2><i class="fas fa-clipboard-list"></i> Plan de Atención de Enfermería Avanzado</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName"><i class="fas fa-user"></i> Nombre del Paciente</label>
                            <input type="text" id="patientName" class="form-control" placeholder="Nombre completo del paciente">
                        </div>
                        <div class="form-group">
                            <label for="patientAge"><i class="fas fa-birthday-cake"></i> Edad</label>
                            <input type="number" id="patientAge" class="form-control" placeholder="Edad en años">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="diagnosis"><i class="fas fa-diagnoses"></i> Diagnóstico Médico Principal</label>
                        <input type="text" id="diagnosis" class="form-control" placeholder="Diagnóstico médico principal">
                    </div>
                    <div class="form-group">
                        <label for="nursingDiagnosis"><i class="fas fa-stethoscope"></i> Diagnóstico de Enfermería</label>
                        <select id="nursingDiagnosis" class="form-control">
                            <option value="">Seleccionar diagnóstico de enfermería...</option>
                            <option value="dolor">Dolor agudo</option>
                            <option value="riesgo-caidas">Riesgo de caídas</option>
                            <option value="alteracion-ventilacion">Alteración de la ventilación espontánea</option>
                            <option value="integridad-cutanea">Riesgo de deterioro de la integridad cutánea</option>
                            <option value="nutricion">Desequilibrio de la nutrición</option>
                            <option value="ansiedad">Ansiedad</option>
                            <option value="movilidad">Alteración de la movilidad física</option>
                            <option value="perfusión">Riesgo de perfusión tisular ineficaz</option>
                            <option value="termorregulacion">Alteración de la termorregulación</option>
                            <option value="eliminacion">Alteración de la eliminación urinaria</option>
                            <option value="comunicacion">Alteración de la comunicación verbal</option>
                            <option value="sueño">Alteración del patrón del sueño</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="goals"><i class="fas fa-bullseye"></i> Objetivos Específicos</label>
                            <textarea id="goals" class="form-control" rows="3" placeholder="Objetivos a alcanzar (específicos, medibles, alcanzables, relevantes y con tiempo definido)..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="interventions"><i class="fas fa-hand-holding-medical"></i> Intervenciones de Enfermería</label>
                            <textarea id="interventions" class="form-control" rows="3" placeholder="Intervenciones de enfermería basadas en evidencia..."></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="pae_name"><i class="fas fa-file-signature"></i> Nombre del PAE</label>
                            <input type="text" id="pae_name" class="form-control" placeholder="Nombre descriptivo del plan">
                        </div>
                        <div class="form-group">
                            <label for="pae_diag"><i class="fas fa-diagnoses"></i> Diagnóstico Clínico</label>
                            <input type="text" id="pae_diag" class="form-control" placeholder="Diagnóstico principal del paciente">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="pae_plan"><i class="fas fa-clipboard"></i> Plan de Cuidados Detallado</label>
                        <textarea id="pae_plan" class="form-control" rows="5" placeholder="Descripción detallada del plan de cuidados, incluyendo evaluación, intervenciones, evaluación de resultados y seguimiento..."></textarea>
                    </div>
                    <div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
                        <button id="generatePaeBtn" class="btn primary">
                            <i class="fas fa-magic"></i> Generar PAE Inteligente
                        </button>
                        <button id="savePaeBtn" class="btn secondary">
                            <i class="fas fa-save"></i> Guardar PAE
                        </button>
                        <button id="exportPaeBtn" class="btn ghost">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                    </div>
                    <div id="paeMsg" class="small" style="margin-top:12px"></div>
                </div>
                
                <!-- Guía de RCP -->
                <div class="rcp-guide" id="rcpGuide" style="display:none;">
                    <h2><i class="fas fa-heartbeat"></i> RCP Integral (Adulto)</h2>
                    <div class="rcp-step" data-step="1">
                        <strong>Verificar Seguridad del Entorno</strong>
                        <p>Asegúrese de que el área es segura para usted y el paciente antes de intervenir. Evalúe riesgos ambientales como fuego, electricidad, sustancias tóxicas o tráfico.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Protocolo de Seguridad</h4>
                            <p>Utilice equipo de protección personal (EPP) si hay riesgo de exposición a fluidos corporales. Si el paciente está en un entorno peligroso, mueva al paciente solo si es absolutamente necesario y seguro hacerlo.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="2">
                        <strong>Comprobar Respuesta del Paciente</strong>
                        <p>Agite suavemente los hombros y pregunte "¿Está bien?". If no hay respuesta, proceda inmediatamente.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Evaluación de Respuesta</h4>
                            <p>Observe movimientos, sonidos o respuestas a estímulos. Si el paciente responde, colóquelo en posición lateral de seguridad y monitoree signos vitales. Si no responde, inicie RCP inmediatamente.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="3">
                        <strong>Llamar a Emergencias</strong>
                        <p>Si está solo, grite pidiendo ayuda. Si hay alguien más, pídale que llame al 112 y traiga un DEA. Si está solo, llame usted mismo después de 2 minutos de RCP.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Comunicación con Emergencias</h4>
                            <p>Proporcione información clara: ubicación exacta, número de víctimas, estado de las víctimas y tipo de ayuda requerida. No cuelgue hasta que el operador lo indique.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="4">
                        <strong>Iniciar Compresiones Torácicas</strong>
                        <p>Coloque las manos en el centro del pecho. Comprima a una profundidad de 5-6 cm a una velocidad de 100-120 por minuto. Permita la expansión torácica completa entre compresiones.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Técnica de Compresión</h4>
                            <p>Coloque el talón de una mano en el centro del pecho (borde inferior del esternón), coloque la otra mano encima, entrelace los dedos y mantenga los brazos rectos. Use su peso corporal, no solo los brazos. Minimice las interrupciones en las compresiones.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="5">
                        <strong>Apertura de Vía Aérea y Ventilaciones</strong>
                        <p>Después de 30 compresiones, abra la vía aérea con la maniobra frente-mentón. Dé 2 ventilaciones de 1 segundo cada una, observando la elevación del tórax.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Ventilación Efectiva</h4>
                            <p>Pellizque la nariz del paciente, tome una respiración normal y selle su boca sobre la del paciente. Insufle durante 1 segundo hasta ver la elevación del tórax. Evite la hiperventilación. Si no puede dar ventilaciones, continúe con compresiones torácicas solamente.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="6">
                        <strong>Usar DEA si Disponible</strong>
                        <p>Siga las instrucciones del DEA. Aplique los parches, asegúrese de que nadie toque al paciente, analice el ritmo y siga las instrucciones de descarga.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Protocolo DEA</h4>
                            <p>Encienda el DEA y siga las instrucciones auditivas y visuales. Coloque un parche debajo de la clavícula derecha y el otro en la zona lateral izquierda del tórax, debajo del pezón. No toque al paciente durante el análisis del ritmo ni durante la descarga.</p>
                        </div>
                    </div>
                    <div class="rcp-step" data-step="7">
                        <strong>Continuar RCP</strong>
                        <p>Continúe con ciclos de 30:2 (30 compresiones, 2 ventilaciones) hasta que llegue ayuda, el paciente reaccione o esté exhausto.</p>
                        <div class="detailed-info">
                            <h4><i class="fas fa-info-circle"></i> Monitoreo y Cambio de Reanimador</h4>
                            <p>Cambie al reanimador cada 2 minutos para mantener la calidad de las compresiones. Monitoree constantemente la respuesta del paciente. Si el paciente comienza a moverse, respirar normalmente o responder, colóquelo en posición lateral de seguridad y monitoree signos vitales.</p>
                        </div>
                    </div>
                    <div class="rcp-controls">
                        <div class="rcp-state" id="rcpState">Estado: detenido</div>
                        <div class="rcp-timer" id="rcpTimer">00:00</div>
                        <button id="rcpStart" class="btn primary">
                            <i class="fas fa-play"></i> Iniciar RCP
                        </button>
                        <button id="rcpStop" class="btn ghost">
                            <i class="fas fa-stop"></i> Detener
                        </button>
                    </div>
                </div>
                
                <!-- Calculadoras -->
                <div class="calculator-container" id="calculadoras" style="display:none;">
                    <div class="calculator-form">
                        <h3><i class="fas fa-weight"></i> IMC (Índice de Masa Corporal)</h3>
                        <div class="form-group">
                            <label for="imc_weight"><i class="fas fa-weight-hanging"></i> Peso (kg)</label>
                            <input type="number" id="imc_weight" class="form-control" placeholder="Ej: 70">
                        </div>
                        <div class="form-group">
                            <label for="imc_height"><i class="fas fa-ruler-vertical"></i> Altura (cm)</label>
                            <input type="number" id="imc_height" class="form-control" placeholder="Ej: 170">
                        </div>
                        <button id="calculateImc" class="btn primary" style="margin-top:24px;">
                            <i class="fas fa-calculator"></i> Calcular IMC
                        </button>
                        <div id="imc-result" style="margin-top:24px;display:none;">
                            <div class="score-value" id="imc-value"></div>
                            <div class="score-category" id="imc-category"></div>
                            <div class="detailed-info" style="margin-top:16px;">
                                <h4><i class="fas fa-info-circle"></i> Clasificación del IMC</h4>
                                <p><strong>Bajo peso:</strong> &lt; 18.5</p>
                                <p><strong>Peso normal:</strong> 18.5-24.9</p>
                                <p><strong>Sobrepeso:</strong> 25-29.9</p>
                                <p><strong>Obesidad grado I:</strong> 30-34.9</p>
                                <p><strong>Obesidad grado II:</strong> 35-39.9</p>
                                <p><strong>Obesidad grado III:</strong> ≥ 40</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calculator-form">
                        <h3><i class="fas fa-filter"></i> Filtración Glomerular (CKD-EPI)</h3>
                        <div class="form-group">
                            <label for="creatinine"><i class="fas fa-vial"></i> Creatinina (mg/dL)</label>
                            <input type="number" id="creatinine" class="form-control" placeholder="Ej: 1.0">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-venus-mars"></i> Sexo</label>
                            <div style="display:flex;gap:20px;margin-top:10px;">
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="radio" name="sex" value="male" checked> 
                                    <i class="fas fa-male"></i> Hombre
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;">
                                    <input type="radio" name="sex" value="female"> 
                                    <i class="fas fa-female"></i> Mujer
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="age"><i class="fas fa-birthday-cake"></i> Edad</label>
                            <input type="number" id="age" class="form-control" placeholder="Ej: 45">
                        </div>
                        <button id="calculateFiltration" class="btn primary" style="margin-top:24px;">
                            <i class="fas fa-calculator"></i> Calcular Filtración
                        </button>
                        <div id="filtration-result" style="margin-top:24px;display:none;">
                            <div class="score-value" id="filtration-value"></div>
                            <div class="score-category" id="filtration-category"></div>
                            <div class="detailed-info" style="margin-top:16px;">
                                <h4><i class="fas fa-info-circle"></i> Clasificación de la Función Renal</h4>
                                <p><strong>Normal o aumentado:</strong> ≥ 90 ml/min/1.73m²</p>
                                <p><strong>Levemente disminuido:</strong> 60-89 ml/min/1.73m²</p>
                                <p><strong>Moderadamente disminuido:</strong> 30-59 ml/min/1.73m²</p>
                                <p><strong>Severamente disminuido:</strong> 15-29 ml/min/1.73m²</p>
                                <p><strong>Insuficiencia renal:</strong> &lt; 15 ml/min/1.73m²</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calculator-form">
                        <h3><i class="fas fa-heart"></i> SCORE (Riesgo Cardiovascular)</h3>
                        <div class="form-group">
                            <label for="score_age"><i class="fas fa-birthday-cake"></i> Edad</label>
                            <input type="number" id="score_age" class="form-control" placeholder="Ej: 55">
                        </div>
                        <div class="form-group">
                            <label for="total-cholesterol"><i class="fas fa-vial"></i> Colesterol total (mg/dL)</label>
                            <input type="number" id="total-cholesterol" class="form-control" placeholder="Ej: 220">
                        </div>
                        <div class="form-group">
                            <label for="hdl-cholesterol"><i class="fas fa-vial"></i> HDL Colesterol (mg/dL)</label>
                            <input type="number" id="hdl-cholesterol" class="form-control" placeholder="Ej: 50">
                        </div>
                        <div class="form-group">
                            <label for="systolic-pressure"><i class="fas fa-heartbeat"></i> Presión sistólica (mmHg)</label>
                            <input type="number" id="systolic-pressure" class="form-control" placeholder="Ej: 140">
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:12px;">
                                <input type="checkbox" id="smoker"> 
                                <i class="fas fa-smoking"></i> Fumador
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:12px;">
                                <input type="checkbox" id="diabetes"> 
                                <i class="fas fa-diabetes"></i> Diabetes
                            </label>
                        </div>
                        <button id="calculateScore" class="btn primary" style="margin-top:24px;">
                            <i class="fas fa-calculator"></i> Calcular SCORE
                        </button>
                        <div id="score-result" style="margin-top:24px;display:none;">
                            <div class="score-value" id="score-value"></div>
                            <div class="score-category" id="score-category"></div>
                            <div class="detailed-info" style="margin-top:16px;">
                                <h4><i class="fas fa-info-circle"></i> Clasificación del Riesgo Cardiovascular</h4>
                                <p><strong>Bajo riesgo:</strong> &lt; 1% de riesgo a 10 años</p>
                                <p><strong>Riesgo bajo:</strong> 1-2% de riesgo a 10 años</p>
                                <p><strong>Riesgo moderado:</strong> 3-5% de riesgo a 10 años</p>
                                <p><strong>Riesgo alto:</strong> 6-10% de riesgo a 10 años</p>
                                <p><strong>Riesgo muy alto:</strong> > 10% de riesgo a 10 años</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recursos educativos -->
                <div class="resource-panel" id="recursos" style="display:none;">
                    <h2><i class="fas fa-book"></i> Recursos Educativos Clínicos</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="resource-search"><i class="fas fa-search"></i> Buscar recurso por título o etiqueta</label>
                            <input type="text" id="resource-search" class="form-control" placeholder="Título, etiqueta o contenido...">
                        </div>
                        <div class="form-group">
                            <label for="resource-category"><i class="fas fa-tags"></i> Categoría de recurso</label>
                            <select id="resource-category" class="form-control">
                                <option value="">Todas las categorías</option>
                                <option value="Protocolos">Protocolos Clínicos</option>
                                <option value="Guías">Guías de Práctica</option>
                                <option value="Videos">Videos Educativos</option>
                                <option value="Imágenes">Imágenes Médicas</option>
                                <option value="Artículos">Artículos Científicos</option>
                                <option value="Formularios">Formularios y Plantillas</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap">
                        <button id="addResourceBtn" class="btn primary">
                            <i class="fas fa-plus"></i> Agregar Nuevo Recurso
                        </button>
                        <button id="exportResourcesBtn" class="btn secondary">
                            <i class="fas fa-file-export"></i> Exportar Recursos
                            </button>
                    </div>
                    <div id="resources-container"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para crear/editar pacientes -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <button class="close-modal" id="closePatientModal">&times;</button>
            <h2><i class="fas fa-user-plus"></i> <span id="patientModalTitle">Agregar Nuevo Paciente</span></h2>
            
            <div class="patient-form-container">
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-patient-name"><i class="fas fa-user"></i> Nombre del Paciente</label>
                        <input type="text" id="modal-patient-name" class="form-control" placeholder="Nombre completo del paciente">
                    </div>
                    <div class="form-group">
                        <label for="modal-patient-age"><i class="fas fa-birthday-cake"></i> Edad</label>
                        <input type="number" id="modal-patient-age" class="form-control" placeholder="Edad en años">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-patient-diagnosis"><i class="fas fa-diagnoses"></i> Diagnóstico Principal</label>
                        <input type="text" id="modal-patient-diagnosis" class="form-control" placeholder="Diagnóstico médico principal">
                    </div>
                    <div class="form-group">
                        <label for="modal-patient-specialty"><i class="fas fa-stethoscope"></i> Especialidad</label>
                        <select id="modal-patient-specialty" class="form-control">
                            <option value="">Seleccionar especialidad...</option>
                            <option value="Cardiología">Cardiología</option>
                            <option value="Neumología">Neumología</option>
                            <option value="Endocrinología">Endocrinología</option>
                            <option value="Neurología">Neurología</option>
                            <option value="Oncología">Oncología</option>
                            <option value="Nefrología">Nefrología</option>
                            <option value="Gastroenterología">Gastroenterología</option>
                            <option value="Reumatología">Reumatología</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="modal-patient-allergies"><i class="fas fa-allergies"></i> Alergias</label>
                    <input type="text" id="modal-patient-allergies" class="form-control" placeholder="Lista de alergias separadas por coma">
                </div>
                
                <div class="form-group">
                    <label for="modal-patient-history"><i class="fas fa-notes-medical"></i> Resumen de Historia Clínica</label>
                    <textarea id="modal-patient-history" class="form-control" placeholder="Resumen de la historia clínica del paciente..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn ghost" id="cancelPatientBtn">Cancelar</button>
                    <button type="button" class="btn primary" id="savePatientBtn">Guardar Paciente</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to get element by ID
        function $(id) {
            return document.getElementById(id);
        }
        
        // Theme toggle functionality
        const themeToggle = $('themeToggle');
        const html = document.documentElement;
        const themeIcon = themeToggle.querySelector('i');
        
        // Check for saved theme preference or use preferred color scheme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            html.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            html.setAttribute('data-theme', 'dark');
            updateThemeIcon('dark');
        } else {
            updateThemeIcon('light');
        }
        
        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                themeIcon.className = 'fas fa-sun';
            } else {
                themeIcon.className = 'fas fa-moon';
            }
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });
        
        // Mobile menu toggle
        const mobileMenuBtn = $('mobileMenuBtn');
        const sidebar = $('sidebar');
        
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hidden-mobile');
        });
        
        // Procedimientos de enfermería
        const PROCEDURES = {
            higiene: [
                {
                    id: 'lavado_mano',
                    title: 'Lavado de manos',
                    summary: 'Técnica esencial para prevenir infecciones según protocolos de la OMS.',
                    materials: ['Jabón', 'Agua', 'Toalla desechable', 'Gel alcohólico 70%'],
                    steps: [
                        'Retirar joyas y reloj',
                        'Mojar manos con agua',
                        'Aplicar jabón suficiente',
                        'Frotar palmas, dorsos, entre dedos y pulgares ≥20s',
                        'Enjuagar abundantemente',
                        'Secar con toalla desechable',
                        'Cerrar grifo con toalla'
                    ],
                    notes: 'Crucial antes y después del contacto con paciente. Realice el lavado de manos siguiendo los 7 pasos recomendados por la OMS.'
                },
                {
                    id: 'baño_cama',
                    title: 'Baño en cama',
                    summary: 'Higiene integral del paciente encamado con prevención de lesiones.',
                    materials: ['Toallas', 'Agua tibia', 'Jabón suave', 'Guantes', 'Sábana impermeable', 'Báscula'],
                    steps: [
                        'Preparar equipo y ambiente',
                        'Explicar procedimiento al paciente',
                        'Proteger intimidad con cortinas',
                        'Colocar sábana impermeable',
                        'Limpiar de proximal a distal',
                        'Secar y vestir',
                        'Cambiar sábana si está húmeda',
                        'Documentar procedimiento'
                    ],
                    notes: 'Evite fricciones excesivas. Revise áreas de riesgo para escaras. Mantenga al paciente abrigado durante el procedimiento.'
                }
                // ... otros procedimientos (se mantienen igual)
            ],
            // ... otras categorías (se mantienen igual)
        };
        
        // Enfermedades comunes
        const DISEASES = [
            {
                name: 'Neumonía',
                summary: 'Infección inflamatoria aguda del parénquima pulmonar, generalmente bacteriana o viral. Presenta fiebre, tos productiva, disnea y crepitaciones. Cuidados: oxigenoterapia, movilización, antibióticos según guía.',
                detailed: {
                    etiologia: 'Bacteriana (Streptococcus pneumoniae), viral (influenza), atípica (Mycoplasma). Factores de riesgo: edad, tabaquismo, enfermedad pulmonar crónica.',
                    sintomas: 'Fiebre, tos productiva, disnea, dolor torácico pleurítico, escalofríos, sudoración nocturna.',
                    diagnostico: 'Radiografía de tórax, análisis de sangre, cultivo de esputo, gasometría arterial en casos graves.',
                    tratamiento: 'Antibióticos empíricos según gravedad, oxigenoterapia, hidratación, fisioterapia respiratoria.',
                    prevencion: 'Vacunación antineumocócica e influenza, abandono del tabaquismo, higiene de manos.'
                }
            }
            // ... otras enfermedades (se mantienen igual)
        ];
        
        // Medicamentos y combinaciones peligrosas
        const NEVER_COMBINE = [
            { a: 'warfarina', b: 'ibuprofeno', reason: 'Aumento del riesgo de hemorragia gastrointestinal y sistémica', ref: 'https://www.ncbi.nlm.nih.gov/books/NBK545235/' }
            // ... otras combinaciones (se mantienen igual)
        ];
        
        const MEDS = [
            'Warfarina', 'Ibuprofeno', 'Paracetamol', 'Ciprofloxacina', 'Metformina',
            'Sertralina', 'Omeprazol', 'Sildenafil', 'Nitroglicerina', 'Clopidogrel'
            // ... otros medicamentos (se mantienen igual)
        ];
        
        // Pacientes
        const PATIENTS_KEY = 'enfermeria_david_pacientes';
        const PAE_KEY = 'enfermeria_david_pae';
        const RECURSOS_KEY = 'enfermeria_david_recursos';
        
        // Funciones de almacenamiento persistente
        function getStoredData(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error('Error reading from localStorage:', e);
                return defaultValue;
            }
        }
        
        function setStoredData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error writing to localStorage:', e);
                return false;
            }
        }
        
        // Obtener datos almacenados o usar datos iniciales
        let PACIENTES = getStoredData(PATIENTS_KEY, [
            {
                id: 1,
                nombre: 'María González',
                edad: 65,
                diagnosticoPrincipal: 'Diabetes mellitus tipo 2',
                especialidad: 'Endocrinología',
                riesgoCardiovascular: 'moderado',
                alergias: ['Penicilina'],
                historiaClinica: {
                    resumen: 'Paciente femenina de 65 años con diabetes tipo 2 diagnosticada hace 10 años. Buen control glucémico actual con metformina y estilo de vida.'
                    // ... resto de datos (se mantienen igual)
                }
            }
            // ... otros pacientes (se mantienen igual)
        ]);
        
        let RECURSOS = getStoredData(RECURSOS_KEY, [
            {
                id: 1,
                titulo: 'Guía de Práctica Clínica: Manejo de la Diabetes Tipo 2',
                categoria: 'Protocolos',
                tipo: 'documento',
                url: 'https://example.com/diabetes2.pdf',
                etiquetas: ['diabetes', 'endocrinología', 'protocolo', 'tratamiento'],
                descripcion: 'Guía actualizada basada en evidencia para el manejo integral de la diabetes mellitus tipo 2, incluyendo objetivos terapéuticos, algoritmos de tratamiento y prevención de complicaciones.'
            }
            // ... otros recursos (se mantienen igual)
        ]);
        
        // Variables globales
        let currentEditingPatientId = null;
        
        // Content area and functions
        const contentArea = $('contentArea');
        const diseasePanel = $('diseasePanel');
        const diseaseResults = $('diseaseResults');
        const medCombo = $('medCombo');
        const paeForm = $('paeForm');
        const rcpGuide = $('rcpGuide');
        const calculadoras = $('calculadoras');
        const pacientes = $('pacientes');
        const recursos = $('recursos');
        
        // Modal elements
        const patientModal = $('patientModal');
        const patientModalTitle = $('patientModalTitle');
        const closePatientModal = $('closePatientModal');
        const cancelPatientBtn = $('cancelPatientBtn');
        const savePatientBtn = $('savePatientBtn');
        
        function clearContent() {
            contentArea.innerHTML = '';
            diseasePanel.style.display = 'none';
            medCombo.style.display = 'none';
            paeForm.style.display = 'none';
            rcpGuide.style.display = 'none';
            calculadoras.style.display = 'none';
            pacientes.style.display = 'none';
            recursos.style.display = 'none';
            
            // Remove active state from all buttons
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        function renderCategory(cat) {
            clearContent();
            
            // Add active state to the selected button
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if (btn.getAttribute('data-cat') === cat) {
                    btn.classList.add('active');
                }
            });
            
            if (PROCEDURES[cat]) {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                
                const h2 = document.createElement('h2');
                h2.innerHTML = `<i class="fas fa-folder-open"></i> ${getCatTitle(cat)}`;
                categoryCard.appendChild(h2);
                
                PROCEDURES[cat].forEach(proc => {
                    const procedure = document.createElement('div');
                    procedure.className = 'procedure';
                    
                    const h3 = document.createElement('h3');
                    h3.innerHTML = `<i class="fas fa-file-medical"></i> ${proc.title}`;
                    procedure.appendChild(h3);
                    
                    if (proc.summary) {
                        const summary = document.createElement('p');
                        summary.className = 'summary';
                        summary.innerHTML = `<i class="fas fa-info-circle"></i> ${proc.summary}`;
                        procedure.appendChild(summary);
                    }
                    
                    if (proc.materials && proc.materials.length > 0) {
                        const materials = document.createElement('div');
                        materials.className = 'materials';
                        
                        const materialsLabel = document.createElement('h4');
                        materialsLabel.innerHTML = `<i class="fas fa-box-open"></i> Materiales y Equipos Necesarios:`;
                        materials.appendChild(materialsLabel);
                        
                        const ul = document.createElement('ul');
                        proc.materials.forEach(mat => {
                            const li = document.createElement('li');
                            li.textContent = mat;
                            ul.appendChild(li);
                        });
                        materials.appendChild(ul);
                        procedure.appendChild(materials);
                    }
                    
                    if (proc.steps && proc.steps.length > 0) {
                        const steps = document.createElement('div');
                        steps.className = 'steps';
                        
                        const stepsLabel = document.createElement('h4');
                        stepsLabel.innerHTML = `<i class="fas fa-list-ol"></i> Procedimiento Paso a Paso:`;
                        steps.appendChild(stepsLabel);
                        
                        const ol = document.createElement('ol');
                        ol.style.counterReset = 'step';
                        proc.steps.forEach(step => {
                            const li = document.createElement('li');
                            li.textContent = step;
                            ol.appendChild(li);
                        });
                        steps.appendChild(ol);
                        procedure.appendChild(steps);
                    }
                    
                    if (proc.notes) {
                        const notes = document.createElement('div');
                        notes.className = 'notes';
                        notes.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${proc.notes}`;
                        procedure.appendChild(notes);
                    }
                    
                    categoryCard.appendChild(procedure);
                });
                
                contentArea.appendChild(categoryCard);
            }
        }
        
        function getCatTitle(cat) {
            const titles = {
                'higiene': 'Procedimientos de Higiene Clínica',
                'curaciones': 'Técnicas Avanzadas de Curación',
                'farmaco': 'Farmacología y Administración de Medicamentos',
                'emergencias': 'Manejo de Emergencias Médicas',
                'movilizacion': 'Técnicas de Movilización',
                'nutricion': 'Cuidados Nutricionales',
                'infeccion': 'Control de Infecciones',
                'medicamentos': 'Gestión de Medicamentos',
                'enfermedades': 'Enfermedades y Condiciones',
                'pae': 'Plan de Atención de Enfermería',
                'rcp': 'Reanimación Cardiovascular',
                'calculadoras': 'Calculadoras Clínicas',
                'recursos': 'Recursos Educativos',
                'pacientes': 'Gestión de Pacientes'
            };
            return titles[cat] || cat;
        }
        
        // Event listeners for category buttons
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cat = btn.getAttribute('data-cat');
                
                if (cat === 'medicamentos') {
                    showMedCombo();
                } else if (cat === 'enfermedades') {
                    showDiseases();
                } else if (cat === 'pae') {
                    showPaeForm();
                } else if (cat === 'rcp') {
                    showRcpGuide();
                } else if (cat === 'calculadoras') {
                    showCalculadoras();
                } else if (cat === 'pacientes') {
                    showPacientes();
                } else if (cat === 'recursos') {
                    showRecursos();
                } else {
                    renderCategory(cat);
                }
                
                // En móviles, ocultar el menú después de seleccionar una opción
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('hidden-mobile');
                }
            });
        });
        
        // Open all procedures
        $('openAllBtn').addEventListener('click', () => {
            clearContent();
            Object.keys(PROCEDURES).forEach(k => renderCategory(k));
        });
        
        // Global search
        $('searchBtn').addEventListener('click', () => {
            const q = $('globalSearch').value.trim().toLowerCase();
            if (!q) { 
                alert('Ingrese término de búsqueda'); 
                return; 
            }
            clearContent();
            
            const results = [];
            
            // Search procedures
            Object.keys(PROCEDURES).forEach(cat => {
                PROCEDURES[cat].forEach(proc => {
                    const hay = (proc.title + ' ' + proc.summary + ' ' + (proc.steps||[]).join(' ')).toLowerCase();
                    if (hay.includes(q)) {
                        results.push({cat, p: proc});
                    }
                });
            });
            
            // Search diseases
            const dHits = DISEASES.filter(d => (d.name + ' ' + d.summary).toLowerCase().includes(q));
            if (dHits.length) {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<h2><i class="fas fa-notes-medical"></i> Enfermedades encontradas</h2>`;
                
                dHits.forEach(d => {
                    const diseaseItem = document.createElement('div');
                    diseaseItem.className = 'disease-item';
                    diseaseItem.innerHTML = `<strong>${d.name}</strong><div class="small"><i class="fas fa-info-circle"></i> ${d.summary}</div>`;
                    card.appendChild(diseaseItem);
                });
                
                contentArea.appendChild(card);
            }
            
            // Search medications
            const mHits = MEDS.filter(m => m.toLowerCase().includes(q));
            if (mHits.length) {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<h2><i class="fas fa-pills"></i> Medicamentos encontrados</h2><div class="small">${mHits.join(', ')}</div>`;
                contentArea.appendChild(card);
            }
            
            // Search patients
            const pHits = PACIENTES.filter(p => p.nombre.toLowerCase().includes(q) || 
                p.diagnosticoPrincipal.toLowerCase().includes(q) || 
                p.especialidad.toLowerCase().includes(q));
            if (pHits.length) {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<h2><i class="fas fa-users"></i> Pacientes encontrados</h2>`;
                
                pHits.forEach(p => {
                    const patientItem = document.createElement('div');
                    patientItem.className = 'disease-item';
                    patientItem.innerHTML = `<strong>${p.nombre}</strong><div class="small"><i class="fas fa-user-md"></i> Edad: ${p.edad}, <i class="fas fa-diagnoses"></i> Diagnóstico: ${p.diagnosticoPrincipal}, <i class="fas fa-stethoscope"></i> Especialidad: ${p.especialidad}</div>`;
                    card.appendChild(patientItem);
                });
                
                contentArea.appendChild(card);
            }
            
            // Show procedure results
            if (results.length > 0) {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<h2><i class="fas fa-search"></i> Resultados de búsqueda</h2>`;
                
                results.forEach(r => {
                    const proc = r.p;
                    const procedure = document.createElement('div');
                    procedure.className = 'procedure';
                    
                    const h3 = document.createElement('h3');
                    h3.innerHTML = `<i class="fas fa-file-medical"></i> ${proc.title}`;
                    procedure.appendChild(h3);
                    
                    if (proc.summary) {
                        const summary = document.createElement('p');
                        summary.className = 'summary';
                        summary.innerHTML = `<i class="fas fa-info-circle"></i> ${proc.summary}`;
                        procedure.appendChild(summary);
                    }
                    
                    card.appendChild(procedure);
                });
                
                contentArea.appendChild(card);
            }
            
            if (results.length === 0 && dHits.length === 0 && mHits.length === 0 && pHits.length === 0) {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `<h2><i class="fas fa-exclamation-triangle"></i> No se encontraron resultados</h2><p>No se encontró información relacionada con "${q}". Intente con otro término de búsqueda.</p>`;
                contentArea.appendChild(card);
            }
        });
        
        // Show diseases
        function showDiseases() {
            clearContent();
            diseasePanel.style.display = 'block';
            diseaseResults.innerHTML = DISEASES.map(d => 
                `<div class="disease-item">
                    <strong>${d.name}</strong>
                    <div class="small"><i class="fas fa-info-circle"></i> ${d.summary}</div>
                    <div class="detailed-info" style="margin-top:12px;">
                        <h4><i class="fas fa-book-medical"></i> Información Detallada</h4>
                        <p><strong>Etiología:</strong> ${d.detailed.etiologia}</p>
                        <p><strong>Síntomas:</strong> ${d.detailed.sintomas}</p>
                        <p><strong>Diagnóstico:</strong> ${d.detailed.diagnostico}</p>
                        <p><strong>Tratamiento:</strong> ${d.detailed.tratamiento}</p>
                        <p><strong>Prevención:</strong> ${d.detailed.prevencion</p>
                    </div>
                </div>`
            ).join('');
        }
        
        // Show medication combinator
        function showMedCombo() {
            clearContent();
            medCombo.style.display = 'block';
            
            // Populate medication selects
            const medSelectA = $('medSelectA');
            const medSelectB = $('medSelectB');
            
            medSelectA.innerHTML = '<option value="">Seleccionar medicamento...</option>';
            medSelectB.innerHTML = '<option value="">Seleccionar medicamento...</option>';
            
            MEDS.forEach(med => {
                const optionA = document.createElement('option');
                optionA.value = med.toLowerCase();
                optionA.textContent = med;
                medSelectA.appendChild(optionA);
                
                const optionB = document.createElement('option');
                optionB.value = med.toLowerCase();
                optionB.textContent = med;
                medSelectB.appendChild(optionB);
            });
            
            // Populate never list
            $('neverList').innerHTML = NEVER_COMBINE.map(n => 
                `<div style="margin-bottom:12px;padding:10px;background:rgba(217, 4, 41, 0.1);border-radius:10px;border:1px solid rgba(217, 4, 41, 0.3);">
                    <strong style="color:#dc2626">${n.a} + ${n.b}</strong>
                    <div class="small" style="margin-top:6px;"><i class="fas fa-exclamation-triangle"></i> ${n.reason} <a href="${n.ref}" target="_blank" rel="noopener" style="color:#0077b6"><i class="fas fa-external-link-alt"></i> Referencia científica</a></div>
                </div>`
            ).join('');
            
            // Med search quick fill
            $('medSearchBox').addEventListener('input', (e) => {
                const q = e.target.value.trim().toLowerCase();
                if (!q) return;
                const matches = MEDS.filter(m => m.toLowerCase().includes(q));
                if (matches.length) {
                    $('medSelectA').value = matches[0].toLowerCase();
                    $('medSelectB').value = matches[1]?.toLowerCase() || matches[0].toLowerCase();
                }
            });
        }
        
        // Check medication interactions
        $('checkInteractionsBtn').addEventListener('click', () => {
            const a = $('medSelectA').value.toLowerCase();
            const b = $('medSelectB').value.toLowerCase();
            const out = $('medAlert');
            
            if (!a || !b) {
                out.innerHTML = '<div class="interactions-warning danger"><i class="fas fa-exclamation-triangle"></i> <span>Seleccione dos fármacos para verificar interacciones</span></div>';
                return;
            }
            
            if (a === b) {
                out.innerHTML = '<div class="interactions-warning success"><i class="fas fa-check-circle"></i> <span>Mismo medicamento seleccionado — cuidado con duplicidad terapéutica. Verifique dosis total diaria.</span></div>';
                return;
            }
            
            const hits = NEVER_COMBINE.filter(n => 
                (a.includes(n.a) && b.includes(n.b)) || 
                (a.includes(n.b) && b.includes(n.a))
            );
            
            if (hits.length) {
                out.innerHTML = `
                    <div class="interactions-warning danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Interacciones Peligrosas Detectadas:</strong>
                            <ul class="interactions-list">
                                ${hits.map(h => `<li><strong>${h.reason}</strong> (${h.a.toUpperCase()} + ${h.b.toUpperCase()}) <a href="${h.ref}" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Ver evidencia científica</a></li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                out.innerHTML = '<div class="interactions-warning success"><i class="fas fa-check-circle"></i> <span>No se detectaron interacciones peligrosas conocidas entre estos medicamentos en nuestra base. Recomendamos verificar en bases especializadas para un análisis completo.</span></div>';
            }
        });
        
        // Show PAE form
        function showPaeForm() {
            clearContent();
            paeForm.style.display = 'block';
        }
        
        // Generate PAE
        $('generatePaeBtn').addEventListener('click', () => {
            const patientName = $('patientName').value;
            const patientAge = $('patientAge').value;
            const diagnosis = $('diagnosis').value;
            const nursingDiagnosis = $('nursingDiagnosis').value;
            const goals = $('goals').value;
            const interventions = $('interventions').value;
            
            if (!patientName || !patientAge || !diagnosis || !nursingDiagnosis || !goals || !interventions) {
                alert('Por favor, complete todos los campos del PAE.');
                return;
            }
            
            clearContent();
            
            const paeCard = document.createElement('div');
            paeCard.className = 'category-card';
            paeCard.innerHTML = `
                <h2><i class="fas fa-clipboard-list"></i> Plan de Atención de Enfermería (PAE)</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Paciente:</label>
                        <p>${patientName}, ${patientAge} años</p>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-diagnoses"></i> Diagnóstico Médico:</label>
                        <p>${diagnosis}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-stethoscope"></i> Diagnóstico de Enfermería:</label>
                    <p>${$('nursingDiagnosis').options[$('nursingDiagnosis').selectedIndex].text}</p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-bullseye"></i> Objetivos SMART:</label>
                        <p>${goals}</p>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-hand-holding-medical"></i> Intervenciones Basadas en Evidencia:</label>
                        <p>${interventions}</p>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="far fa-calendar-alt"></i> Fecha de Elaboración:</label>
                    <p>${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user-nurse"></i> Elaborado por:</label>
                    <p>Enfermero/a de Atención Directa</p>
                </div>
                <div style="margin-top:24px;text-align:center;">
                    <button id="printPaeBtn" class="btn primary">
                        <i class="fas fa-print"></i> Imprimir PAE
                    </button>
                    <button id="savePaeBtn" class="btn secondary" style="margin-left:12px;">
                        <i class="fas fa-save"></i> Guardar PAE
                    </button>
                </div>
            `;
            
            contentArea.appendChild(paeCard);
            
            // Print functionality
            $('printPaeBtn').addEventListener('click', () => {
                window.print();
            });
            
            // Save functionality
            $('savePaeBtn').addEventListener('click', () => {
                const arr = getStoredData(PAE_KEY, []);
                arr.push({
                    patient: patientName,
                    age: patientAge,
                    diagnosis: diagnosis,
                    nursingDiagnosis: $('nursingDiagnosis').options[$('nursingDiagnosis').selectedIndex].text,
                    goals: goals,
                    interventions: interventions,
                    date: new Date().toISOString()
                });
                setStoredData(PAE_KEY, arr);
                showNotification('PAE guardado con éxito', 'success');
            });
        });
        
        // Save PAE
        $('savePaeBtn').addEventListener('click', () => {
            const name = $('pae_name').value.trim();
            const diag = $('pae_diag').value.trim();
            const plan = $('pae_plan').value.trim();
            
            if (!name || !diag) {
                showNotification('Nombre y diagnóstico requeridos', 'error');
                return;
            }
            
            const arr = getStoredData(PAE_KEY, []);
            arr.push({name, diag, plan, ts: Date.now()});
            setStoredData(PAE_KEY, arr);
            showNotification('PAE guardado localmente', 'success');
        });
        
        // Export PAE
        $('exportPaeBtn').addEventListener('click', () => {
            const arr = getStoredData(PAE_KEY, []);
            if (arr.length === 0) {
                showNotification('No hay PAEs guardados para exportar', 'error');
                return;
            }
            
            const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(arr, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "pae_records.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification('PAEs exportados', 'success');
        });
        
        // Show RCP guide
        function showRcpGuide() {
            clearContent();
            rcpGuide.style.display = 'block';
        }
        
        // RCP timer
        let rcpInterval = null;
        let rcpSeconds = 0;
        
        function startRCP() {
            if (rcpInterval) return;
            rcpSeconds = 0;
            rcpInterval = setInterval(() => {
                rcpSeconds++;
                const mm = String(Math.floor(rcpSeconds/60)).padStart(2,'0');
                const ss = String(rcpSeconds%60).padStart(2,'0');
                $('rcpTimer').textContent = `${mm}:${ss}`;
                if(rcpSeconds % 120 === 0) {
                    if(navigator.vibrate) navigator.vibrate([200,100,200]);
                    showNotification('¡Cambio de reanimador recomendado! (cada 2 minutos para mantener calidad de compresiones)', 'info');
                }
            }, 1000);
            $('rcpState').textContent='Estado: RCP en progreso';
        }
        
        function stopRCP() {
            if(rcpInterval) clearInterval(rcpInterval);
            rcpInterval = null;
            $('rcpState').textContent='Estado: detenido';
            $('rcpTimer').textContent='00:00';
        }
        
        $('rcpStart').addEventListener('click', startRCP);
        $('rcpStop').addEventListener('click', stopRCP);
        
        // Show calculadoras
        function showCalculadoras() {
            clearContent();
            calculadoras.style.display = 'grid';
        }
        
        // Calculate IMC
        $('calculateImc').addEventListener('click', () => {
            const weight = parseFloat($('imc_weight').value);
            const height = parseFloat($('imc_height').value) / 100;
            
            if (!weight || !height) {
                $('imc-result').style.display = 'none';
                return;
            }
            
            const imc = weight / (height * height);
            let category = '';
            
            if (imc < 18.5) category = 'Bajo peso';
            else if (imc < 25) category = 'Peso normal';
            else if (imc < 30) category = 'Sobrepeso';
            else if (imc < 35) category = 'Obesidad grado I';
            else if (imc < 40) category = 'Obesidad grado II';
            else category = 'Obesidad grado III';
            
            $('imc-value').textContent = imc.toFixed(2);
            $('imc-category').textContent = category;
            $('imc-result').style.display = 'block';
        });
        
        // Calculate Filtration
        $('calculateFiltration').addEventListener('click', () => {
            const creatinine = parseFloat($('creatinine').value);
            const age = parseInt($('age').value);
            const sex = document.querySelector('input[name="sex"]:checked')?.value;
            
            if (!creatinine || !age || !sex) {
                $('filtration-result').style.display = 'none';
                return;
            }
            
            // Fórmula CKD-EPI
            let k, a, sexFactor;
            if (sex === 'female') {
                k = 0.7;
                a = creatinine <= 0.7 ? -0.241 : -1.2;
                sexFactor = 1.018;
            } else {
                k = 0.9;
                a = creatinine <= 0.9 ? -0.302 : -1.2;
                sexFactor = 1;
            }
            
            const eGFR = 141 * Math.pow(Math.min(creatinine/k, 1), a) * 
                        Math.pow(Math.max(creatinine/k, 1), -1.209) * 
                        Math.pow(0.993, age) * sexFactor;
            
            let category = '';
            if (eGFR >= 90) category = 'Normal o aumentado';
            else if (eGFR >= 60) category = 'Levemente disminuido';
            else if (eGFR >= 30) category = 'Moderadamente disminuido';
            else if (eGFR >= 15) category = 'Severamente disminuido';
            else category = 'Insuficiencia renal';
            
            $('filtration-value').textContent = Math.round(eGFR) + ' ml/min/1.73m²';
            $('filtration-category').textContent = category;
            $('filtration-result').style.display = 'block';
        });
        
        // Calculate SCORE
        $('calculateScore').addEventListener('click', () => {
            const age = parseInt($('score_age').value);
            const totalCholesterol = parseFloat($('total-cholesterol').value);
            const hdlCholesterol = parseFloat($('hdl-cholesterol').value);
            const systolicPressure = parseInt($('systolic-pressure').value);
            const smoker = $('smoker').checked;
            const diabetes = $('diabetes').checked;
            
            if (!age || !totalCholesterol || !hdlCholesterol || !systolicPressure) {
                $('score-result').style.display = 'none';
                return;
            }
            
            // Fórmula SCORE simplificada (aproximación)
            let score = 0;
            
            // Factores de riesgo
            if (age >= 70) score += 3;
            else if (age >= 60) score += 2;
            else if (age >= 50) score += 1;
            
            if (totalCholesterol >= 280) score += 3;
            else if (totalCholesterol >= 240) score += 2;
            else if (totalCholesterol >= 200) score += 1;
            
            if (hdlCholesterol < 35) score += 2;
            else if (hdlCholesterol < 40) score += 1;
            
            if (systolicPressure >= 180) score += 3;
            else if (systolicPressure >= 160) score += 2;
            else if (systolicPressure >= 140) score += 1;
            
            if (smoker) score += 2;
            if (diabetes) score += 2;
            
            let category = '';
            if (score < 5) category = 'Bajo riesgo (<1%)';
            else if (score < 10) category = 'Riesgo bajo (1-2%)';
            else if (score < 15) category = 'Riesgo moderado (3-5%)';
            else if (score < 20) category = 'Riesgo alto (6-10%)';
            else category = 'Riesgo muy alto (>10%)';
            
            $('score-value').textContent = score + ' puntos';
            $('score-category').textContent = category;
            $('score-result').style.display = 'block';
        });
        
        // Show pacientes
        function showPacientes() {
            clearContent();
            pacientes.style.display = 'block';
            updatePatientGrid();
        }
        
        // Update patient grid
        function updatePatientGrid() {
            const container = $('patients-container');
            const search = $('patient-search').value.toLowerCase();
            const specialty = $('patient-specialty').value;
            
            const filteredPatients = PACIENTES.filter(p => {
                const matchesSearch = !search || p.nombre.toLowerCase().includes(search) || 
                                    p.diagnosticoPrincipal.toLowerCase().includes(search);
                const matchesSpecialty = !specialty || p.especialidad === specialty;
                return matchesSearch && matchesSpecialty;
            });
            
            if (filteredPatients.length === 0) {
                container.innerHTML = '<p class="small">No se encontraron pacientes que coincidan con los criterios de búsqueda.</p>';
                return;
            }
            
            container.innerHTML = filteredPatients.map(p => 
                `<div class="patient-card" data-id="${p.id}">
                    <h3><i class="fas fa-user"></i> ${p.nombre}</h3>
                    <p><i class="fas fa-birthday-cake"></i> Edad: ${p.edad} años</p>
                    <p><i class="fas fa-diagnoses"></i> Diagnóstico: ${p.diagnosticoPrincipal}</p>
                    <p><i class="fas fa-stethoscope"></i> Especialidad: ${p.especialidad}</p>
                    <p><i class="fas fa-heartbeat"></i> Riesgo cardiovascular: ${p.riesgoCardiovascular}</p>
                    <p><i class="fas fa-allergies"></i> Alergias: ${p.alergias.length > 0 ? p.alergias.join(', ') : 'Ninguna registrada'}</p>
                    <div class="detailed-info" style="margin-top:12px;">
                        <h4><i class="fas fa-notes-medical"></i> Información Clínica</h4>
                        <p><strong>Resumen:</strong> ${p.historiaClinica.resumen}</p>
                        <p><strong>Diagnosticos:</strong> ${p.historiaClinica.diagnosticos.map(d => d.descripcion).join(', ')}</p>
                        <p><strong>Tratamientos:</strong> ${p.historiaClinica.tratamientos.map(t => t.medicamento).join(', ')}</p>
                        <p><strong>Próximos controles:</strong> ${p.historiaClinica.controles.map(c => c.tipo + ' (' + c.proximo + ')').join(', ')}</p>
                    </div>
                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button class="btn small edit-patient" data-id="${p.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn small ghost delete-patient" data-id="${p.id}">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>`
            ).join('');
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-patient').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const patientId = parseInt(btn.getAttribute('data-id'));
                    openPatientModal(patientId);
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-patient').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const patientId = parseInt(btn.getAttribute('data-id'));
                    deletePatient(patientId);
                });
            });
            
            // Add event listeners to patient cards for viewing details
            document.querySelectorAll('.patient-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('btn')) {
                        const patientId = parseInt(card.getAttribute('data-id'));
                        viewPatientDetails(patientId);
                    }
                });
            });
        }
        
        // Patient search
        $('patient-search').addEventListener('input', updatePatientGrid);
        $('patient-specialty').addEventListener('change', updatePatientGrid);
        
        // Add patient button
        $('addPatientBtn').addEventListener('click', () => {
            openPatientModal();
        });
        
        // Export patients
        $('exportPatientsBtn').addEventListener('click', () => {
            if (PACIENTES.length === 0) {
                showNotification('No hay pacientes para exportar', 'error');
                return;
            }
            
            const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(PACIENTES, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "pacientes_enfermeria_david.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification('Pacientes exportados', 'success');
        });
        
        // Modal functions
        function openPatientModal(patientId = null) {
            currentEditingPatientId = patientId;
            
            if (patientId) {
                // Editing existing patient
                const patient = PACIENTES.find(p => p.id === patientId);
                if (patient) {
                    patientModalTitle.textContent = 'Editar Paciente';
                    $('modal-patient-name').value = patient.nombre;
                    $('modal-patient-age').value = patient.edad;
                    $('modal-patient-diagnosis').value = patient.diagnosticoPrincipal;
                    $('modal-patient-specialty').value = patient.especialidad;
                    $('modal-patient-allergies').value = patient.alergias.join(', ');
                    $('modal-patient-history').value = patient.historiaClinica.resumen;
                }
            } else {
                // Adding new patient
                patientModalTitle.textContent = 'Agregar Nuevo Paciente';
                $('modal-patient-name').value = '';
                $('modal-patient-age').value = '';
                $('modal-patient-diagnosis').value = '';
                $('modal-patient-specialty').value = '';
                $('modal-patient-allergies').value = '';
                $('modal-patient-history').value = '';
            }
            
            patientModal.style.display = 'block';
        }
        
        function closePatientModal() {
            patientModal.style.display = 'none';
            currentEditingPatientId = null;
        }
        
        function savePatient() {
            const name = $('modal-patient-name').value.trim();
            const age = parseInt($('modal-patient-age').value);
            const diagnosis = $('modal-patient-diagnosis').value.trim();
            const specialty = $('modal-patient-specialty').value;
            const allergies = $('modal-patient-allergies').value.split(',').map(a => a.trim()).filter(a => a);
            const history = $('modal-patient-history').value.trim();
            
            if (!name || !age || !diagnosis || !specialty) {
                showNotification('Por favor, complete todos los campos obligatorios', 'error');
                return;
            }
            
            if (currentEditingPatientId) {
                // Update existing patient
                const patientIndex = PACIENTES.findIndex(p => p.id === currentEditingPatientId);
                if (patientIndex !== -1) {
                    PACIENTES[patientIndex] = {
                        ...PACIENTES[patientIndex],
                        nombre: name,
                        edad: age,
                        diagnosticoPrincipal: diagnosis,
                        especialidad: specialty,
                        alergias: allergies,
                        historiaClinica: {
                            ...PACIENTES[patientIndex].historiaClinica,
                            resumen: history
                        }
                    };
                    
                    setStoredData(PATIENTS_KEY, PACIENTES);
                    showNotification('Paciente actualizado con éxito', 'success');
                }
            } else {
                // Add new patient
                const newPatient = {
                    id: PACIENTES.length > 0 ? Math.max(...PACIENTES.map(p => p.id)) + 1 : 1,
                    nombre: name,
                    edad: age,
                    diagnosticoPrincipal: diagnosis,
                    especialidad: specialty,
                    riesgoCardiovascular: 'moderado',
                    alergias: allergies,
                    historiaClinica: {
                        resumen: history,
                        diagnosticos: [
                            { fecha: new Date().toISOString().split('T')[0], cie10: 'XX.X', descripcion: diagnosis, estado: 'Activo' }
                        ],
                        tratamientos: [],
                        evolucion: [
                            { fecha: new Date().toISOString().split('T')[0], nota: 'Paciente agregado al sistema.' }
                        ],
                        signosVitales: [],
                        controles: []
                    }
                };
                
                PACIENTES.push(newPatient);
                setStoredData(PATIENTS_KEY, PACIENTES);
                showNotification('Paciente agregado con éxito', 'success');
            }
            
            updatePatientGrid();
            closePatientModal();
        }
        
        function deletePatient(patientId) {
            if (confirm('¿Está seguro de que desea eliminar este paciente? Esta acción no se puede deshacer.')) {
                PACIENTES = PACIENTES.filter(p => p.id !== patientId);
                setStoredData(PATIENTS_KEY, PACIENTES);
                updatePatientGrid();
                showNotification('Paciente eliminado', 'success');
            }
        }
        
        function viewPatientDetails(patientId) {
            const patient = PACIENTES.find(p => p.id === patientId);
            if (!patient) return;
            
            // Here you could implement a detailed view or modal for patient details
            alert(`Detalles del paciente: ${patient.nombre}\nEdad: ${patient.edad}\nDiagnóstico: ${patient.diagnosticoPrincipal}`);
        }
        
        // Modal event listeners
        closePatientModal.addEventListener('click', closePatientModal);
        cancelPatientBtn.addEventListener('click', closePatientModal);
        savePatientBtn.addEventListener('click', savePatient);
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                closePatientModal();
            }
        });
        
        // Show recursos
        function showRecursos() {
            clearContent();
            recursos.style.display = 'block';
            updateResourceCards();
        }
        
        // Update resource cards
        function updateResourceCards() {
            const container = $('resources-container');
            const search = $('resource-search').value.toLowerCase();
            const category = $('resource-category').value;
            
            const filteredResources = RECURSOS.filter(r => {
                const matchesSearch = !search || r.titulo.toLowerCase().includes(search) || 
                                    r.etiquetas.some(tag => tag.toLowerCase().includes(search)) ||
                                    r.descripcion.toLowerCase().includes(search);
                const matchesCategory = !category || r.categoria === category;
                return matchesSearch && matchesCategory;
            });
            
            if (filteredResources.length === 0) {
                container.innerHTML = '<p class="small">No se encontraron recursos que coincidan con los criterios de búsqueda.</p>';
                return;
            }
            
            container.innerHTML = filteredResources.map(r => 
                `<div class="resource-card">
                    <h3><i class="fas fa-book"></i> ${r.titulo}</h3>
                    <p><i class="fas fa-tags"></i> Categoría: ${r.categoria}</p>
                    <p><i class="fas fa-file"></i> Tipo: ${r.tipo}</p>
                    <p><i class="fas fa-tags"></i> Etiquetas: ${r.etiquetas.join(', ')}</p>
                    <p><i class="fas fa-info-circle"></i> ${r.descripcion}</p>
                    <a href="${r.url}" target="_blank" class="btn primary" style="margin-top:12px;">
                        <i class="fas fa-external-link-alt"></i> Acceder al Recurso
                    </a>
                </div>`
            ).join('');
        }
        
        // Resource search
        $('resource-search').addEventListener('input', updateResourceCards);
        $('resource-category').addEventListener('change', updateResourceCards);
        
        // Add resource button
        $('addResourceBtn').addEventListener('click', () => {
            const titulo = prompt('Título del recurso:');
            if (!titulo) return;
            
            const categoria = prompt('Categoría (Protocolos, Guías, Videos, Imágenes, Artículos, Formularios):');
            if (!categoria) return;
            
            const tipo = prompt('Tipo (documento, video, imagen):');
            if (!tipo) return;
            
            const url = prompt('URL del recurse:');
            if (!url) return;
            
            const descripcion = prompt('Descripción del recurso:');
            if (!descripcion) return;
            
            const etiquetas = prompt('Etiquetas (separadas por comas):');
            
            const newResource = {
                id: RECURSOS.length > 0 ? Math.max(...RECURSOS.map(r => r.id)) + 1 : 1,
                titulo,
                categoria,
                tipo,
                url,
                etiquetas: etiquetas ? etiquetas.split(',').map(e => e.trim()) : [],
                descripcion
            };
            
            RECURSOS.push(newResource);
            if (setStoredData(RECURSOS_KEY, RECURSOS)) {
                showNotification(`Recurso "${titulo}" agregado con éxito`, 'success');
                updateResourceCards();
            } else {
                showNotification('Error al guardar el recurso', 'error');
            }
        });
        
        // Export resources
        $('exportResourcesBtn').addEventListener('click', () => {
            if (RECURSOS.length === 0) {
                showNotification('No hay recursos para exportar', 'error');
                return;
            }
            
            const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(RECURSOS, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "recursos_enfermeria_david.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showNotification('Recursos exportados', 'success');
        });
        
        // Wikipedia search
        $('wikiFetchBtn').addEventListener('click', async () => {
            const q = $('globalSearch').value.trim();
            if(!q) { 
                showNotification('Escriba término en la búsqueda (ej: neumonía)', 'error');
                return; 
            }
            $('wikiOutput').textContent = 'Buscando en Wikipedia...';
            try {
                const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`;
                const res = await fetch(url);
                if(!res.ok) { 
                    $('wikiOutput').textContent = 'No encontrado en Wikipedia.';
                    return; 
                }
                const data = await res.json();
                $('wikiOutput').innerHTML = `<strong>${data.title}</strong><div class="small"><i class="fas fa-info-circle"></i> ${data.extract}</div><div style="margin-top:10px"><a href="${data.content_urls?.desktop?.page||'#'}" target="_blank" class="btn small"><i class="fas fa-external-link-alt"></i> Leer en Wikipedia</a></div>`;
                diseasePanel.style.display = 'block';
            } catch(e) {
                $('wikiOutput').textContent = 'Error al buscar en Wikipedia.';
            }
        });
        
        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container') || createNotificationContainer();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                      type === 'error' ? '<i class="fas fa-exclamation-triangle"></i>' : 
                      type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' : 
                      '<i class="fas fa-info-circle"></i>'}
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-width: 350px;
            `;
            document.body.appendChild(container);
            return container;
        }
        
        // Quick action buttons
        $('quickRcpCard').addEventListener('click', () => {
            document.querySelector('[data-cat="rcp"]').click();
        });
        
        $('quickMedCard').addEventListener('click', () => {
            document.querySelector('[data-cat="medicamentos"]').click();
        });
        
        $('quickPaeCard').addEventListener('click', () => {
            document.querySelector('[data-cat="pae"]').click();
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + F for search focus
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                $('globalSearch').focus();
            }
            
            // Escape to clear search
            if (e.key === 'Escape') {
                $('globalSearch').value = '';
            }
        });
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Create notification container
            createNotificationContainer();
            
            // Set initial state - show patients by default
            showPacientes();
            
            // Show success notification for storage
            if (typeof(Storage) !== "undefined") {
                showNotification('Sistema de almacenamiento local habilitado', 'success');
            } else {
                showNotification('Su navegador no soporta almacenamiento local', 'error');
            }
        });
    </script>
    
    <!-- Notification container will be created dynamically -->
</body>
</html>
